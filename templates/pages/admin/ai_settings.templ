package admin

import (
	"fmt"
	"strconv"

	"github.com/jackc/pgx/v5/pgtype"

	"docko/components/button"
	"docko/components/input"
	"docko/components/label"
	"docko/internal/ai"
	"docko/internal/database/sqlc"
	"docko/internal/meta"
	"docko/templates/layouts"
)

templ AISettings(settings sqlc.AiSetting, providers []string, stats *ai.UsageStats, pendingCount int64) {
	@layouts.Admin(meta.New("AI Settings", "Configure AI integration")) {
		<div class="space-y-6">
			<div class="flex justify-between items-center">
				<h1 class="text-2xl font-bold text-foreground">AI Settings</h1>
				if pendingCount > 0 {
					@button.Button(button.Props{
						Href:  "/ai/review",
						Class: "bg-yellow-500 hover:bg-yellow-600",
					}) {
						<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
						</svg>
						Review Suggestions ({ strconv.FormatInt(pendingCount, 10) })
					}
				}
			</div>
			<!-- Provider Status -->
			<div class="bg-card rounded-lg shadow p-6">
				<h2 class="text-lg font-semibold mb-4 text-foreground">Provider Status</h2>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
					@providerCard("OpenAI", "openai", providers)
					@providerCard("Anthropic", "anthropic", providers)
					@providerCard("Ollama", "ollama", providers)
				</div>
				<p class="mt-4 text-sm text-muted-foreground">
					Configure providers via environment variables: OPENAI_API_KEY, ANTHROPIC_API_KEY, OLLAMA_HOST
				</p>
			</div>
			<!-- Settings Form -->
			<div class="bg-card rounded-lg shadow p-6">
				<h2 class="text-lg font-semibold mb-4 text-foreground">Configuration</h2>
				<form hx-post="/ai" hx-swap="none" class="space-y-6">
					<!-- Preferred Provider -->
					<div class="space-y-2">
						@label.Label(label.Props{For: "preferred_provider"}) {
							Preferred Provider
						}
						<select
							id="preferred_provider"
							name="preferred_provider"
							class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-xs transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
						>
							<option value="auto" selected?={ settings.PreferredProvider == nil }>Auto (use first available)</option>
							for _, p := range providers {
								<option value={ p } selected?={ settings.PreferredProvider != nil && *settings.PreferredProvider == p }>
									{ providerDisplayName(p) }
								</option>
							}
						</select>
						<p class="text-sm text-muted-foreground">
							Select which provider to use first. Falls back to others if unavailable.
						</p>
					</div>
					<!-- Max Pages -->
					<div class="space-y-2">
						@label.Label(label.Props{For: "max_pages"}) {
							Max Pages to Analyze
						}
						@input.Input(input.Props{
							ID:    "max_pages",
							Type:  input.TypeNumber,
							Name:  "max_pages",
							Value: strconv.Itoa(int(settings.MaxPages)),
							Class: "w-32",
							Attributes: templ.Attributes{
								"min": "1",
								"max": "50",
							},
						})
						<p class="text-sm text-muted-foreground">
							Only analyze the first N pages of each document. Lower values reduce costs.
						</p>
					</div>
					<!-- Auto-Apply Threshold -->
					<div class="space-y-2">
						@label.Label(label.Props{For: "auto_apply_threshold"}) {
							Auto-Apply Threshold
						}
						@input.Input(input.Props{
							ID:    "auto_apply_threshold",
							Type:  input.TypeNumber,
							Name:  "auto_apply_threshold",
							Value: formatThreshold(settings.AutoApplyThreshold),
							Class: "w-32",
							Attributes: templ.Attributes{
								"min":  "0",
								"max":  "1",
								"step": "0.05",
							},
						})
						<p class="text-sm text-muted-foreground">
							Suggestions with confidence at or above this threshold are applied automatically.
						</p>
					</div>
					<!-- Review Threshold -->
					<div class="space-y-2">
						@label.Label(label.Props{For: "review_threshold"}) {
							Review Threshold
						}
						@input.Input(input.Props{
							ID:    "review_threshold",
							Type:  input.TypeNumber,
							Name:  "review_threshold",
							Value: formatThreshold(settings.ReviewThreshold),
							Class: "w-32",
							Attributes: templ.Attributes{
								"min":  "0",
								"max":  "1",
								"step": "0.05",
							},
						})
						<p class="text-sm text-muted-foreground">
							Suggestions below this threshold are discarded. Between this and auto-apply go to review queue.
						</p>
					</div>
					<!-- Auto Process Toggle -->
					<div class="flex items-center space-x-2">
						<input
							type="checkbox"
							name="auto_process"
							id="auto_process"
							checked?={ settings.AutoProcess }
							class="h-4 w-4 rounded border-input text-primary focus:ring-primary"
						/>
						@label.Label(label.Props{For: "auto_process"}) {
							Auto-process new documents
						}
					</div>
					<p class="text-sm text-muted-foreground -mt-4 ml-6">
						When enabled, documents are automatically analyzed after text extraction.
					</p>
					<!-- Minimum Word Count -->
					<div class="space-y-2">
						@label.Label(label.Props{For: "min_word_count"}) {
							Minimum Word Count
						}
						@input.Input(input.Props{
							ID:    "min_word_count",
							Type:  input.TypeNumber,
							Name:  "min_word_count",
							Value: strconv.Itoa(int(settings.MinWordCount)),
							Class: "w-32",
							Attributes: templ.Attributes{
								"min": "0",
								"max": "10000",
							},
						})
						<p class="text-sm text-muted-foreground">
							Documents with fewer words are rejected during processing. Set to 0 to disable.
						</p>
					</div>
					<div class="pt-4">
						@button.Button(button.Props{
							Type: button.TypeSubmit,
						}) {
							Save Settings
						}
					</div>
				</form>
				@input.Script()
			</div>
			<!-- Usage Stats -->
			<div class="bg-card rounded-lg shadow p-6">
				<h2 class="text-lg font-semibold mb-4 text-foreground">Usage Statistics</h2>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
					<div>
						<p class="text-2xl font-bold text-foreground">
							{ strconv.FormatInt(stats.DocumentsProcessed, 10) }
						</p>
						<p class="text-sm text-muted-foreground">Documents Processed</p>
					</div>
					<div>
						<p class="text-2xl font-bold text-foreground">
							{ formatTokens(stats.TotalInputTokens) }
						</p>
						<p class="text-sm text-muted-foreground">Input Tokens</p>
					</div>
					<div>
						<p class="text-2xl font-bold text-foreground">
							{ formatTokens(stats.TotalOutputTokens) }
						</p>
						<p class="text-sm text-muted-foreground">Output Tokens</p>
					</div>
				</div>
				<p class="mt-4 text-sm text-muted-foreground">
					Estimated cost depends on provider pricing. Check provider dashboard for accurate billing.
				</p>
			</div>
		</div>
	}
}

templ providerCard(name, id string, available []string) {
	<div class={ "p-4 rounded-lg border", providerCardClass(id, available) }>
		<div class="flex items-center justify-between">
			<span class="font-medium text-foreground">{ name }</span>
			if isProviderAvailable(id, available) {
				<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
					Available
				</span>
			} else {
				<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-muted text-muted-foreground">
					Not Configured
				</span>
			}
		</div>
	</div>
}

func isProviderAvailable(id string, available []string) bool {
	for _, p := range available {
		if p == id {
			return true
		}
	}
	return false
}

func providerCardClass(id string, available []string) string {
	if isProviderAvailable(id, available) {
		return "border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20"
	}
	return "border-border"
}

func providerDisplayName(id string) string {
	switch id {
	case "openai":
		return "OpenAI"
	case "anthropic":
		return "Anthropic"
	case "ollama":
		return "Ollama"
	default:
		return id
	}
}

func formatThreshold(n pgtype.Numeric) string {
	f, _ := n.Float64Value()
	return fmt.Sprintf("%.2f", f.Float64)
}

func formatTokens(n int64) string {
	if n >= 1000000 {
		return fmt.Sprintf("%.1fM", float64(n)/1000000)
	}
	if n >= 1000 {
		return fmt.Sprintf("%.1fK", float64(n)/1000)
	}
	return strconv.FormatInt(n, 10)
}
