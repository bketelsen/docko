services:
  postgres:
    image: postgres:16-alpine
    container_name: docko-postgres
    environment:
      POSTGRES_USER: docko
      POSTGRES_PASSWORD: docko
      POSTGRES_DB: docko
    ports:
      - "5432:5432"
    volumes:
      - docko-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U docko -d docko"]
      interval: 5s
      timeout: 3s
      retries: 5

  ocrmypdf:
    image: jbarlow83/ocrmypdf:latest
    container_name: docko-ocrmypdf
    # Run as a persistent service that watches for input files
    # Uses inotifywait to watch /input directory and process PDFs
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        apt-get update && apt-get install -y inotify-tools &&
        mkdir -p /input /output &&
        echo 'OCRmyPDF service ready, watching /input...' &&
        while true; do
          inotifywait -q -e close_write /input/ 2>/dev/null
          for f in /input/*.pdf; do
            [ -f "$$f" ] || continue
            base=$$(basename "$$f" .pdf)
            /app/.venv/bin/ocrmypdf --skip-text --sidecar "/output/$$base.txt" -l eng "$$f" "/output/$$base.pdf" 2>&1 || true
            rm "$$f"
          done
        done
    volumes:
      # Bind mounts for app communication (storage/ocr-input and storage/ocr-output)
      - ./storage/ocr-input:/input
      - ./storage/ocr-output:/output
    restart: unless-stopped

volumes:
  docko-postgres-data:
