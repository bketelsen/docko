---
phase: 02-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - internal/handler/upload.go
  - internal/handler/handler.go
autonomous: true

must_haves:
  truths:
    - "PDF files can be uploaded via POST endpoint"
    - "Non-PDF files are rejected with clear error"
    - "Duplicate files are detected and existing document is returned"
  artifacts:
    - path: "internal/handler/upload.go"
      provides: "Upload handler with PDF validation and duplicate handling"
      exports: ["UploadSingle", "UploadMultiple"]
    - path: "go.mod"
      provides: "fsnotify and filetype dependencies"
      contains: "github.com/fsnotify/fsnotify"
  key_links:
    - from: "internal/handler/upload.go"
      to: "internal/document/document.go"
      via: "docSvc.Ingest() call"
      pattern: "docSvc\\.Ingest"
---

<objective>
Create web upload handler with PDF validation and duplicate detection response handling.

Purpose: Enable web-based document ingestion with proper error handling for non-PDFs and duplicates
Output: Working POST /upload endpoint that validates PDFs, detects duplicates, and returns appropriate responses
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-ingestion/02-CONTEXT.md
@.planning/phases/02-ingestion/02-RESEARCH.md
@internal/document/document.go
@internal/handler/handler.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add toast component</name>
  <files>go.mod, go.sum, components/toast.templ (via templui)</files>
  <action>
Install required dependencies:
```bash
go get github.com/fsnotify/fsnotify
go get github.com/h2non/filetype
templui add toast
```

After installation, run `make generate` to ensure templ files are compiled.

Note: fsnotify will be used in later plans (inbox watcher), but installing now ensures all deps are in place.
  </action>
  <verify>Check go.mod contains both dependencies: `grep -E "fsnotify|filetype" go.mod` shows both lines</verify>
  <done>go.mod has fsnotify and filetype dependencies, toast component exists in components/</done>
</task>

<task type="auto">
  <name>Task 2: Create upload handler with PDF validation</name>
  <files>internal/handler/upload.go</files>
  <action>
Create upload handler at `internal/handler/upload.go`:

1. Add document service to Handler struct in handler.go (needs modification)

2. Create upload.go with:
   - `UploadSingle(c echo.Context) error` - handles single file upload
   - `UploadMultiple(c echo.Context) error` - handles multiple files via multipart form

Implementation details:
- Use `c.FormFile("file")` for single, `c.MultipartForm()` for multiple
- Save uploaded file to temp location first
- Validate PDF using h2non/filetype magic bytes (first 262 bytes)
- If not PDF: return 400 with error message "Only PDF files are allowed"
- Call `h.docSvc.Ingest(ctx, tempPath, originalFilename)`
- Handle duplicate response (isDuplicate=true): return 200 with existing document info and `is_duplicate: true`
- Handle new document: return 201 with document info
- Clean up temp file after processing

Response format (JSON for API, HTMX partial for web):
```go
type UploadResult struct {
    Success     bool      `json:"success"`
    DocumentID  uuid.UUID `json:"document_id,omitempty"`
    Filename    string    `json:"filename"`
    IsDuplicate bool      `json:"is_duplicate"`
    Error       string    `json:"error,omitempty"`
}
```

For multiple uploads, return array of results.

Use `Accept` header to determine response format:
- `application/json`: Return JSON
- Otherwise: Return HTML partial (for HTMX)

Import filetype package: `github.com/h2non/filetype`
  </action>
  <verify>Check file compiles: `go build ./internal/handler/...` succeeds</verify>
  <done>upload.go exists with UploadSingle and UploadMultiple handlers, compiles successfully</done>
</task>

<task type="auto">
  <name>Task 3: Update Handler struct and register upload routes</name>
  <files>internal/handler/handler.go</files>
  <action>
Modify `internal/handler/handler.go`:

1. Add document service to Handler struct:
```go
type Handler struct {
    cfg    *config.Config
    db     *database.DB
    auth   *auth.Service
    docSvc *document.Service  // Add this
}
```

2. Update New() constructor to accept document service:
```go
func New(cfg *config.Config, db *database.DB, authService *auth.Service, docSvc *document.Service) *Handler
```

3. Add upload routes in RegisterRoutes():
```go
// Upload routes (protected)
e.GET("/upload", h.UploadPage, middleware.RequireAuth(h.auth))
e.POST("/upload", h.UploadMultiple, middleware.RequireAuth(h.auth))
e.POST("/api/upload", h.UploadSingle, middleware.RequireAuth(h.auth))
```

Note: UploadPage handler will be added in Plan 02 (UI plan). For now, add a stub that returns 501 Not Implemented, or skip the GET route until Plan 02.
  </action>
  <verify>Check file compiles: `go build ./internal/handler/...` succeeds</verify>
  <done>Handler struct has docSvc field, routes registered for upload endpoints</done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `grep "fsnotify\|filetype" go.mod` shows both dependencies
3. `ls components/toast.templ` exists
4. Handler compiles with new docSvc field
</verification>

<success_criteria>
- Upload handler exists with PDF validation via magic bytes
- Duplicate detection returns existing document with is_duplicate flag
- Non-PDF files rejected with 400 error
- Routes registered (GET /upload, POST /upload, POST /api/upload)
- All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-ingestion/02-01-SUMMARY.md`
</output>
