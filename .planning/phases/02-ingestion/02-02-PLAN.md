---
phase: 02-ingestion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/pages/admin/upload.templ
  - templates/partials/upload_result.templ
  - static/js/upload.js
autonomous: true

must_haves:
  truths:
    - "User sees full-page drop overlay when dragging files"
    - "User sees per-file progress bars during upload"
    - "User sees toast notification on upload completion"
  artifacts:
    - path: "templates/pages/admin/upload.templ"
      provides: "Upload page with drop zone"
      min_lines: 30
    - path: "static/js/upload.js"
      provides: "Drag-drop and progress tracking JavaScript"
      min_lines: 50
  key_links:
    - from: "static/js/upload.js"
      to: "/api/upload"
      via: "XMLHttpRequest POST"
      pattern: "xhr\\.open.*POST.*upload"
---

<objective>
Create upload UI with full-page drag-and-drop, per-file progress bars, and toast notifications.

Purpose: Provide intuitive drag-and-drop upload experience with visual feedback per CONTEXT.md decisions
Output: Upload page template, JavaScript for drag-drop with progress, result partial for HTMX
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-ingestion/02-CONTEXT.md
@.planning/phases/02-ingestion/02-RESEARCH.md
@templates/layouts/admin.templ
@templates/pages/admin/dashboard.templ
@components/toast.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload page template with drop zone</name>
  <files>templates/pages/admin/upload.templ</files>
  <action>
Create `templates/pages/admin/upload.templ`:

1. Use admin layout (follow pattern from dashboard.templ)

2. Page content:
   - Upload area with file input and "Select Files" button
   - Instructions text: "Drag PDF files anywhere on this page, or click to select"
   - Upload results container (empty, filled by HTMX responses)

3. Full-page drop overlay (hidden by default):
   - Fixed position covering entire viewport
   - Semi-transparent dark background (bg-black/50)
   - Centered text: "Drop PDF files to upload"
   - Border dashed styling to indicate drop target
   - CSS class: `hidden` by default, removed by JavaScript on drag

4. Toast container for notifications:
   - Fixed position top-right
   - ID: `toast-container` (for HTMX OOB swaps)

5. Include upload.js script at bottom:
   ```templ
   <script src="/static/js/upload.js"></script>
   ```

Use Tailwind classes consistent with existing admin dashboard styling.
  </action>
  <verify>Run `make generate` and check `templates/pages/admin/upload_templ.go` is created without errors</verify>
  <done>upload.templ exists, generates successfully, uses admin layout</done>
</task>

<task type="auto">
  <name>Task 2: Create upload result partial for HTMX responses</name>
  <files>templates/partials/upload_result.templ</files>
  <action>
Create `templates/partials/upload_result.templ`:

1. Create partials directory if not exists: `templates/partials/`

2. Define result types and template:
```templ
package partials

type UploadResultData struct {
    Filename    string
    Success     bool
    IsDuplicate bool
    DocumentID  string
    Error       string
}

templ UploadResult(data UploadResultData) {
    // Single file result card
}

templ UploadResults(results []UploadResultData) {
    for _, r := range results {
        @UploadResult(r)
    }
}

templ UploadToast(message string, isError bool) {
    // Toast notification for OOB swap
    // Use hx-swap-oob="beforeend:#toast-container"
}
```

3. Result card styling:
   - Success: Green border/icon, shows filename and "Uploaded successfully"
   - Duplicate: Yellow border/icon, shows "Already exists" with link to document
   - Error: Red border/icon, shows error message

4. Toast styling:
   - Success: Green background
   - Error: Red background
   - Auto-dismiss after 4 seconds using HTMX trigger:
     `hx-get="/_empty" hx-trigger="load delay:4s" hx-swap="outerHTML"`
  </action>
  <verify>Run `make generate` and check `templates/partials/upload_result_templ.go` is created</verify>
  <done>upload_result.templ exists with result and toast templates, generates successfully</done>
</task>

<task type="auto">
  <name>Task 3: Create JavaScript for drag-drop and progress tracking</name>
  <files>static/js/upload.js</files>
  <action>
Create `static/js/upload.js`:

1. Full-page drag-and-drop handling (per RESEARCH.md Pattern 3):
   - Use dragCounter pattern to handle child element events
   - On dragenter: increment counter, show overlay
   - On dragleave: decrement counter, hide if counter=0
   - On dragover: preventDefault, set dropEffect='copy'
   - On drop: preventDefault, hide overlay, filter for PDFs, start upload

2. File filtering:
   - Accept only files with type 'application/pdf'
   - Show warning toast for rejected files

3. Parallel upload with progress (per RESEARCH.md Pattern 4):
   - Use XMLHttpRequest (NOT fetch - no upload progress in fetch)
   - Create progress UI for each file before starting
   - POST to /api/upload with FormData containing single file
   - Track xhr.upload.onprogress for each file
   - Update individual progress bars

4. Progress UI:
   - For each file, add progress entry to #upload-progress container
   - Show filename + progress bar
   - Update bar width based on loaded/total

5. Result handling:
   - On xhr.onload, parse JSON response
   - Update progress entry with success/error styling
   - Show duplicate indicator if is_duplicate=true
   - After all complete, show summary toast

6. Manual file select:
   - Handle click on upload area to trigger file input
   - Handle file input change to start upload

Key implementation notes from RESEARCH.md:
- XMLHttpRequest required for upload.onprogress (Fetch API doesn't support it)
- Drag counter pattern prevents overlay flicker from child elements
- Filter by file.type === 'application/pdf' on drop
  </action>
  <verify>Check file exists and has no syntax errors: `node --check static/js/upload.js`</verify>
  <done>upload.js handles drag-drop, parallel uploads, per-file progress, and toasts</done>
</task>

</tasks>

<verification>
1. `make generate` succeeds (templ files compile)
2. `ls templates/pages/admin/upload_templ.go` exists
3. `ls templates/partials/upload_result_templ.go` exists
4. `ls static/js/upload.js` exists
5. JavaScript has no syntax errors: `node --check static/js/upload.js`
</verification>

<success_criteria>
- Upload page renders with drop zone and file input
- Full-page overlay appears when dragging files
- JavaScript handles parallel uploads with individual progress bars
- Toast notifications appear for results
- Duplicate files shown differently from new uploads
- All templates compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-ingestion/02-02-SUMMARY.md`
</output>
