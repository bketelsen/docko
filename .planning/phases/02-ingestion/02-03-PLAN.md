---
phase: 02-ingestion
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/004_inboxes.sql
  - sqlc/queries/inboxes.sql
  - internal/config/config.go
autonomous: true

must_haves:
  truths:
    - "Inbox configuration persists in database"
    - "Default inbox path can be set via environment variable"
    - "Multiple inbox directories are supported"
  artifacts:
    - path: "internal/database/migrations/004_inboxes.sql"
      provides: "Inboxes table schema"
      contains: "CREATE TABLE inboxes"
    - path: "sqlc/queries/inboxes.sql"
      provides: "CRUD queries for inbox management"
      exports: ["CreateInbox", "GetInbox", "ListInboxes", "UpdateInbox", "DeleteInbox"]
    - path: "internal/config/config.go"
      provides: "InboxConfig with default path from env"
      contains: "INBOX_PATH"
  key_links:
    - from: "internal/config/config.go"
      to: "environment"
      via: "INBOX_PATH env var"
      pattern: "INBOX_PATH"
---

<objective>
Create inbox database schema and configuration for managing multiple inbox directories.

Purpose: Enable persistent inbox configuration with env var defaults and UI override capability
Output: Database migration, sqlc queries, and config extension for inbox management
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-ingestion/02-CONTEXT.md
@.planning/phases/02-ingestion/02-RESEARCH.md
@internal/database/migrations/003_documents.sql
@sqlc/queries/documents.sql
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inboxes migration</name>
  <files>internal/database/migrations/004_inboxes.sql</files>
  <action>
Create `internal/database/migrations/004_inboxes.sql`:

```sql
-- +goose Up

-- Duplicate handling strategies for inbox sources
CREATE TYPE duplicate_action AS ENUM ('delete', 'rename', 'skip');

-- Inboxes table: configured directories to watch for new documents
CREATE TABLE inboxes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    path VARCHAR(1024) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    enabled BOOLEAN NOT NULL DEFAULT true,
    error_path VARCHAR(1024),
    duplicate_action duplicate_action NOT NULL DEFAULT 'delete',
    last_scan_at TIMESTAMPTZ,
    last_error TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Inbox events table: log of files processed from each inbox
CREATE TABLE inbox_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inbox_id UUID NOT NULL REFERENCES inboxes(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    action VARCHAR(50) NOT NULL,  -- imported, duplicate, error, moved_to_error
    document_id UUID REFERENCES documents(id) ON DELETE SET NULL,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Index for fetching recent inbox activity
CREATE INDEX idx_inbox_events_inbox_created ON inbox_events (inbox_id, created_at DESC);

-- +goose Down
DROP TABLE IF EXISTS inbox_events;
DROP TABLE IF EXISTS inboxes;
DROP TYPE IF EXISTS duplicate_action;
```

Key design decisions per CONTEXT.md:
- Multiple inbox directories supported (multiple rows)
- enabled boolean for toggle per inbox
- error_path for moving failed files (defaults to {inbox_path}/errors/)
- duplicate_action per inbox (web upload always blocks, inbox can delete/rename/skip)
- last_scan_at and last_error for status display
  </action>
  <verify>Check migration syntax: `goose -dir internal/database/migrations postgres "$DATABASE_URL" status` shows migration</verify>
  <done>004_inboxes.sql migration file exists with inboxes and inbox_events tables</done>
</task>

<task type="auto">
  <name>Task 2: Create inbox sqlc queries</name>
  <files>sqlc/queries/inboxes.sql</files>
  <action>
Create `sqlc/queries/inboxes.sql`:

```sql
-- name: CreateInbox :one
INSERT INTO inboxes (path, name, error_path, duplicate_action, enabled)
VALUES ($1, $2, $3, $4, $5)
RETURNING *;

-- name: GetInbox :one
SELECT * FROM inboxes WHERE id = $1;

-- name: GetInboxByPath :one
SELECT * FROM inboxes WHERE path = $1;

-- name: ListInboxes :many
SELECT * FROM inboxes ORDER BY created_at ASC;

-- name: ListEnabledInboxes :many
SELECT * FROM inboxes WHERE enabled = true ORDER BY created_at ASC;

-- name: UpdateInbox :one
UPDATE inboxes
SET name = $2, path = $3, error_path = $4, duplicate_action = $5, enabled = $6, updated_at = NOW()
WHERE id = $1
RETURNING *;

-- name: UpdateInboxStatus :exec
UPDATE inboxes
SET last_scan_at = $2, last_error = $3, updated_at = NOW()
WHERE id = $1;

-- name: DeleteInbox :exec
DELETE FROM inboxes WHERE id = $1;

-- name: CreateInboxEvent :one
INSERT INTO inbox_events (inbox_id, filename, action, document_id, error_message)
VALUES ($1, $2, $3, $4, $5)
RETURNING *;

-- name: ListInboxEvents :many
SELECT * FROM inbox_events
WHERE inbox_id = $1
ORDER BY created_at DESC
LIMIT $2;

-- name: ListRecentInboxEvents :many
SELECT ie.*, i.name as inbox_name
FROM inbox_events ie
JOIN inboxes i ON ie.inbox_id = i.id
ORDER BY ie.created_at DESC
LIMIT $1;
```

Run `make generate` after creating to regenerate sqlc types.
  </action>
  <verify>Run `make generate` and check `internal/database/sqlc/inboxes.sql.go` is created</verify>
  <done>inboxes.sql queries exist, sqlc generates successfully</done>
</task>

<task type="auto">
  <name>Task 3: Add inbox configuration to config.go</name>
  <files>internal/config/config.go</files>
  <action>
Modify `internal/config/config.go`:

1. Add InboxConfig struct:
```go
type InboxConfig struct {
    DefaultPath    string // Default inbox path from env
    ErrorSubdir    string // Subdirectory for error files (default: "errors")
    MaxFileSizeMB  int    // Maximum file size in MB (default: 100)
    ScanIntervalMs int    // Interval between directory scans in ms (default: 1000)
}
```

2. Add Inbox field to main Config struct:
```go
type Config struct {
    DatabaseURL string
    Port        string
    Env         string
    Site        SiteConfig
    Auth        AuthConfig
    Storage     StorageConfig
    Inbox       InboxConfig  // Add this
}
```

3. Load inbox config in Load():
```go
Inbox: InboxConfig{
    DefaultPath:    os.Getenv("INBOX_PATH"),  // Empty string if not set
    ErrorSubdir:    getEnvOrDefault("INBOX_ERROR_SUBDIR", "errors"),
    MaxFileSizeMB:  getEnvIntOrDefault("INBOX_MAX_FILE_SIZE_MB", 100),
    ScanIntervalMs: getEnvIntOrDefault("INBOX_SCAN_INTERVAL_MS", 1000),
},
```

4. Add info log if INBOX_PATH is set:
```go
if cfg.Inbox.DefaultPath != "" {
    slog.Info("default inbox path configured", "path", cfg.Inbox.DefaultPath)
}
```

Environment variables:
- INBOX_PATH: Optional default inbox path (creates inbox on first run if set)
- INBOX_ERROR_SUBDIR: Subdirectory name for error files (default: "errors")
- INBOX_MAX_FILE_SIZE_MB: Max file size for inbox processing (default: 100)
- INBOX_SCAN_INTERVAL_MS: Directory scan interval (default: 1000)
  </action>
  <verify>Check file compiles: `go build ./internal/config/...` succeeds</verify>
  <done>config.go has InboxConfig with INBOX_PATH and related env vars</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls internal/database/migrations/004_inboxes.sql`
2. Queries file exists: `ls sqlc/queries/inboxes.sql`
3. `make generate` succeeds (sqlc regenerates)
4. `go build ./...` succeeds
5. Check generated types: `grep "Inbox" internal/database/sqlc/models.go`
</verification>

<success_criteria>
- Inboxes table supports multiple directories with individual settings
- inbox_events table tracks all files processed
- duplicate_action enum supports delete/rename/skip per inbox
- Config loads INBOX_PATH from environment
- All code compiles and migrations are valid
</success_criteria>

<output>
After completion, create `.planning/phases/02-ingestion/02-03-SUMMARY.md`
</output>
