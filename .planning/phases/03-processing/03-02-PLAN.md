---
phase: 03-processing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/processing/text.go
  - internal/processing/text_test.go
autonomous: true

must_haves:
  truths:
    - "Text can be extracted from PDFs with embedded text"
    - "Scanned PDFs are processed with OCR"
    - "OCR only runs when embedded text is insufficient"
  artifacts:
    - path: "internal/processing/text.go"
      provides: "Text extraction with embedded + OCR fallback"
      exports: ["TextExtractor", "Extract"]
    - path: "internal/processing/text_test.go"
      provides: "Tests for text extraction"
  key_links:
    - from: "internal/processing/text.go"
      to: "ledongthuc/pdf"
      via: "import and pdf.Open"
      pattern: "pdf\\.Open"
    - from: "internal/processing/text.go"
      to: "docker run jbarlow83/ocrmypdf"
      via: "exec.CommandContext"
      pattern: "ocrmypdf"
---

<objective>
Implement text extraction service that extracts embedded text from PDFs using ledongthuc/pdf library, falling back to OCRmyPDF Docker container for scanned documents.

Purpose: Enable full-text search (Phase 6) by extracting searchable text from all PDF types - both native PDFs with embedded text and scanned image PDFs requiring OCR.
Output: Text extraction service with hybrid approach (embedded first, OCR fallback)
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-processing/03-RESEARCH.md
@internal/document/document.go
@internal/storage/storage.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement embedded text extraction</name>
  <files>
    internal/processing/text.go
  </files>
  <action>
Create internal/processing/text.go with TextExtractor:

```go
package processing

// TextExtractor extracts text from PDF files
type TextExtractor struct {
    minTextLength int // Minimum chars to consider "has text" (default: 100)
}

// NewTextExtractor creates a TextExtractor
func NewTextExtractor() *TextExtractor

// Extract extracts text from a PDF file
// Returns: text content, method used ("embedded" or "ocr"), error
func (e *TextExtractor) Extract(ctx context.Context, pdfPath string) (string, string, error)

// extractEmbedded attempts to extract embedded text using ledongthuc/pdf
// Returns: text, hasText (len > minTextLength), error
func (e *TextExtractor) extractEmbedded(pdfPath string) (string, bool, error)
```

Implementation details:
1. Use github.com/ledongthuc/pdf for embedded text extraction:
   ```go
   f, r, err := pdf.Open(pdfPath)
   defer f.Close()
   reader, err := r.GetPlainText()
   buf.ReadFrom(reader)
   ```

2. In Extract():
   - Try extractEmbedded first
   - If hasText (len >= minTextLength), return embedded text
   - Otherwise fall back to OCR (implemented in Task 2)

3. Add go get github.com/ledongthuc/pdf

4. Log extraction method and text length using slog
  </action>
  <verify>
Check ./tmp/air-combined.log for compilation errors.
Run: go build ./internal/processing/...
  </verify>
  <done>
TextExtractor can extract embedded text from PDFs. Returns text content and extraction method.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement OCR fallback with OCRmyPDF</name>
  <files>
    internal/processing/text.go
    internal/processing/text_test.go
  </files>
  <action>
Add OCR fallback to text.go:

```go
// ocrWithSidecar runs OCRmyPDF Docker container and extracts text via sidecar
func (e *TextExtractor) ocrWithSidecar(ctx context.Context, pdfPath string) (string, error)
```

Implementation per RESEARCH.md:
1. Create temp directory for output
2. Run OCRmyPDF via exec.CommandContext:
   ```go
   cmd := exec.CommandContext(ctx, "docker", "run",
       "--rm",
       "--user", fmt.Sprintf("%d:%d", os.Getuid(), os.Getgid()),
       "-v", fmt.Sprintf("%s:/input:ro", filepath.Dir(pdfPath)),
       "-v", fmt.Sprintf("%s:/output", tmpDir),
       "jbarlow83/ocrmypdf-alpine",
       "--skip-text",           // Don't OCR pages that already have text
       "--sidecar", "/output/text.txt",
       "-l", "eng",             // English only per CONTEXT.md
       fmt.Sprintf("/input/%s", filepath.Base(pdfPath)),
       "/output/output.pdf",
   )
   ```
3. Read sidecar text file
4. Clean up temp directory
5. Handle timeouts (5 minute context timeout per RESEARCH.md pitfalls)

Update Extract() to call ocrWithSidecar when embedded text insufficient.

Create text_test.go with tests:
1. Test extractEmbedded with mock/sample PDF (or skip if no test PDF)
2. Test that Extract returns "embedded" method when text sufficient
3. Test OCR command construction (can mock exec)
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Run: make test to verify tests pass.
If docker available: manually test with a sample PDF.
  </verify>
  <done>
Text extraction handles both embedded text and OCR fallback. OCR runs via Docker with proper volume mounts, user permissions, and timeout handling. Tests verify extraction logic.
  </done>
</task>

</tasks>

<verification>
- [ ] internal/processing/text.go compiles without errors
- [ ] TextExtractor.Extract() returns text and method
- [ ] Embedded extraction uses ledongthuc/pdf
- [ ] OCR fallback runs OCRmyPDF Docker container
- [ ] Tests exist and pass
- [ ] Proper error handling and logging
</verification>

<success_criteria>
Text extraction service complete. Can extract text from PDFs with embedded text quickly, falls back to OCR for scanned documents. Ready to be used by processing job handler.
</success_criteria>

<output>
After completion, create `.planning/phases/03-processing/03-02-SUMMARY.md`
</output>
