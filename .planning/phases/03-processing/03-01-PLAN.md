---
phase: 03-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/005_processing.sql
  - sqlc/queries/documents.sql
  - docker-compose.yml
  - static/images/placeholder.webp
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "Document table has processing_status column"
    - "Document table has text_content column for extracted text"
    - "Docker compose includes tools for PDF processing"
    - "Placeholder thumbnail exists for failed processing"
  artifacts:
    - path: "internal/database/migrations/005_processing.sql"
      provides: "Processing status and text_content columns"
      contains: "processing_status"
    - path: "docker-compose.yml"
      provides: "PDF processing dependencies"
      contains: "poppler-utils"
    - path: "static/images/placeholder.webp"
      provides: "Fallback thumbnail for failed processing"
  key_links:
    - from: "internal/database/sqlc/models.go"
      to: "005_processing.sql"
      via: "sqlc generate"
      pattern: "ProcessingStatus"
---

<objective>
Add database schema for processing status and text storage, configure Docker environment with PDF processing tools (poppler-utils, cwebp), and create placeholder thumbnail.

Purpose: Foundation for document processing - schema stores extracted text and processing state, Docker provides the tools, placeholder handles failures gracefully.
Output: Migration file, updated docker-compose, placeholder image, Dockerfile with processing tools
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-processing/03-RESEARCH.md
@internal/database/migrations/003_documents.sql
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add processing schema migration</name>
  <files>
    internal/database/migrations/005_processing.sql
    sqlc/queries/documents.sql
  </files>
  <action>
Create migration 005_processing.sql with:

1. Add processing_status enum type:
   - 'pending' (default for new documents)
   - 'processing'
   - 'completed'
   - 'failed'

2. Add columns to documents table:
   - processing_status processing_status NOT NULL DEFAULT 'pending'
   - text_content TEXT (nullable, stores extracted text)
   - thumbnail_generated BOOLEAN NOT NULL DEFAULT false
   - processing_error TEXT (nullable, stores last error message)
   - processed_at TIMESTAMPTZ (nullable, when processing completed)

3. Add index on processing_status for queue queries

4. Add sqlc queries to documents.sql:
   - UpdateDocumentProcessing(id, text_content, thumbnail_generated, processing_status, processing_error, processed_at)
   - GetPendingProcessingDocuments(limit) - for any manual reprocessing
   - SetDocumentProcessingStatus(id, status) - quick status update

Run: make generate to regenerate sqlc
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Run: psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name='documents'" to verify columns exist after migration runs.
  </verify>
  <done>
Migration creates processing_status enum and adds processing-related columns to documents table. sqlc generates Go types with ProcessingStatus field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Docker for PDF processing</name>
  <files>
    docker-compose.yml
    Dockerfile
    static/images/placeholder.webp
  </files>
  <action>
1. Update Dockerfile (or create if not exists) to include PDF processing tools:
   - poppler-utils (provides pdftoppm for PDF to PNG)
   - libwebp-tools (provides cwebp for PNG to WebP)
   - These are needed for thumbnail generation

   Example Alpine packages: poppler-utils, libwebp-tools

2. docker-compose.yml is already set up for postgres. No additional services needed since:
   - OCRmyPDF will be run as ephemeral container via exec.Command (per RESEARCH.md)
   - poppler-utils and cwebp run locally in the app container

3. Create placeholder thumbnail for failed processing:
   - Create static/images/placeholder.webp
   - Simple gray image with document icon or "Processing Failed" indicator
   - 300px width (matches thumbnail spec)
   - Use cwebp or download a minimal placeholder

   Can create with: convert -size 300x400 xc:gray -gravity center -fill white -pointsize 24 -annotate 0 "No Preview" png:- | cwebp -q 80 - -o static/images/placeholder.webp

   Or download a pre-made placeholder if imagemagick not available.
  </action>
  <verify>
Run: docker compose build (if Dockerfile modified)
Verify placeholder exists: ls -la static/images/placeholder.webp
Test tools available: which pdftoppm && which cwebp (in dev environment or container)
  </verify>
  <done>
Dockerfile includes poppler-utils and libwebp-tools. Placeholder thumbnail exists at static/images/placeholder.webp (300px width, WebP format).
  </done>
</task>

</tasks>

<verification>
- [ ] Migration 005_processing.sql exists and is valid SQL
- [ ] Running `make dev` applies migration without errors
- [ ] Document model in sqlc has ProcessingStatus, TextContent fields
- [ ] Placeholder image exists and is valid WebP
- [ ] PDF tools available in development environment
</verification>

<success_criteria>
Database schema ready for processing (status + text storage). Docker environment has PDF processing tools. Placeholder thumbnail exists for failure cases. All foundation in place for processing implementation.
</success_criteria>

<output>
After completion, create `.planning/phases/03-processing/03-01-SUMMARY.md`
</output>
