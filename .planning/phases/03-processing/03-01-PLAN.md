---
phase: 03-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/005_processing.sql
  - sqlc/queries/documents.sql
  - docker-compose.yml
  - static/images/placeholder.webp
  - Dockerfile
autonomous: true

must_haves:
  truths:
    - "User sees 'processing' status on newly uploaded documents"
    - "User sees extracted text after processing completes"
    - "Failed documents show placeholder preview in UI"
    - "OCR service starts alongside postgres with docker compose up"
  artifacts:
    - path: "internal/database/migrations/005_processing.sql"
      provides: "Processing status and text_content columns"
      contains: "processing_status"
    - path: "docker-compose.yml"
      provides: "OCRmyPDF service for text extraction"
      contains: "ocrmypdf"
    - path: "static/images/placeholder.webp"
      provides: "Fallback thumbnail for failed processing"
  key_links:
    - from: "internal/database/sqlc/models.go"
      to: "005_processing.sql"
      via: "sqlc generate"
      pattern: "ProcessingStatus"
    - from: "internal/processing/text.go"
      to: "docker-compose.yml ocrmypdf service"
      via: "shared volume mount"
      pattern: "ocr-input.*ocr-output"
---

<objective>
Add database schema for processing status and text storage, configure Docker environment with OCRmyPDF as a persistent service (per user decision), and create placeholder thumbnail.

Purpose: Foundation for document processing - schema stores extracted text and processing state, OCRmyPDF service runs alongside postgres for OCR jobs, placeholder handles failures gracefully.
Output: Migration file, updated docker-compose with ocrmypdf service, placeholder image, Dockerfile with thumbnail tools
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-processing/03-RESEARCH.md
@.planning/phases/03-processing/03-CONTEXT.md
@internal/database/migrations/003_documents.sql
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add processing schema migration</name>
  <files>
    internal/database/migrations/005_processing.sql
    sqlc/queries/documents.sql
  </files>
  <action>
Create migration 005_processing.sql with:

1. Add processing_status enum type:
   - 'pending' (default for new documents)
   - 'processing'
   - 'completed'
   - 'failed'

2. Add columns to documents table:
   - processing_status processing_status NOT NULL DEFAULT 'pending'
   - text_content TEXT (nullable, stores extracted text)
   - thumbnail_generated BOOLEAN NOT NULL DEFAULT false
   - processing_error TEXT (nullable, stores last error message)
   - processed_at TIMESTAMPTZ (nullable, when processing completed)

3. Add index on processing_status for queue queries

4. Add sqlc queries to documents.sql:
   - UpdateDocumentProcessing(id, text_content, thumbnail_generated, processing_status, processing_error, processed_at)
   - GetPendingProcessingDocuments(limit) - for any manual reprocessing
   - SetDocumentProcessingStatus(id, status) - quick status update

Run: make generate to regenerate sqlc
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Run: psql $DATABASE_URL -c "SELECT column_name FROM information_schema.columns WHERE table_name='documents'" to verify columns exist after migration runs.
  </verify>
  <done>
Migration creates processing_status enum and adds processing-related columns to documents table. sqlc generates Go types with ProcessingStatus field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OCRmyPDF Docker service and thumbnail tools</name>
  <files>
    docker-compose.yml
    Dockerfile
    static/images/placeholder.webp
  </files>
  <action>
1. Add OCRmyPDF as a PERSISTENT SERVICE in docker-compose.yml (per CONTEXT.md decision: "Use Tesseract via Docker service - similar to existing postgres container"):

```yaml
services:
  postgres:
    # ... existing postgres config ...

  ocrmypdf:
    image: jbarlow83/ocrmypdf:latest
    container_name: docko-ocrmypdf
    # Run as a persistent service that watches for input files
    # Uses inotifywait to watch /input directory and process PDFs
    command: >
      sh -c "
        apk add --no-cache inotify-tools &&
        mkdir -p /input /output &&
        echo 'OCRmyPDF service ready, watching /input...' &&
        while true; do
          inotifywait -q -e close_write /input/ 2>/dev/null &&
          for f in /input/*.pdf; do
            [ -f \"$$f\" ] || continue
            base=$$(basename \"$$f\" .pdf)
            ocrmypdf --skip-text --sidecar \"/output/$$base.txt\" -l eng \"$$f\" \"/output/$$base.pdf\" 2>&1
            rm \"$$f\"
          done
        done
      "
    volumes:
      - ocr-input:/input
      - ocr-output:/output
    restart: unless-stopped

volumes:
  docko-postgres-data:
  ocr-input:
  ocr-output:
```

IMPORTANT: This approach uses shared volumes instead of ephemeral `docker run` containers.
The app will:
- Copy PDF to ocr-input volume
- Wait for output in ocr-output volume
- Read the sidecar .txt file for extracted text

2. Update Dockerfile (or create if not exists) to include THUMBNAIL tools only:
   - poppler-utils (provides pdftoppm for PDF to PNG)
   - libwebp-tools (provides cwebp for PNG to WebP)

   OCR is handled by the ocrmypdf service, NOT the app container.

   Example Alpine packages: poppler-utils, libwebp-tools

3. Create placeholder thumbnail for failed processing:
   - Create static/images/placeholder.webp
   - Simple gray image with "No Preview" text
   - 300px width (matches thumbnail spec)

   Can create with: convert -size 300x400 xc:gray -gravity center -fill white -pointsize 24 -annotate 0 "No Preview" png:- | cwebp -q 80 - -o static/images/placeholder.webp

   Or download a minimal placeholder if imagemagick not available.
  </action>
  <verify>
Run: docker compose up -d
Check: docker compose ps (should show postgres AND ocrmypdf running)
Verify placeholder exists: ls -la static/images/placeholder.webp
Test thumbnail tools available: which pdftoppm && which cwebp (in dev environment)
  </verify>
  <done>
docker-compose.yml includes ocrmypdf service as a persistent container (like postgres). App uses shared volumes to communicate with OCR service. Dockerfile includes poppler-utils and libwebp-tools for thumbnails. Placeholder thumbnail exists.
  </done>
</task>

</tasks>

<verification>
- [ ] Migration 005_processing.sql exists and is valid SQL
- [ ] Running `make dev` applies migration without errors
- [ ] Document model in sqlc has ProcessingStatus, TextContent fields
- [ ] docker compose up -d starts BOTH postgres AND ocrmypdf services
- [ ] ocrmypdf service logs show "watching /input..."
- [ ] Placeholder image exists and is valid WebP
- [ ] Thumbnail tools (pdftoppm, cwebp) available in dev environment
</verification>

<success_criteria>
Database schema ready for processing (status + text storage). OCRmyPDF runs as a persistent Docker service alongside postgres (user's stated preference). Shared volumes enable communication between app and OCR service. Placeholder thumbnail exists for failure cases.
</success_criteria>

<output>
After completion, create `.planning/phases/03-processing/03-01-SUMMARY.md`
</output>
