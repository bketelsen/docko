---
phase: 03-processing
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - internal/handler/status.go
  - internal/processing/status.go
  - templates/partials/document_status.templ
  - templates/pages/documents.templ
  - assets/js/sse.js
autonomous: false

must_haves:
  truths:
    - "User sees processing status per document (Processing/Complete/Failed)"
    - "Status updates without page refresh"
    - "Failed documents show error message"
    - "Retry button appears for failed documents"
  artifacts:
    - path: "internal/handler/status.go"
      provides: "SSE endpoint for processing status"
      exports: ["ProcessingStatus"]
    - path: "internal/processing/status.go"
      provides: "Status subscription and broadcast"
      exports: ["StatusBroadcaster", "Subscribe", "Broadcast"]
    - path: "templates/partials/document_status.templ"
      provides: "Status badge component"
  key_links:
    - from: "templates/pages/documents.templ"
      to: "/api/processing/status"
      via: "hx-ext=sse sse-connect"
      pattern: "sse-connect"
    - from: "internal/processing/processor.go"
      to: "internal/processing/status.go"
      via: "Broadcast status updates"
      pattern: "broadcaster\\.Broadcast"
---

<objective>
Implement real-time processing status updates using Server-Sent Events (SSE). Show Processing/Complete/Failed status per document with live updates. Add retry button for failed documents.

Purpose: Per CONTEXT.md requirement - users need to see processing status without refreshing the page. Provides feedback for bulk uploads and long-running OCR.
Output: SSE endpoint, status broadcaster, status UI components with live updates
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-processing/03-RESEARCH.md
@.planning/phases/03-processing/03-CONTEXT.md
@internal/processing/processor.go
@templates/pages/admin_dashboard.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement status broadcaster and SSE endpoint</name>
  <files>
    internal/processing/status.go
    internal/handler/status.go
  </files>
  <action>
1. Create internal/processing/status.go with StatusBroadcaster:

```go
package processing

// StatusUpdate represents a processing status change
type StatusUpdate struct {
    DocumentID uuid.UUID `json:"document_id"`
    Status     string    `json:"status"`      // pending, processing, completed, failed
    Error      string    `json:"error,omitempty"`
}

// StatusBroadcaster manages SSE subscriptions for status updates
type StatusBroadcaster struct {
    subscribers map[chan StatusUpdate]struct{}
    mu          sync.RWMutex
}

// NewStatusBroadcaster creates a StatusBroadcaster
func NewStatusBroadcaster() *StatusBroadcaster

// Subscribe returns a channel that receives status updates
func (b *StatusBroadcaster) Subscribe(ctx context.Context) <-chan StatusUpdate

// Unsubscribe removes a subscription
func (b *StatusBroadcaster) Unsubscribe(ch <-chan StatusUpdate)

// Broadcast sends a status update to all subscribers
func (b *StatusBroadcaster) Broadcast(update StatusUpdate)
```

Implementation:
- Subscribe creates channel, adds to map, returns channel
- Start goroutine to remove channel when context cancelled
- Broadcast iterates subscribers, sends with select/default (non-blocking)
- Limit max subscribers to prevent resource exhaustion (e.g., 100)

2. Create internal/handler/status.go with SSE endpoint:

```go
// ProcessingStatus handles SSE connections for processing status
func (h *Handler) ProcessingStatus(c echo.Context) error
```

Per RESEARCH.md SSE pattern:
- Set headers: Content-Type: text/event-stream, Cache-Control: no-cache
- Subscribe to broadcaster
- defer Unsubscribe
- Loop: select on ctx.Done() or updates channel
- Format: event: status\ndata: {json}\n\n
- Flush after each event
- Send heartbeat every 30s to keep connection alive

3. Add route in handler setup: GET /api/processing/status

4. Update Processor to broadcast status changes:
- When processing starts: Broadcast(processing)
- When completed: Broadcast(completed)
- When failed: Broadcast(failed, error)
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Test SSE endpoint: curl -N http://localhost:3000/api/processing/status
Should see event stream output.
  </verify>
  <done>
StatusBroadcaster manages SSE subscriptions. SSE endpoint streams status updates. Processor broadcasts status changes during processing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create status UI components</name>
  <files>
    templates/partials/document_status.templ
    templates/pages/documents.templ
    internal/handler/documents.go
  </files>
  <action>
1. Create templates/partials/document_status.templ:

```templ
// DocumentStatus renders status badge for a document
templ DocumentStatus(docID string, status string, errorMsg string) {
    <div id={ "status-" + docID } class="inline-flex items-center">
        if status == "pending" {
            <span class="px-2 py-1 text-xs rounded bg-gray-200 text-gray-700">Pending</span>
        } else if status == "processing" {
            <span class="px-2 py-1 text-xs rounded bg-blue-200 text-blue-700 animate-pulse">Processing...</span>
        } else if status == "completed" {
            <span class="px-2 py-1 text-xs rounded bg-green-200 text-green-700">Complete</span>
        } else if status == "failed" {
            <span class="px-2 py-1 text-xs rounded bg-red-200 text-red-700">Failed</span>
            if errorMsg != "" {
                <span class="ml-1 text-xs text-red-600" title={ errorMsg }>(?)</span>
            }
            <button
                hx-post={ "/api/documents/" + docID + "/retry" }
                hx-swap="outerHTML"
                hx-target={ "#status-" + docID }
                class="ml-2 text-xs text-blue-600 hover:underline"
            >Retry</button>
        }
    </div>
}
```

2. Create or update templates/pages/documents.templ:
- Document list page showing all documents
- Each document row shows: filename, size, date, status badge
- Connect to SSE for live updates:
```templ
<div hx-ext="sse" sse-connect="/api/processing/status">
    for _, doc := range documents {
        <div sse-swap={ "doc-" + doc.ID.String() } hx-swap="innerHTML">
            @DocumentStatus(doc.ID.String(), string(doc.ProcessingStatus), doc.ProcessingError)
        </div>
    }
</div>
```

3. Update SSE handler to send events with doc-specific event names:
```go
fmt.Fprintf(w, "event: doc-%s\ndata: %s\n\n", update.DocumentID, htmlPartial)
```

4. Create handler for retry: POST /api/documents/:id/retry
- Re-enqueue processing job
- Return updated status partial

5. Add HTMX SSE extension if not already included:
- Add sse extension to assets/js or CDN link in base layout
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Run: make dev
Navigate to documents page and verify status badges appear.
Upload a document and watch status update from Pending -> Processing -> Complete.
  </verify>
  <done>
Status UI shows Processing/Complete/Failed per document. Live updates via SSE. Retry button for failed documents. HTMX SSE integration working.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete processing pipeline with real-time status updates</what-built>
  <how-to-verify>
1. Start the app: make dev
2. Navigate to http://localhost:3000/admin/documents (or document list page)
3. Upload a PDF via web UI
4. Watch the status badge update:
   - Should show "Processing..." (with animation)
   - After processing completes: "Complete" (green badge)
5. Test failure case (if possible):
   - Upload a password-protected PDF or corrupt file
   - After retries exhaust: "Failed" with retry button
6. Click retry button - should re-queue processing
7. Check logs for processing activity (text extraction, thumbnail)
  </how-to-verify>
  <resume-signal>Type "approved" if processing status works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] SSE endpoint streams status updates
- [ ] Status badge shows correct state (Pending/Processing/Complete/Failed)
- [ ] Live updates work without page refresh
- [ ] Failed documents show error and retry button
- [ ] Retry button re-queues processing
- [ ] HTMX SSE extension properly integrated
</verification>

<success_criteria>
Users can see real-time processing status for documents. Upload shows immediate feedback as documents move through the processing pipeline. Failed documents can be retried. Complete user feedback loop for document processing.
</success_criteria>

<output>
After completion, create `.planning/phases/03-processing/03-05-SUMMARY.md`
</output>
