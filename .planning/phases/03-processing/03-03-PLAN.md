---
phase: 03-processing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/processing/thumbnail.go
  - internal/processing/thumbnail_test.go
  - internal/document/document.go
autonomous: true

must_haves:
  truths:
    - "Thumbnails are generated as WebP images"
    - "Thumbnails are 300px width"
    - "Only first page is rendered"
    - "Corrupt PDFs get placeholder thumbnail"
    - "ThumbnailPath() returns .webp extension"
  artifacts:
    - path: "internal/processing/thumbnail.go"
      provides: "Thumbnail generation from PDFs"
      exports: ["ThumbnailGenerator", "Generate"]
    - path: "internal/processing/thumbnail_test.go"
      provides: "Tests for thumbnail generation"
    - path: "internal/document/document.go"
      provides: "Document service with correct thumbnail path extension"
      contains: ".webp"
  key_links:
    - from: "internal/processing/thumbnail.go"
      to: "pdftoppm"
      via: "exec.CommandContext"
      pattern: "pdftoppm"
    - from: "internal/processing/thumbnail.go"
      to: "cwebp"
      via: "exec.CommandContext"
      pattern: "cwebp"
    - from: "internal/processing/thumbnail.go"
      to: "internal/document/document.go"
      via: "ThumbnailPath() extension match"
      pattern: "\\.webp"
---

<objective>
Implement thumbnail generation service that converts the first page of PDFs to 300px WebP images using pdftoppm and cwebp. Falls back to placeholder for corrupt/unrenderable PDFs.

Purpose: Enable visual document preview in Phase 4 (Viewing). Thumbnails provide quick visual identification of documents in lists.
Output: Thumbnail generator that produces WebP thumbnails with placeholder fallback
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-processing/03-RESEARCH.md
@internal/storage/storage.go
@internal/document/document.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement thumbnail generation</name>
  <files>
    internal/processing/thumbnail.go
  </files>
  <action>
Create internal/processing/thumbnail.go with ThumbnailGenerator:

```go
package processing

// ThumbnailGenerator creates thumbnails from PDF files
type ThumbnailGenerator struct {
    placeholderPath string // Path to placeholder.webp for failures
    storage         *storage.Storage
}

// NewThumbnailGenerator creates a ThumbnailGenerator
func NewThumbnailGenerator(storage *storage.Storage, placeholderPath string) *ThumbnailGenerator

// Generate creates a thumbnail for a PDF document
// Returns the path to the generated thumbnail
func (g *ThumbnailGenerator) Generate(ctx context.Context, pdfPath string, docID uuid.UUID) (string, error)

// usePlaceholder copies the placeholder image to the thumbnail location
func (g *ThumbnailGenerator) usePlaceholder(thumbPath string) error
```

Implementation per RESEARCH.md:
1. Compute thumbnail path using storage.PathForUUID(storage.CategoryThumbnails, docID, ".webp")
2. Create temp directory for intermediate PNG
3. Run pdftoppm with timeout context:
   ```go
   // First page only, 300px width, PNG output
   cmd := exec.CommandContext(ctx, "pdftoppm",
       "-png",
       "-f", "1",           // First page
       "-singlefile",       // Single output file
       "-scale-to", "300",  // 300px width
       pdfPath,
       filepath.Join(tmpDir, "thumb"),  // Output prefix
   )
   ```
4. If pdftoppm fails, use placeholder (corrupt PDF)
5. Convert PNG to WebP:
   ```go
   cmd = exec.CommandContext(ctx, "cwebp",
       "-q", "80",          // Quality 80%
       pngPath,
       "-o", thumbPath,
   )
   ```
6. Clean up temp directory
7. Return thumbnail path

Handle errors gracefully:
- Context timeout: 2 minutes per RESEARCH.md pitfalls
- pdftoppm failure: use placeholder, log warning
- cwebp failure: return error (shouldn't happen if PNG exists)
  </action>
  <verify>
Check ./tmp/air-combined.log for compilation errors.
Run: go build ./internal/processing/...
Test manually if pdftoppm/cwebp available: pdftoppm -h && cwebp -h
  </verify>
  <done>
ThumbnailGenerator creates 300px WebP thumbnails from PDF first page. Falls back to placeholder for corrupt PDFs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests, ensure directory creation, and fix ThumbnailPath extension</name>
  <files>
    internal/processing/thumbnail.go
    internal/processing/thumbnail_test.go
    internal/document/document.go
  </files>
  <action>
1. Update Generate() to ensure thumbnail directory exists before writing:
   ```go
   if err := os.MkdirAll(filepath.Dir(thumbPath), 0755); err != nil {
       return "", fmt.Errorf("create thumbnail dir: %w", err)
   }
   ```

2. Add helper for checking if tools are available:
   ```go
   // CheckDependencies verifies pdftoppm and cwebp are available
   func CheckDependencies() error {
       if _, err := exec.LookPath("pdftoppm"); err != nil {
           return fmt.Errorf("pdftoppm not found: %w", err)
       }
       if _, err := exec.LookPath("cwebp"); err != nil {
           return fmt.Errorf("cwebp not found: %w", err)
       }
       return nil
   }
   ```

3. Create thumbnail_test.go:
   - Test that Generate() creates output at expected path (with mock/test PDF or skip)
   - Test usePlaceholder copies placeholder correctly
   - Test CheckDependencies returns appropriate error when tools missing
   - Test command construction (verify args are correct)

4. Add slog logging:
   - Info: thumbnail generated (docID, path, duration)
   - Warn: using placeholder (docID, reason)
   - Error: generation failed (docID, error)

5. **Update internal/document/document.go ThumbnailPath() method:**
   Change line 210 from `.png` to `.webp` extension to match generated thumbnails:
   ```go
   // ThumbnailPath returns the file path for a document's thumbnail
   func (s *Service) ThumbnailPath(doc *sqlc.Document) string {
       return s.storage.PathForUUID(storage.CategoryThumbnails, doc.ID, ".webp")
   }
   ```
   This ensures the document service can locate the WebP thumbnails generated by ThumbnailGenerator.
  </action>
  <verify>
Check ./tmp/air-combined.log for errors.
Run: make test to verify tests pass.
Verify document.go ThumbnailPath returns .webp: grep -n "\.webp" internal/document/document.go
  </verify>
  <done>
Thumbnail generator is complete with proper directory creation, dependency checking, and tests. ThumbnailPath() returns .webp extension matching generated thumbnails. Ready for integration with processing job handler.
  </done>
</task>

</tasks>

<verification>
- [ ] internal/processing/thumbnail.go compiles without errors
- [ ] ThumbnailGenerator.Generate() creates WebP thumbnails
- [ ] Placeholder fallback works for corrupt PDFs
- [ ] Tests exist and pass
- [ ] Proper error handling and logging
- [ ] CheckDependencies validates tool availability
- [ ] internal/document/document.go ThumbnailPath() returns .webp extension
</verification>

<success_criteria>
Thumbnail generation service complete. Produces 300px WebP thumbnails from first PDF page. Gracefully handles corrupt PDFs with placeholder. ThumbnailPath() in document service returns .webp to match generated files. Ready for processing job handler.
</success_criteria>

<output>
After completion, create `.planning/phases/03-processing/03-03-SUMMARY.md`
</output>
