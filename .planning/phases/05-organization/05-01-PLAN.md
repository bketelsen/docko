---
phase: 05-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sqlc/queries/tags.sql
  - internal/handler/tags.go
  - internal/handler/handler.go
  - templates/pages/admin/tags.templ
  - templates/layouts/admin.templ
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can view list of all tags with document counts"
    - "User can create a new tag with name and color"
    - "User can edit an existing tag name and color"
    - "User can delete a tag"
  artifacts:
    - path: "sqlc/queries/tags.sql"
      provides: "Tag CRUD queries with document counts"
      contains: "ListTagsWithCounts"
    - path: "internal/handler/tags.go"
      provides: "Tag HTTP handlers"
      exports: ["TagsPage", "CreateTag", "UpdateTag", "DeleteTag"]
    - path: "templates/pages/admin/tags.templ"
      provides: "Tag management page template"
      min_lines: 100
  key_links:
    - from: "templates/pages/admin/tags.templ"
      to: "internal/handler/tags.go"
      via: "HTMX form posts"
      pattern: "hx-post.*tags"
    - from: "internal/handler/tags.go"
      to: "sqlc/queries/tags.sql"
      via: "sqlc generated queries"
      pattern: "Queries\\..*Tag"
---

<objective>
Implement tag CRUD operations with management UI.

Purpose: Enable users to create, edit, and delete tags for document organization. Tags have names (unique) and colors (from preset palette).

Output: Working tag management page at /tags with create/edit/delete functionality using HTMX for partial updates.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md

# Database schema reference
@internal/database/migrations/003_documents.sql

# Pattern reference - follow inbox CRUD patterns
@internal/handler/inboxes.go
@templates/pages/admin/inboxes.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag SQL queries with document counts</name>
  <files>sqlc/queries/tags.sql</files>
  <action>
Create sqlc queries for tag CRUD operations:

1. `ListTagsWithCounts` - List all tags with document count via LEFT JOIN on document_tags, ORDER BY name
2. `GetTag` - Get single tag by ID
3. `CreateTag` - Insert tag with name and color, use ON CONFLICT (name) DO NOTHING to handle duplicates gracefully
4. `UpdateTag` - Update tag name and color by ID
5. `DeleteTag` - Delete tag by ID (document_tags cascade handled by FK constraint)
6. `SearchTags` - Search tags by name ILIKE pattern for autocomplete (will be used in Plan 04)

Store color as simple string (e.g., "red", "blue") matching Tailwind color names.

Reference the existing migration schema for table structure:
- tags: id (UUID), name (VARCHAR 100 UNIQUE), color (VARCHAR 7), created_at
  </action>
  <verify>Run `make generate` and check `./tmp/air-combined.log` for sqlc errors. Verify internal/database/sqlc/tags.sql.go is generated.</verify>
  <done>All 6 tag queries compile without errors and generated Go code exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create tag handlers and register routes</name>
  <files>internal/handler/tags.go, internal/handler/handler.go, cmd/server/main.go</files>
  <action>
Create internal/handler/tags.go with handlers following the inbox pattern:

1. `TagsPage(c echo.Context)` - List all tags, render tags.templ page
2. `CreateTag(c echo.Context)` - Parse form (name, color), validate name not empty, call CreateTag query, return TagCard partial for HTMX beforeend swap
3. `UpdateTag(c echo.Context)` - Parse ID from param, form values, update tag, return updated TagCard partial
4. `DeleteTag(c echo.Context)` - Parse ID from param, delete tag, return empty 200 for HTMX element removal

Color validation: Accept only these values: red, orange, amber, yellow, green, emerald, teal, blue, indigo, purple, pink, gray. Default to "blue" if invalid or empty.

Register routes in cmd/server/main.go under the auth-protected group:
- GET /tags -> TagsPage
- POST /tags -> CreateTag
- PUT /tags/:id -> UpdateTag (or POST /tags/:id for HTMX compatibility)
- DELETE /tags/:id -> DeleteTag

Note: HTMX prefers POST for updates, so use POST /tags/:id for update handler.
  </action>
  <verify>Run `make dev`, check `./tmp/air-combined.log` for compilation errors. Test routes exist with `curl -I http://localhost:3000/tags` (should redirect to login or return 401).</verify>
  <done>Tag handlers compile and routes are registered. Server starts without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create tag management page template with modal dialog and sidebar link</name>
  <files>templates/pages/admin/tags.templ, templates/layouts/admin.templ</files>
  <action>
Create templates/pages/admin/tags.templ following the inbox page pattern:

1. Page layout with Admin layout wrapper
2. Header: "Tag Management" title with description
3. "Add Tag" button that opens a modal dialog:
   - Button uses HTMX to load modal content or triggers JavaScript modal open
   - Use dialog element or a modal component pattern consistent with the codebase

4. Create/Edit Tag modal dialog:
   - Modal overlay with centered dialog box
   - Name input (required, text)
   - Color picker: 12 color buttons (radio-style selection) using the curated palette
   - Submit button (Create or Save depending on mode)
   - Cancel button to close modal
   - Form uses hx-post="/tags" hx-target="#tag-list" hx-swap="beforeend" for create
   - For edit: hx-post="/tags/:id" with hx-swap="outerHTML" targeting the card
   - Close modal on success: use HX-Trigger response header or hx-on::after-request

5. Tag list (#tag-list div):
   - Grid layout (responsive: 1 col mobile, 2 cols md, 3 cols lg)
   - Empty state message when no tags
   - TagCard component for each tag

6. TagCard component (separate templ function):
   - Card with color indicator (colored dot or left border)
   - Tag name prominently displayed
   - Document count badge (e.g., "5 documents")
   - Edit button (opens modal dialog pre-filled with tag data)
   - Delete button with hx-confirm showing document count

7. Color palette helper:
   - Define color options as Go slice with name and Tailwind bg class
   - ColorButton component for the picker
   - Selected state styling (ring/border)

Add sidebar link in templates/layouts/admin.templ:
- Add "Tags" link after "Inboxes" with appropriate icon (tag icon)
- Use SVG tag icon: path with tag shape

Generate templates: templates are auto-generated by `make dev`, but verify with `make generate` if needed.
  </action>
  <verify>Run `make dev`, navigate to http://localhost:3000/tags (after login). Page should render with Add Tag button that opens modal. Check `./tmp/air-combined.log` for template errors.</verify>
  <done>Tag management page renders correctly with modal dialog for create/edit operations. Sidebar shows Tags link.</done>
</task>

</tasks>

<verification>
1. Navigate to /tags page - shows tag management UI with "Add Tag" button
2. Click "Add Tag" - modal dialog opens with name input and color picker
3. Create a tag with name "Important" and red color - modal closes, tag appears in list
4. Create another tag "Archive" with gray color - both tags visible
5. Click edit on "Important" tag - modal opens pre-filled with current values
6. Change color to orange, save - modal closes, tag updates in list
7. Delete "Archive" tag (confirm dialog shows "0 documents") - tag removed
8. Sidebar navigation includes Tags link with correct icon
</verification>

<success_criteria>
- Tag management page accessible at /tags
- Modal dialog opens for creating new tags
- Modal dialog opens for editing existing tags (pre-filled)
- Can create tags with name and color from preset palette
- Can edit existing tag name and color via modal
- Can delete tags with confirmation
- Tag list shows document count (0 for new tags)
- HTMX partial updates work (no full page reloads except modal open/close)
- Sidebar includes Tags navigation link
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-01-SUMMARY.md`
</output>
