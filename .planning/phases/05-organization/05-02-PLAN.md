---
phase: 05-organization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - sqlc/queries/correspondents.sql
  - internal/handler/correspondents.go
  - internal/handler/handler.go
  - templates/pages/admin/correspondents.templ
  - templates/layouts/admin.templ
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can view list of all correspondents with document counts"
    - "User can create a new correspondent with name and notes"
    - "User can edit an existing correspondent name and notes"
    - "User can delete a correspondent"
  artifacts:
    - path: "sqlc/queries/correspondents.sql"
      provides: "Correspondent CRUD queries with document counts"
      contains: "ListCorrespondentsWithCounts"
    - path: "internal/handler/correspondents.go"
      provides: "Correspondent HTTP handlers"
      exports: ["CorrespondentsPage", "CreateCorrespondent", "UpdateCorrespondent", "DeleteCorrespondent"]
    - path: "templates/pages/admin/correspondents.templ"
      provides: "Correspondent management page template"
      min_lines: 80
  key_links:
    - from: "templates/pages/admin/correspondents.templ"
      to: "internal/handler/correspondents.go"
      via: "HTMX form posts"
      pattern: "hx-post.*correspondents"
    - from: "internal/handler/correspondents.go"
      to: "sqlc/queries/correspondents.sql"
      via: "sqlc generated queries"
      pattern: "Queries\\..*Correspondent"
---

<objective>
Implement correspondent CRUD operations with management UI.

Purpose: Enable users to create, edit, and delete correspondents for document organization. Correspondents represent people or organizations associated with documents, with name and optional notes.

Output: Working correspondent management page at /correspondents with create/edit/delete functionality using HTMX for partial updates.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md

# Database schema reference
@internal/database/migrations/003_documents.sql

# Pattern reference - follow inbox CRUD patterns
@internal/handler/inboxes.go
@templates/pages/admin/inboxes.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correspondent SQL queries with document counts</name>
  <files>sqlc/queries/correspondents.sql</files>
  <action>
Create sqlc queries for correspondent CRUD operations:

1. `ListCorrespondentsWithCounts` - List all correspondents with document count via LEFT JOIN on document_correspondents, ORDER BY name
2. `GetCorrespondent` - Get single correspondent by ID
3. `CreateCorrespondent` - Insert correspondent with name and optional notes
4. `UpdateCorrespondent` - Update correspondent name and notes by ID
5. `DeleteCorrespondent` - Delete correspondent by ID (document_correspondents cascade handled by FK)
6. `SearchCorrespondents` - Search correspondents by name ILIKE pattern for autocomplete (will be used in Plan 05)

Note: The correspondents table needs a `notes` column that doesn't exist in the original migration. Add migration 006_correspondent_notes.sql:
```sql
-- +goose Up
ALTER TABLE correspondents ADD COLUMN notes TEXT;

-- +goose Down
ALTER TABLE correspondents DROP COLUMN notes;
```

Reference the existing migration schema for table structure:
- correspondents: id (UUID), name (VARCHAR 255), notes (TEXT, nullable), created_at
  </action>
  <verify>Run `make generate` and check `./tmp/air-combined.log` for sqlc/migration errors. Verify internal/database/sqlc/correspondents.sql.go is generated. Run `make migrate` to apply new migration.</verify>
  <done>All 6 correspondent queries compile without errors, migration applied, and generated Go code exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create correspondent handlers and register routes</name>
  <files>internal/handler/correspondents.go, internal/handler/handler.go, cmd/server/main.go</files>
  <action>
Create internal/handler/correspondents.go with handlers following the inbox pattern:

1. `CorrespondentsPage(c echo.Context)` - List all correspondents, render correspondents.templ page
2. `CreateCorrespondent(c echo.Context)` - Parse form (name, notes), validate name not empty, call CreateCorrespondent query, return CorrespondentCard partial for HTMX beforeend swap
3. `UpdateCorrespondent(c echo.Context)` - Parse ID from param, form values, update correspondent, return updated CorrespondentCard partial
4. `DeleteCorrespondent(c echo.Context)` - Parse ID from param, delete correspondent, return empty 200 for HTMX element removal

Validation:
- Name is required, trim whitespace
- Notes is optional, can be empty string or nil

Register routes in cmd/server/main.go under the auth-protected group:
- GET /correspondents -> CorrespondentsPage
- POST /correspondents -> CreateCorrespondent
- POST /correspondents/:id -> UpdateCorrespondent (HTMX compatible)
- DELETE /correspondents/:id -> DeleteCorrespondent
  </action>
  <verify>Run `make dev`, check `./tmp/air-combined.log` for compilation errors. Test routes exist with `curl -I http://localhost:3000/correspondents` (should redirect to login or return 401).</verify>
  <done>Correspondent handlers compile and routes are registered. Server starts without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create correspondent management page template and sidebar link</name>
  <files>templates/pages/admin/correspondents.templ, templates/layouts/admin.templ</files>
  <action>
Create templates/pages/admin/correspondents.templ following the inbox page pattern:

1. Page layout with Admin layout wrapper
2. Header: "Correspondent Management" title with description
3. Add Correspondent form (inline):
   - Name input (required, text)
   - Notes textarea (optional, for additional info about the correspondent)
   - Submit button
   - Form uses hx-post="/correspondents" hx-target="#correspondent-list" hx-swap="beforeend"
   - Reset form on success

4. Correspondent list (#correspondent-list div):
   - Vertical list layout (cards stacked)
   - Empty state message when no correspondents
   - CorrespondentCard component for each correspondent

5. CorrespondentCard component:
   - Card with correspondent name prominently displayed
   - Document count badge (e.g., "5 documents")
   - Notes preview (truncated if long, expandable)
   - Edit button (inline edit form)
   - Delete button with hx-confirm showing document count
   - Include checkbox for merge selection (hidden initially, shown when merge mode active - Plan 03 will add merge functionality)

Add sidebar link in templates/layouts/admin.templ:
- Add "Correspondents" link after "Tags" with appropriate icon (user/person icon)
- Use SVG user icon
  </action>
  <verify>Run `make dev`, navigate to http://localhost:3000/correspondents (after login). Page should render with form and empty correspondent list. Check `./tmp/air-combined.log` for template errors.</verify>
  <done>Correspondent management page renders correctly with add form and empty state. Sidebar shows Correspondents link.</done>
</task>

</tasks>

<verification>
1. Navigate to /correspondents page - shows correspondent management UI
2. Create a correspondent "Acme Corp" with notes "Vendor for office supplies" - appears in list
3. Create another correspondent "John Smith" with no notes - both visible
4. Edit "Acme Corp" to add more notes - updates correctly
5. Delete "John Smith" (confirm dialog shows "0 documents") - correspondent removed
6. Sidebar navigation includes Correspondents link with correct icon
</verification>

<success_criteria>
- Correspondent management page accessible at /correspondents
- Can create correspondents with name and optional notes
- Can edit existing correspondent name and notes
- Can delete correspondents with confirmation
- Correspondent list shows document count (0 for new correspondents)
- HTMX partial updates work (no full page reloads)
- Sidebar includes Correspondents navigation link
- Migration for notes column applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-02-SUMMARY.md`
</output>
