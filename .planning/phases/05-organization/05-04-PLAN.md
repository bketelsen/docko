---
phase: 05-organization
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - sqlc/queries/tags.sql
  - internal/handler/tags.go
  - internal/handler/documents.go
  - templates/partials/tag_picker.templ
  - templates/pages/admin/document_detail.templ
  - templates/pages/admin/documents.templ
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can assign tags to a document from detail page"
    - "User can remove tags from a document"
    - "User can create new tags inline while assigning"
    - "User can assign tags from document list view"
  artifacts:
    - path: "sqlc/queries/tags.sql"
      provides: "Document-tag relationship queries"
      contains: "AddDocumentTag"
    - path: "templates/partials/tag_picker.templ"
      provides: "Reusable tag picker component"
      min_lines: 50
    - path: "internal/handler/tags.go"
      provides: "Tag assignment handlers"
      exports: ["SearchTagsForDocument", "AddDocumentTag", "RemoveDocumentTag"]
  key_links:
    - from: "templates/partials/tag_picker.templ"
      to: "internal/handler/tags.go"
      via: "HTMX search and assignment"
      pattern: "hx-get.*tags/search|hx-post.*documents/.*/tags"
    - from: "templates/pages/admin/document_detail.templ"
      to: "templates/partials/tag_picker.templ"
      via: "templ component import"
      pattern: "@partials.TagPicker"
    - from: "templates/pages/admin/documents.templ"
      to: "templates/partials/tag_picker.templ"
      via: "templ component import for list view"
      pattern: "@partials.TagPicker|@partials.InlineTagPicker"
---

<objective>
Implement tag assignment to documents with searchable picker and inline creation.

Purpose: Allow users to assign and remove tags from documents. The picker supports searching existing tags and creating new tags inline when the typed name doesn't exist.

Output: Tag picker component integrated into document detail page and document list, with full HTMX-powered search and assignment.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md

# Depends on Plan 01 outputs
@.planning/phases/05-organization/05-01-SUMMARY.md

# Integration targets
@templates/pages/admin/document_detail.templ
@templates/pages/admin/documents.templ
@internal/handler/documents.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add document-tag SQL queries</name>
  <files>sqlc/queries/tags.sql</files>
  <action>
Add document-tag relationship queries to sqlc/queries/tags.sql:

1. `GetDocumentTags` - Get all tags for a document:
   ```sql
   -- name: GetDocumentTags :many
   SELECT t.* FROM tags t
   INNER JOIN document_tags dt ON dt.tag_id = t.id
   WHERE dt.document_id = $1
   ORDER BY t.name;
   ```

2. `AddDocumentTag` - Assign a tag to a document (idempotent):
   ```sql
   -- name: AddDocumentTag :exec
   INSERT INTO document_tags (document_id, tag_id)
   VALUES ($1, $2)
   ON CONFLICT (document_id, tag_id) DO NOTHING;
   ```

3. `RemoveDocumentTag` - Remove a tag from a document:
   ```sql
   -- name: RemoveDocumentTag :exec
   DELETE FROM document_tags
   WHERE document_id = $1 AND tag_id = $2;
   ```

4. `SearchTagsExcludingDocument` - Search tags not already assigned to document (for picker):
   ```sql
   -- name: SearchTagsExcludingDocument :many
   SELECT t.* FROM tags t
   WHERE t.name ILIKE $1
   AND t.id NOT IN (
     SELECT tag_id FROM document_tags WHERE document_id = $2
   )
   ORDER BY t.name
   LIMIT 10;
   ```
  </action>
  <verify>Run `make generate` and check `./tmp/air-combined.log` for sqlc errors.</verify>
  <done>Document-tag relationship queries compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create tag assignment handlers</name>
  <files>internal/handler/tags.go, cmd/server/main.go</files>
  <action>
Add tag assignment handlers to internal/handler/tags.go:

1. `SearchTagsForDocument(c echo.Context)`:
   - Parse document_id from URL param, q (search query) from query string
   - Call SearchTagsExcludingDocument with "%"+q+"%" pattern
   - If no results and q is not empty, include "Create tag" option
   - Return TagSearchResults partial HTML

2. `AddDocumentTag(c echo.Context)`:
   - Parse document_id from URL, tag_id from form
   - If tag_id is "new", create new tag first (name from form, default color blue)
   - Call AddDocumentTag query
   - Return updated DocumentTagsList partial (all tags for this document)

3. `RemoveDocumentTag(c echo.Context)`:
   - Parse document_id and tag_id from URL
   - Call RemoveDocumentTag query
   - Return updated DocumentTagsList partial

Register routes:
- GET /documents/:id/tags/search -> SearchTagsForDocument
- POST /documents/:id/tags -> AddDocumentTag
- DELETE /documents/:id/tags/:tag_id -> RemoveDocumentTag
  </action>
  <verify>Run `make dev`, check compilation. Test search endpoint with curl.</verify>
  <done>Tag assignment handlers compile and routes are registered.</done>
</task>

<task type="auto">
  <name>Task 3: Create tag picker component and integrate into detail page and document list</name>
  <files>templates/partials/tag_picker.templ, templates/pages/admin/document_detail.templ, templates/pages/admin/documents.templ, internal/handler/documents.go</files>
  <action>
Create templates/partials/tag_picker.templ:

1. TagPicker component (takes documentID string, currentTags []sqlc.Tag):
   ```templ
   templ TagPicker(documentID string, currentTags []sqlc.Tag) {
     <div class="tag-picker">
       // Display current tags as removable badges
       <div id={"doc-"+documentID+"-tags"} class="flex flex-wrap gap-1 mb-2">
         for _, tag := range currentTags {
           @TagBadge(documentID, tag, true)  // true = removable
         }
       </div>

       // Search input
       <div class="relative">
         <input type="search"
                name="q"
                placeholder="Add tag..."
                class="w-full px-3 py-1.5 text-sm border rounded-md"
                hx-get={"/documents/"+documentID+"/tags/search"}
                hx-trigger="input changed delay:300ms, focus"
                hx-target={"#tag-search-"+documentID}
                autocomplete="off"/>
         <div id={"tag-search-"+documentID}
              class="absolute z-10 w-full mt-1 bg-background border rounded-md shadow-lg hidden">
           // Search results populated by HTMX
         </div>
       </div>
     </div>
   }
   ```

2. TagBadge component (tag with color and optional remove button):
   - Colored background based on tag.color
   - Tag name
   - If removable: X button with hx-delete to remove tag

3. TagSearchResults component (for search dropdown):
   - List of matching tags (clickable to add)
   - "Create {query}" option if no exact match and query not empty
   - Each item has hx-post to add the tag
   - Close dropdown on selection

4. DocumentTagsList component (for HTMX swap after add/remove):
   - Renders list of TagBadge components
   - Used as return value from AddDocumentTag/RemoveDocumentTag

5. InlineTagPicker component (compact version for document list):
   - Smaller, click-to-expand tag picker for use in document cards
   - Shows current tags as small badges
   - Click "+" button to expand search dropdown
   - Same functionality as full TagPicker but more compact UI

Update templates/pages/admin/document_detail.templ:
- Add "Tags" section in the Overview tab
- Include TagPicker component
- Load document tags (update handler to include tags in context)

Update templates/pages/admin/documents.templ:
- Add tag display on each document card showing current tags
- Add InlineTagPicker component to each document card
- Clicking the tag area or "+" button opens the search dropdown
- User can add/remove tags directly from the document list without navigating to detail

Update internal/handler/documents.go:
- Modify DocumentDetailPage to also fetch and pass document tags
- Modify DocumentsListPage (or equivalent) to fetch tags for each document
  </action>
  <verify>Run `make dev`, navigate to document detail page. Tag picker should appear. Test adding/removing tags. Navigate to document list, verify tag picker works inline on document cards. Check ./tmp/air-combined.log for template errors.</verify>
  <done>Tag picker integrated into document detail page and document list view. Can search, add, remove, and create tags inline from both views.</done>
</task>

</tasks>

<verification>
1. Navigate to document detail page - Tags section visible in Overview tab
2. Click tag search input - dropdown appears (empty if no tags exist)
3. Type "Inv" - matching tags show (e.g., "Invoice" if exists)
4. Click a tag to add it - tag appears as badge, dropdown closes
5. Type "NewTag" (doesn't exist) - "Create NewTag" option appears
6. Click "Create NewTag" - tag created and assigned, badge appears
7. Click X on tag badge - tag removed from document
8. Navigate to document list - tags visible on document cards
9. Click "+" or tag area on a document card in list view - inline picker expands
10. Add a tag from list view - tag appears on card without page navigation
11. Remove a tag from list view - tag removed from card
12. Tags persist after page refresh (verify database)
</verification>

<success_criteria>
- Tag picker component is reusable (works in multiple contexts)
- Search filters existing tags with 300ms debounce
- Can add existing tags to documents from detail page
- Can add existing tags to documents from list view
- Can create and add new tags inline from both views
- Can remove tags from documents from both views
- Document detail page shows current tags with full TagPicker
- Document list shows tags on cards with InlineTagPicker
- All operations use HTMX partial updates (no full page reloads)
- Tags display with their assigned colors
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-04-SUMMARY.md`
</output>
