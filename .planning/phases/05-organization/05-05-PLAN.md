---
phase: 05-organization
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - sqlc/queries/correspondents.sql
  - sqlc/queries/documents.sql
  - internal/handler/correspondents.go
  - internal/handler/documents.go
  - templates/partials/correspondent_picker.templ
  - templates/pages/admin/document_detail.templ
  - templates/pages/admin/documents.templ
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can assign a correspondent to a document from detail page"
    - "User can change the correspondent assigned to a document"
    - "User can remove correspondent from a document"
    - "User can create new correspondent inline while assigning"
  artifacts:
    - path: "sqlc/queries/correspondents.sql"
      provides: "Document-correspondent relationship queries"
      contains: "SetDocumentCorrespondent"
    - path: "templates/partials/correspondent_picker.templ"
      provides: "Reusable correspondent picker component"
      min_lines: 40
    - path: "internal/handler/correspondents.go"
      provides: "Correspondent assignment handlers"
      exports: ["SearchCorrespondentsForDocument", "SetDocumentCorrespondent", "RemoveDocumentCorrespondent"]
  key_links:
    - from: "templates/partials/correspondent_picker.templ"
      to: "internal/handler/correspondents.go"
      via: "HTMX search and assignment"
      pattern: "hx-get.*correspondents/search|hx-post.*documents/.*/correspondent"
    - from: "templates/pages/admin/document_detail.templ"
      to: "templates/partials/correspondent_picker.templ"
      via: "templ component import"
      pattern: "@partials.CorrespondentPicker"
---

<objective>
Implement correspondent assignment to documents with searchable picker and inline creation.

Purpose: Allow users to assign a correspondent to a document. Since documents have a 1:1 relationship with correspondents, the picker allows setting/changing the single correspondent. The picker supports searching existing correspondents and creating new ones inline.

Output: Correspondent picker component integrated into document detail page and document list, with full HTMX-powered search and assignment.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-organization/05-CONTEXT.md
@.planning/phases/05-organization/05-RESEARCH.md

# Depends on Plan 02 and 03 outputs
@.planning/phases/05-organization/05-02-SUMMARY.md
@.planning/phases/05-organization/05-03-SUMMARY.md

# Integration targets
@templates/pages/admin/document_detail.templ
@templates/pages/admin/documents.templ
@internal/handler/documents.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add document-correspondent SQL queries</name>
  <files>sqlc/queries/correspondents.sql, sqlc/queries/documents.sql</files>
  <action>
Add document-correspondent relationship queries to sqlc/queries/correspondents.sql:

1. `GetDocumentCorrespondent` - Get correspondent for a document (if any):
   ```sql
   -- name: GetDocumentCorrespondent :one
   SELECT c.* FROM correspondents c
   INNER JOIN document_correspondents dc ON dc.correspondent_id = c.id
   WHERE dc.document_id = $1;
   ```

2. `SetDocumentCorrespondent` - Assign/replace correspondent for a document:
   ```sql
   -- name: SetDocumentCorrespondent :exec
   INSERT INTO document_correspondents (document_id, correspondent_id)
   VALUES ($1, $2)
   ON CONFLICT (document_id) DO UPDATE SET correspondent_id = $2;
   ```

3. `RemoveDocumentCorrespondent` - Remove correspondent from a document:
   ```sql
   -- name: RemoveDocumentCorrespondent :exec
   DELETE FROM document_correspondents
   WHERE document_id = $1;
   ```

4. `SearchCorrespondentsWithLimit` - Search correspondents for picker:
   ```sql
   -- name: SearchCorrespondentsWithLimit :many
   SELECT * FROM correspondents
   WHERE name ILIKE $1
   ORDER BY name
   LIMIT 10;
   ```

Optionally add to documents.sql for list queries:
```sql
-- name: ListDocumentsWithCorrespondent :many
SELECT d.*, c.id as correspondent_id, c.name as correspondent_name
FROM documents d
LEFT JOIN document_correspondents dc ON dc.document_id = d.id
LEFT JOIN correspondents c ON c.id = dc.correspondent_id
ORDER BY d.created_at DESC
LIMIT $1 OFFSET $2;
```
  </action>
  <verify>Run `make generate` and check `./tmp/air-combined.log` for sqlc errors.</verify>
  <done>Document-correspondent relationship queries compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create correspondent assignment handlers</name>
  <files>internal/handler/correspondents.go, cmd/server/main.go</files>
  <action>
Add correspondent assignment handlers to internal/handler/correspondents.go:

1. `SearchCorrespondentsForDocument(c echo.Context)`:
   - Parse q (search query) from query string
   - Call SearchCorrespondentsWithLimit with "%"+q+"%" pattern
   - If no results and q is not empty, include "Create correspondent" option
   - Return CorrespondentSearchResults partial HTML

2. `SetDocumentCorrespondent(c echo.Context)`:
   - Parse document_id from URL, correspondent_id from form
   - If correspondent_id is "new", create new correspondent first (name from form)
   - Call SetDocumentCorrespondent query
   - Return updated CorrespondentDisplay partial (single correspondent badge/display)

3. `RemoveDocumentCorrespondent(c echo.Context)`:
   - Parse document_id from URL
   - Call RemoveDocumentCorrespondent query
   - Return updated CorrespondentDisplay partial (empty state)

Register routes:
- GET /correspondents/search -> SearchCorrespondentsForDocument (reuse for general search)
- POST /documents/:id/correspondent -> SetDocumentCorrespondent
- DELETE /documents/:id/correspondent -> RemoveDocumentCorrespondent
  </action>
  <verify>Run `make dev`, check compilation. Test search endpoint with curl.</verify>
  <done>Correspondent assignment handlers compile and routes are registered.</done>
</task>

<task type="auto">
  <name>Task 3: Create correspondent picker component and integrate into pages</name>
  <files>templates/partials/correspondent_picker.templ, templates/pages/admin/document_detail.templ, templates/pages/admin/documents.templ, internal/handler/documents.go</files>
  <action>
Create templates/partials/correspondent_picker.templ:

1. CorrespondentPicker component (takes documentID string, currentCorrespondent *sqlc.Correspondent):
   ```templ
   templ CorrespondentPicker(documentID string, currentCorrespondent *sqlc.Correspondent) {
     <div class="correspondent-picker">
       // Display current correspondent (if any)
       <div id={"doc-"+documentID+"-correspondent"}>
         if currentCorrespondent != nil {
           @CorrespondentDisplay(documentID, currentCorrespondent)
         } else {
           @CorrespondentEmptyState(documentID)
         }
       </div>
     </div>
   }
   ```

2. CorrespondentDisplay component (shows assigned correspondent with change/remove):
   - Correspondent name displayed
   - "Change" button to show picker
   - "Remove" button with hx-delete

3. CorrespondentEmptyState component:
   - "No correspondent assigned" message
   - "Assign" button to show picker

4. CorrespondentSearchInput component (shown when changing/assigning):
   - Search input with HTMX search
   - Dropdown for results
   - Cancel button to hide picker

5. CorrespondentSearchResults component (for search dropdown):
   - List of matching correspondents (clickable to assign)
   - "Create {query}" option if no exact match
   - Each item has hx-post to set the correspondent
   - Close dropdown on selection

Update templates/pages/admin/document_detail.templ:
- Add "Correspondent" section in the Overview tab (near Tags section)
- Include CorrespondentPicker component
- Load document correspondent (update handler to include correspondent in context)

Update templates/pages/admin/documents.templ:
- Add correspondent display in document list cards (small text below filename)
- Link to correspondent management page or show inline

Update internal/handler/documents.go:
- Modify DocumentDetailPage to also fetch and pass document correspondent
- Modify ListDocuments to include correspondent info (use new query or separate fetch)
  </action>
  <verify>Run `make dev`, navigate to document detail page. Correspondent picker should appear. Test assigning, changing, and removing correspondent. Check document list shows correspondent.</verify>
  <done>Correspondent picker integrated into document detail page. Can search, assign, change, remove, and create correspondents inline. Document list shows assigned correspondent.</done>
</task>

</tasks>

<verification>
1. Navigate to document detail page - Correspondent section visible in Overview tab
2. See "No correspondent assigned" with "Assign" button (for new document)
3. Click "Assign" - search input appears
4. Type "Acme" - matching correspondents show in dropdown
5. Click "Acme Corp" to assign - correspondent displayed, search hidden
6. Click "Change" - search input reappears
7. Type "NewCo" (doesn't exist) - "Create NewCo" option appears
8. Click "Create NewCo" - correspondent created and assigned
9. Click "Remove" - correspondent removed, empty state shown
10. Navigate to document list - correspondent names visible on cards
11. Correspondent persists after page refresh (verify database)
</verification>

<success_criteria>
- Correspondent picker component is reusable
- Search filters existing correspondents with 300ms debounce
- Can assign existing correspondent to document
- Can change document's correspondent to a different one
- Can remove correspondent from document
- Can create and assign new correspondent inline
- Document detail page shows current correspondent
- Document list shows correspondent on cards
- All operations use HTMX partial updates (no full page reloads)
- Only one correspondent per document (enforced by database)
</success_criteria>

<output>
After completion, create `.planning/phases/05-organization/05-05-SUMMARY.md`
</output>
