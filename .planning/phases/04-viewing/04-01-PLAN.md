---
phase: 04-viewing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/handler/documents.go
  - internal/handler/handler.go
  - components/dialog/dialog.templ
  - components/tabs/tabs.templ
  - components/breadcrumb/breadcrumb.templ
autonomous: true

must_haves:
  truths:
    - "PDF file can be served inline for browser viewing"
    - "PDF file can be served as attachment for download"
    - "Thumbnail image can be served for display"
  artifacts:
    - path: "internal/handler/documents.go"
      provides: "ViewPDF, DownloadPDF, ServeThumbnail handlers"
      exports: ["ViewPDF", "DownloadPDF", "ServeThumbnail"]
    - path: "components/dialog/dialog.templ"
      provides: "Modal wrapper component"
    - path: "components/tabs/tabs.templ"
      provides: "Tabbed content panels"
    - path: "components/breadcrumb/breadcrumb.templ"
      provides: "Navigation breadcrumbs"
  key_links:
    - from: "internal/handler/documents.go"
      to: "internal/document/document.go"
      via: "OriginalPath, ThumbnailPath methods"
      pattern: "h\\.docSvc\\.OriginalPath"
    - from: "internal/handler/handler.go"
      to: "internal/handler/documents.go"
      via: "route registration"
      pattern: "e\\.GET.*\\/documents\\/:id"
---

<objective>
Add file serving handlers for PDF viewing/downloading and install templUI components needed for the document detail page.

Purpose: Enable serving PDF files inline (for browser viewing) and as attachments (for download), plus provide the UI components (Dialog, Tabs, Breadcrumb) needed by subsequent plans.

Output: Three new handlers in documents.go, routes registered in handler.go, and three templUI components installed.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-viewing/04-CONTEXT.md
@.planning/phases/04-viewing/04-RESEARCH.md
@internal/handler/documents.go
@internal/handler/handler.go
@internal/document/document.go
@internal/storage/storage.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file serving handlers</name>
  <files>
    internal/handler/documents.go
    internal/handler/handler.go
  </files>
  <action>
Add three new handlers to documents.go:

1. **ViewPDF** - GET /documents/:id/view
   - Parse UUID from path param
   - Fetch document from database using h.db.Queries.GetDocument
   - Get file path using h.docSvc.OriginalPath(&doc)
   - Check file exists using h.docSvc.storage... wait, storage is not exposed on handler.
   - Actually check by attempting to open or use os.Stat
   - Use c.Inline(pdfPath, doc.OriginalFilename) to serve with Content-Disposition: inline
   - Return 404 if document or file not found

2. **DownloadPDF** - GET /documents/:id/download
   - Same as ViewPDF but use c.Attachment(pdfPath, doc.OriginalFilename)
   - This triggers browser download dialog with original filename

3. **ServeThumbnail** - GET /documents/:id/thumbnail
   - Parse UUID, fetch document
   - Get thumbnail path using h.docSvc.ThumbnailPath(&doc)
   - Check if thumbnail exists (doc.ThumbnailGenerated == true)
   - Serve with c.File() or c.Inline() for images
   - Return placeholder image or 404 if thumbnail not generated

Note: The docSvc has OriginalPath and ThumbnailPath methods but no storage reference accessible from handler. Add a FileExists method to document.Service that wraps storage.FileExists.

Register routes in handler.go:
```go
// Document viewing routes (protected)
e.GET("/documents/:id/view", h.ViewPDF, middleware.RequireAuth(h.auth))
e.GET("/documents/:id/download", h.DownloadPDF, middleware.RequireAuth(h.auth))
e.GET("/documents/:id/thumbnail", h.ServeThumbnail, middleware.RequireAuth(h.auth))
```
  </action>
  <verify>
Check build logs: `cat ./tmp/air-combined.log | tail -50`
Test endpoints with curl (requires auth - check manually or via browser):
- GET /documents/{uuid}/view should serve PDF inline
- GET /documents/{uuid}/download should trigger download
- GET /documents/{uuid}/thumbnail should serve WebP image
  </verify>
  <done>
Three file serving endpoints exist and return correct Content-Type and Content-Disposition headers. Routes are registered and protected by auth middleware.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install templUI components</name>
  <files>
    components/dialog/dialog.templ
    components/tabs/tabs.templ
    components/breadcrumb/breadcrumb.templ
  </files>
  <action>
Install three templUI components using the CLI:

```bash
cd /home/bjk/projects/corpus/docko
templui add dialog tabs breadcrumb
```

If templui CLI not installed:
```bash
go install github.com/templui/templui/cmd/templui@latest
```

After installation, run `make generate` to generate the Go code from templ files.

Check that components are created in:
- components/dialog/
- components/tabs/
- components/breadcrumb/

If components require additional dependencies, install them:
```bash
go get github.com/Oudwins/tailwind-merge-go
```

Verify the components compile without errors by checking build logs.
  </action>
  <verify>
```bash
ls -la components/dialog/ components/tabs/ components/breadcrumb/
cat ./tmp/air-combined.log | tail -30
```
All three component directories exist with .templ files and generated _templ.go files. No compilation errors.
  </verify>
  <done>
Dialog, Tabs, and Breadcrumb components are installed and compile successfully. Ready for use in document detail page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add FileExists helper to document service</name>
  <files>
    internal/document/document.go
  </files>
  <action>
Add a FileExists method to the document Service that wraps the storage service:

```go
// FileExists checks if a file exists at the given path
func (s *Service) FileExists(path string) bool {
    return s.storage.FileExists(path)
}
```

This allows handlers to check if files exist before attempting to serve them, without needing direct access to the storage service.
  </action>
  <verify>
Check build logs for compilation success.
The method should be callable as: h.docSvc.FileExists(pdfPath)
  </verify>
  <done>
FileExists method exists on document.Service and delegates to storage.FileExists.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build compiles without errors:
   ```bash
   cat ./tmp/air-combined.log | tail -30
   ```

2. New routes are registered (check handler.go):
   - GET /documents/:id/view
   - GET /documents/:id/download
   - GET /documents/:id/thumbnail

3. templUI components exist:
   ```bash
   ls components/dialog/ components/tabs/ components/breadcrumb/
   ```

4. If a document exists in the system, test serving:
   - Navigate to /documents in browser
   - Note a document ID from the list
   - Try accessing /documents/{id}/view directly (should prompt login or serve PDF)
</verification>

<success_criteria>
- ViewPDF handler serves PDF with Content-Type: application/pdf
- DownloadPDF handler triggers browser download dialog
- ServeThumbnail handler serves WebP image for generated thumbnails
- Dialog, Tabs, Breadcrumb components installed and compiling
- All routes protected by auth middleware
</success_criteria>

<output>
After completion, create `.planning/phases/04-viewing/04-01-SUMMARY.md`
</output>
