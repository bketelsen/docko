---
phase: 04-viewing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - templates/pages/admin/document_detail.templ
  - internal/handler/documents.go
  - internal/handler/handler.go
autonomous: true

must_haves:
  truths:
    - "Document detail page displays at /documents/:id"
    - "Detail page shows thumbnail and metadata in side-by-side layout"
    - "Tabs switch between Overview and Technical information"
    - "Breadcrumb navigation shows Home > Documents > [Document Name]"
  artifacts:
    - path: "templates/pages/admin/document_detail.templ"
      provides: "Document detail page template"
      min_lines: 100
    - path: "internal/handler/documents.go"
      provides: "DocumentDetail handler"
      exports: ["DocumentDetail"]
  key_links:
    - from: "templates/pages/admin/document_detail.templ"
      to: "components/tabs/tabs.templ"
      via: "templ import"
      pattern: "@tabs\\."
    - from: "templates/pages/admin/document_detail.templ"
      to: "components/breadcrumb/breadcrumb.templ"
      via: "templ import"
      pattern: "@breadcrumb\\."
    - from: "internal/handler/handler.go"
      to: "internal/handler/documents.go"
      via: "route registration"
      pattern: "e\\.GET.*\\/documents\\/:id\""
---

<objective>
Create the document detail page with side-by-side layout showing thumbnail and metadata in tabs.

Purpose: Provide a dedicated page for viewing document information before opening the PDF viewer or downloading.

Output: New document_detail.templ template, DocumentDetail handler, and route at /documents/:id.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-viewing/04-CONTEXT.md
@.planning/phases/04-viewing/04-RESEARCH.md
@.planning/phases/04-viewing/04-01-SUMMARY.md
@internal/handler/documents.go
@templates/pages/admin/documents.templ
@templates/layouts/admin.templ
@components/tabs/tabs.templ
@components/breadcrumb/breadcrumb.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document detail page template</name>
  <files>
    templates/pages/admin/document_detail.templ
  </files>
  <action>
Create templates/pages/admin/document_detail.templ with:

1. **Layout**: Use layouts.Admin with appropriate meta

2. **Breadcrumb navigation** at top:
   - Home (/) > Documents (/documents) > [Document Name]
   - Use the Breadcrumb component from components/breadcrumb

3. **Page header** with title and action buttons:
   - Title: Document filename (truncated if long)
   - Primary button: "View PDF" (filled, triggers modal - will be wired in Plan 03)
   - Secondary button: "Download" (outline, links to /documents/:id/download)

4. **Side-by-side layout** (responsive):
   - Desktop: thumbnail on left (40%), metadata panel on right (60%)
   - Mobile: stacked (thumbnail on top, metadata below)
   - Use Tailwind grid: `grid md:grid-cols-5 gap-6`

5. **Thumbnail section**:
   - Display thumbnail from /documents/:id/thumbnail
   - Add aspect-ratio wrapper for consistent sizing
   - Show "No thumbnail" placeholder if not generated
   - Secondary action buttons on thumbnail: View icon, Download icon

6. **Metadata panel with Tabs**:
   - Use Tabs component from components/tabs
   - **Overview tab** (default):
     - Filename
     - File size (formatted)
     - Page count (if available)
     - Date added (formatted)
     - Processing status badge
   - **Technical tab**:
     - Document ID (UUID)
     - Content hash (truncated with copy button optional)
     - Storage path info (optional, for debugging)
     - OCR status
     - Processing error (if any)

Template structure:
```templ
package admin

import (
    "docko/internal/database/sqlc"
    "docko/internal/meta"
    "docko/templates/layouts"
    "docko/components/tabs"
    "docko/components/breadcrumb"
    "fmt"
)

templ DocumentDetail(doc sqlc.Document) {
    @layouts.Admin(meta.New(doc.OriginalFilename, "Document details")) {
        // Breadcrumb
        // Header with buttons
        // Grid layout with thumbnail + tabs
    }
}
```

Use the existing formatFileSize function from documents.templ or duplicate it here.

For processing status, reuse the badge styling from the documents list or create a simple inline badge.
  </action>
  <verify>
```bash
cat ./tmp/air-combined.log | tail -50
```
Template compiles without errors. Check that tabs and breadcrumb imports are resolved.
  </verify>
  <done>
document_detail.templ exists with breadcrumb, header with buttons, side-by-side layout, thumbnail display, and tabbed metadata panels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DocumentDetail handler and route</name>
  <files>
    internal/handler/documents.go
    internal/handler/handler.go
  </files>
  <action>
Add DocumentDetail handler to documents.go:

```go
// DocumentDetail renders the document detail page
// GET /documents/:id
func (h *Handler) DocumentDetail(c echo.Context) error {
    ctx := c.Request().Context()

    docID, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return echo.NewHTTPError(http.StatusBadRequest, "invalid document ID")
    }

    doc, err := h.db.Queries.GetDocument(ctx, docID)
    if err != nil {
        if errors.Is(err, pgx.ErrNoRows) {
            return echo.NewHTTPError(http.StatusNotFound, "document not found")
        }
        return echo.NewHTTPError(http.StatusInternalServerError, "failed to fetch document")
    }

    return admin.DocumentDetail(doc).Render(ctx, c.Response().Writer)
}
```

Add import for admin templates if not already present:
```go
"docko/templates/pages/admin"
```

Add import for pgx errors:
```go
"github.com/jackc/pgx/v5"
"errors"
```

Register route in handler.go - IMPORTANT: This must come BEFORE the /documents/:id/view etc routes to avoid conflicts:

```go
// Document detail page (must be before /:id/* routes for correct matching)
e.GET("/documents/:id", h.DocumentDetail, middleware.RequireAuth(h.auth))
```

Actually, Echo handles this correctly based on specificity, so order may not matter. But to be safe, place the detail route in a logical position near other document routes.
  </action>
  <verify>
```bash
cat ./tmp/air-combined.log | tail -50
```
No compilation errors. Handler is registered.

Manual test: Navigate to /documents, find a document ID, then visit /documents/{id} - should see detail page.
  </verify>
  <done>
DocumentDetail handler exists and route is registered at /documents/:id. Page renders with document metadata.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build compiles without errors:
   ```bash
   cat ./tmp/air-combined.log | tail -30
   ```

2. Route exists at /documents/:id (not conflicting with /documents/:id/view etc.)

3. Navigate to a document detail page in browser:
   - Breadcrumb shows correct navigation
   - Thumbnail displays (or placeholder)
   - Tabs switch between Overview and Technical
   - Metadata is displayed correctly
   - View PDF button is present (non-functional until Plan 03)
   - Download button works (links to /documents/:id/download)
</verification>

<success_criteria>
- Document detail page renders at /documents/:id
- Breadcrumb navigation works correctly
- Side-by-side layout is responsive
- Tabs switch between Overview and Technical content
- Download button triggers file download with original filename
- Thumbnail displays if generated, placeholder otherwise
</success_criteria>

<output>
After completion, create `.planning/phases/04-viewing/04-02-SUMMARY.md`
</output>
