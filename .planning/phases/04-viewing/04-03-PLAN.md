---
phase: 04-viewing
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - templates/partials/pdf_viewer.templ
  - static/js/pdf-viewer.js
  - templates/layouts/admin.templ
  - internal/handler/documents.go
  - internal/handler/handler.go
  - templates/pages/admin/documents.templ
  - templates/pages/admin/document_detail.templ
autonomous: true

must_haves:
  truths:
    - "User can click View PDF to open modal overlay"
    - "PDF renders in modal with zoom and page navigation controls"
    - "Modal closes via button, Escape key, or backdrop click"
    - "Document list links to detail pages"
  artifacts:
    - path: "templates/partials/pdf_viewer.templ"
      provides: "PDF viewer modal template"
      min_lines: 50
    - path: "static/js/pdf-viewer.js"
      provides: "PDF.js initialization and controls"
      min_lines: 80
  key_links:
    - from: "templates/partials/pdf_viewer.templ"
      to: "components/dialog/dialog.templ"
      via: "templ import"
      pattern: "@dialog\\."
    - from: "static/js/pdf-viewer.js"
      to: "/documents/:id/view"
      via: "fetch PDF URL"
      pattern: "getDocument\\("
    - from: "templates/pages/admin/document_detail.templ"
      to: "templates/partials/pdf_viewer.templ"
      via: "hx-get for modal"
      pattern: "hx-get.*viewer"
---

<objective>
Create the PDF viewer modal with PDF.js rendering and wire up the document list to navigate to detail pages.

Purpose: Complete the viewing experience by enabling in-browser PDF viewing in a modal overlay with standard controls (zoom, page navigation, close, fullscreen).

Output: PDF viewer modal partial, JavaScript for PDF.js rendering, and wired-up navigation from document list to detail pages.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-viewing/04-CONTEXT.md
@.planning/phases/04-viewing/04-RESEARCH.md
@.planning/phases/04-viewing/04-01-SUMMARY.md
@.planning/phases/04-viewing/04-02-SUMMARY.md
@templates/partials/pdf_viewer.templ (if exists, for pattern reference)
@components/dialog/dialog.templ
@templates/pages/admin/documents.templ
@templates/pages/admin/document_detail.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF viewer JavaScript</name>
  <files>
    static/js/pdf-viewer.js
    templates/layouts/admin.templ
  </files>
  <action>
Create static/js/pdf-viewer.js with PDF.js initialization and controls:

```javascript
// PDF.js viewer for modal
// Uses PDF.js from CDN

// Initialize PDF.js library
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.worker.min.mjs';

// Viewer state
let pdfDoc = null;
let pageNum = 1;
let scale = 1.0;
let rendering = false;

// Load PDF document
async function loadPDF(url) {
    try {
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;

        document.getElementById('page-count').textContent = pdfDoc.numPages;
        document.getElementById('page-num').textContent = '1';

        pageNum = 1;
        scale = 1.0;
        await renderPage(pageNum);
    } catch (error) {
        console.error('Error loading PDF:', error);
        document.getElementById('pdf-loading').innerHTML =
            '<p class="text-destructive">Failed to load PDF</p>';
    }
}

// Render a page
async function renderPage(num) {
    if (rendering) return;
    rendering = true;

    try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale });

        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');

        // High-DPI support
        const outputScale = window.devicePixelRatio || 1;
        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);
        canvas.style.width = Math.floor(viewport.width) + 'px';
        canvas.style.height = Math.floor(viewport.height) + 'px';

        const transform = outputScale !== 1
            ? [outputScale, 0, 0, outputScale, 0, 0]
            : null;

        await page.render({
            canvasContext: ctx,
            transform: transform,
            viewport: viewport
        }).promise;

        document.getElementById('page-num').textContent = num;
        document.getElementById('pdf-loading').style.display = 'none';
        canvas.style.display = 'block';
    } finally {
        rendering = false;
    }
}

// Navigation
function prevPage() {
    if (pageNum <= 1 || !pdfDoc) return;
    pageNum--;
    renderPage(pageNum);
}

function nextPage() {
    if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
    pageNum++;
    renderPage(pageNum);
}

// Zoom
function zoomIn() {
    scale += 0.25;
    if (pdfDoc) renderPage(pageNum);
}

function zoomOut() {
    if (scale <= 0.5) return;
    scale -= 0.25;
    if (pdfDoc) renderPage(pageNum);
}

function resetZoom() {
    scale = 1.0;
    if (pdfDoc) renderPage(pageNum);
}

// Fullscreen
function toggleFullscreen() {
    const container = document.getElementById('pdf-viewer-container');
    if (!document.fullscreenElement) {
        container.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Close modal and cleanup
function closePDFViewer() {
    const modal = document.getElementById('pdf-viewer-modal');
    if (modal) {
        modal.remove();
    }
    pdfDoc = null;
    pageNum = 1;
    scale = 1.0;
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('pdf-viewer-modal');
    if (!modal) return;

    if (e.key === 'Escape') {
        closePDFViewer();
    } else if (e.key === 'ArrowLeft') {
        prevPage();
    } else if (e.key === 'ArrowRight') {
        nextPage();
    } else if (e.key === '+' || e.key === '=') {
        zoomIn();
    } else if (e.key === '-') {
        zoomOut();
    }
});
```

Add PDF.js CDN and pdf-viewer.js to templates/layouts/admin.templ in the head section:

```html
<script src="https://unpkg.com/pdfjs-dist@5.4.624/build/pdf.min.mjs" type="module"></script>
<script src="/static/js/pdf-viewer.js" defer></script>
```

Note: PDF.js 5.x uses ES modules. If CDN approach has issues, may need to use legacy build or host files locally.
  </action>
  <verify>
```bash
cat ./tmp/air-combined.log | tail -30
ls static/js/pdf-viewer.js
```
JavaScript file exists. Check browser console for any PDF.js loading errors.
  </verify>
  <done>
pdf-viewer.js exists with PDF.js initialization, page rendering, navigation, zoom, and keyboard shortcuts. CDN script tags added to admin layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PDF viewer modal template</name>
  <files>
    templates/partials/pdf_viewer.templ
    internal/handler/documents.go
    internal/handler/handler.go
  </files>
  <action>
Create templates/partials/pdf_viewer.templ:

```templ
package partials

import (
    "docko/internal/database/sqlc"
    "docko/components/dialog"
    "fmt"
)

templ PDFViewerModal(doc sqlc.Document) {
    // Modal backdrop and container
    <div id="pdf-viewer-modal" class="fixed inset-0 z-50 flex items-center justify-center">
        // Backdrop
        <div class="absolute inset-0 bg-black/80" onclick="closePDFViewer()"></div>

        // Modal content
        <div id="pdf-viewer-container" class="relative z-10 w-full max-w-5xl max-h-[90vh] bg-background rounded-lg shadow-xl flex flex-col">
            // Header with controls
            <div class="flex items-center justify-between p-4 border-b border-border">
                <h2 class="font-semibold truncate max-w-md" title={ doc.OriginalFilename }>
                    { doc.OriginalFilename }
                </h2>

                // Controls
                <div class="flex items-center gap-2">
                    // Page navigation
                    <div class="flex items-center gap-1 mr-4">
                        <button onclick="prevPage()" class="p-2 rounded hover:bg-accent" title="Previous page">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <span class="text-sm">
                            <span id="page-num">1</span> / <span id="page-count">-</span>
                        </span>
                        <button onclick="nextPage()" class="p-2 rounded hover:bg-accent" title="Next page">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>

                    // Zoom controls
                    <button onclick="zoomOut()" class="p-2 rounded hover:bg-accent" title="Zoom out">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                    </button>
                    <button onclick="resetZoom()" class="p-2 rounded hover:bg-accent text-sm" title="Reset zoom">
                        100%
                    </button>
                    <button onclick="zoomIn()" class="p-2 rounded hover:bg-accent" title="Zoom in">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>

                    // Fullscreen
                    <button onclick="toggleFullscreen()" class="p-2 rounded hover:bg-accent ml-2" title="Fullscreen">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>

                    // Close
                    <button onclick="closePDFViewer()" class="p-2 rounded hover:bg-accent ml-2" title="Close (Esc)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            // PDF canvas container
            <div class="flex-1 overflow-auto p-4 flex items-center justify-center bg-muted/30">
                <div id="pdf-loading" class="text-muted-foreground">
                    Loading PDF...
                </div>
                <canvas id="pdf-canvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>

    // Initialize PDF.js with document URL
    <script>
        loadPDF('/documents/' + '{ doc.ID.String() }' + '/view');
    </script>
}
```

Add handler for modal content in documents.go:

```go
// ViewerModal returns the PDF viewer modal HTML
// GET /documents/:id/viewer
func (h *Handler) ViewerModal(c echo.Context) error {
    ctx := c.Request().Context()

    docID, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return echo.NewHTTPError(http.StatusBadRequest, "invalid document ID")
    }

    doc, err := h.db.Queries.GetDocument(ctx, docID)
    if err != nil {
        return echo.NewHTTPError(http.StatusNotFound, "document not found")
    }

    return partials.PDFViewerModal(doc).Render(ctx, c.Response().Writer)
}
```

Register route in handler.go:
```go
e.GET("/documents/:id/viewer", h.ViewerModal, middleware.RequireAuth(h.auth))
```
  </action>
  <verify>
```bash
cat ./tmp/air-combined.log | tail -50
```
Template compiles. Handler registered.
  </verify>
  <done>
pdf_viewer.templ exists with modal structure, controls, and canvas. ViewerModal handler returns modal HTML via HTMX.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up navigation and View button</name>
  <files>
    templates/pages/admin/documents.templ
    templates/pages/admin/document_detail.templ
  </files>
  <action>
1. Update templates/pages/admin/documents.templ:
   - Make document filename a clickable link to /documents/:id
   - Keep the table row structure but wrap filename in anchor tag

Change this:
```templ
<span class="truncate max-w-xs" title={ doc.OriginalFilename }>
    { doc.OriginalFilename }
</span>
```

To this:
```templ
<a href={ templ.SafeURL("/documents/" + doc.ID.String()) }
   class="truncate max-w-xs hover:text-primary hover:underline"
   title={ doc.OriginalFilename }>
    { doc.OriginalFilename }
</a>
```

2. Update templates/pages/admin/document_detail.templ:
   - Add hx-get to the "View PDF" button to load modal:

```templ
<button
    class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90"
    hx-get={ "/documents/" + doc.ID.String() + "/viewer" }
    hx-target="body"
    hx-swap="beforeend">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
    </svg>
    View PDF
</button>
```

3. Also add thumbnail click to navigate to detail page (from CONTEXT.md: "Clicking thumbnail navigates to detail page"):
   - The thumbnail in the detail page should NOT trigger viewer
   - But if there's a thumbnail in a list view, it could link to detail

4. Add secondary View button on thumbnail in detail page if specified in CONTEXT.md:
   - Icon buttons on thumbnail hover

These wiring changes connect:
- Document list -> Detail page (via filename link)
- Detail page -> PDF viewer modal (via View button + HTMX)
- Detail page -> Download (via Download button link - already done in Plan 02)
  </action>
  <verify>
```bash
cat ./tmp/air-combined.log | tail -30
```
Templates compile without errors.

Manual verification flow:
1. Go to /documents
2. Click a document filename -> Should navigate to /documents/:id
3. On detail page, click "View PDF" -> Modal should appear with PDF
4. Modal controls work: page nav, zoom, close
5. Download button triggers download
  </verify>
  <done>
Document list filenames link to detail pages. Detail page View button opens PDF viewer modal via HTMX. Full viewing flow is functional.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build compiles without errors:
   ```bash
   cat ./tmp/air-combined.log | tail -30
   ```

2. Full user flow works:
   - Navigate to /documents
   - Click a document filename -> Detail page loads
   - Click "View PDF" -> Modal opens with PDF rendering
   - Use page navigation (arrows work)
   - Use zoom controls
   - Press Escape or click X -> Modal closes
   - Click "Download" -> File downloads with original filename

3. Check browser console for JavaScript errors during PDF loading

4. Verify responsive behavior:
   - Detail page layout adapts on mobile
   - Modal is usable on smaller screens
</verification>

<success_criteria>
- Document list links navigate to detail pages
- View PDF button opens modal via HTMX
- PDF.js renders PDF pages in canvas
- Page navigation (prev/next) works
- Zoom in/out/reset works
- Close via button, Escape, or backdrop click
- Fullscreen toggle works
- Keyboard shortcuts work (arrows, +/-, Esc)
- No console errors during normal operation
</success_criteria>

<output>
After completion, create `.planning/phases/04-viewing/04-03-SUMMARY.md`
</output>
