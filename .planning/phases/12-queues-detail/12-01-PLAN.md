---
phase: 12-queues-detail
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/011_job_dismissed.sql
  - sqlc/queries/jobs.sql
  - internal/database/sqlc/jobs.sql.go
  - internal/database/sqlc/models.go
autonomous: true

must_haves:
  truths:
    - "Jobs can be marked as dismissed without deletion"
    - "Dismissed jobs are excluded from failed jobs queries"
    - "Job queries return associated document name for display"
  artifacts:
    - path: "internal/database/migrations/011_job_dismissed.sql"
      provides: "Dismissed status enum value"
      contains: "dismissed"
    - path: "sqlc/queries/jobs.sql"
      provides: "Queue-specific job queries with document info"
      contains: "GetFailedJobsForQueue"
  key_links:
    - from: "sqlc/queries/jobs.sql"
      to: "documents table"
      via: "LEFT JOIN LATERAL on payload->>'document_id'"
      pattern: "LEFT JOIN LATERAL"
---

<objective>
Add "dismissed" job status and create queue-specific job queries with document information.

Purpose: Enable clearing failed jobs while preserving audit trail, and provide data for queue detail views.
Output: Migration adding dismissed status, new sqlc queries for queue-filtered job lists with document names.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/database/migrations/003_documents.sql
@sqlc/queries/jobs.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for dismissed status</name>
  <files>internal/database/migrations/011_job_dismissed.sql</files>
  <action>
Create goose migration to add 'dismissed' value to job_status enum:

```sql
-- +goose Up
ALTER TYPE job_status ADD VALUE 'dismissed' AFTER 'failed';

-- +goose Down
-- PostgreSQL does not support removing enum values
-- Would require recreating the enum and updating all references
-- This is intentionally left as a no-op for safety
```

This adds the dismissed status which will be used when users "clear" failed jobs. The dismissed status preserves the audit trail while removing jobs from active failed lists.
  </action>
  <verify>Check migration file exists and contains ALTER TYPE statement</verify>
  <done>Migration file 011_job_dismissed.sql created with dismissed enum value</done>
</task>

<task type="auto">
  <name>Task 2: Add queue-specific job queries with document info</name>
  <files>sqlc/queries/jobs.sql</files>
  <action>
Add the following queries to jobs.sql:

1. GetFailedJobsForQueue - Failed jobs for a specific queue with document info:
```sql
-- name: GetFailedJobsForQueue :many
SELECT
    j.*,
    d.id as document_id,
    d.original_filename as document_name
FROM jobs j
LEFT JOIN LATERAL (
    SELECT id, original_filename
    FROM documents
    WHERE id = (j.payload->>'document_id')::uuid
) d ON true
WHERE j.queue_name = $1 AND j.status = 'failed'
ORDER BY j.updated_at DESC
LIMIT $2 OFFSET $3;
```

2. GetRecentCompletedJobsForQueue - Completed jobs in last 24h for activity section:
```sql
-- name: GetRecentCompletedJobsForQueue :many
SELECT
    j.*,
    d.id as document_id,
    d.original_filename as document_name
FROM jobs j
LEFT JOIN LATERAL (
    SELECT id, original_filename
    FROM documents
    WHERE id = (j.payload->>'document_id')::uuid
) d ON true
WHERE j.queue_name = $1
    AND j.status = 'completed'
    AND j.completed_at > NOW() - INTERVAL '24 hours'
ORDER BY j.completed_at DESC
LIMIT $2 OFFSET $3;
```

3. DismissFailedJobsForQueue - Bulk clear (dismiss) failed jobs for a queue:
```sql
-- name: DismissFailedJobsForQueue :execrows
UPDATE jobs SET status = 'dismissed', updated_at = NOW()
WHERE queue_name = $1 AND status = 'failed';
```

4. DismissJob - Clear a single failed job:
```sql
-- name: DismissJob :one
UPDATE jobs SET status = 'dismissed', updated_at = NOW()
WHERE id = $1 AND status = 'failed'
RETURNING *;
```

5. ResetFailedJobsForQueue - Retry all failed jobs in a queue:
```sql
-- name: ResetFailedJobsForQueue :execrows
UPDATE jobs SET
    status = 'pending',
    attempt = 0,
    scheduled_at = NOW(),
    visible_until = NULL,
    last_error = NULL,
    updated_at = NOW()
WHERE queue_name = $1 AND status = 'failed';
```

6. GetQueueNames - Get distinct queue names for iteration:
```sql
-- name: GetQueueNames :many
SELECT DISTINCT queue_name FROM jobs ORDER BY queue_name;
```

Note: LEFT JOIN LATERAL is used to safely handle jobs that may not have a document_id in their payload (e.g., non-document jobs) or where the document has been deleted.
  </action>
  <verify>Run `make generate` and check ./tmp/air-combined.log for errors. Verify new queries appear in internal/database/sqlc/jobs.sql.go</verify>
  <done>Six new sqlc queries added for queue detail views with document info</done>
</task>

</tasks>

<verification>
1. Migration file exists at internal/database/migrations/011_job_dismissed.sql
2. `make generate` completes without errors
3. New query functions exist in internal/database/sqlc/jobs.sql.go:
   - GetFailedJobsForQueue
   - GetRecentCompletedJobsForQueue
   - DismissFailedJobsForQueue
   - DismissJob
   - ResetFailedJobsForQueue
   - GetQueueNames
4. JobStatus enum in models.go includes JobStatusDismissed
</verification>

<success_criteria>
- Migration adds 'dismissed' to job_status enum
- All 6 new queries compile and generate without errors
- LEFT JOIN LATERAL pattern correctly extracts document_id from JSONB payload
</success_criteria>

<output>
After completion, create `.planning/phases/12-queues-detail/12-01-SUMMARY.md`
</output>
