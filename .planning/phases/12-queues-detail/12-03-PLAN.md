---
phase: 12-queues-detail
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - internal/handler/ai.go
  - internal/handler/handler.go
autonomous: true

must_haves:
  truths:
    - "Handler returns failed jobs with document names for a queue"
    - "Handler returns recent completed jobs for a queue"
    - "Single job retry works instantly (no confirmation)"
    - "Bulk retry/clear operations return count affected"
  artifacts:
    - path: "internal/handler/ai.go"
      provides: "Queue detail handlers"
      contains: "QueueDetails"
  key_links:
    - from: "internal/handler/ai.go"
      to: "internal/database/sqlc"
      via: "GetFailedJobsForQueue query"
      pattern: "GetFailedJobsForQueue"
    - from: "templates/pages/admin/queue_detail.templ (Plan 12-04)"
      to: "/queues/jobs/:id/retry (existing from Phase 8)"
      via: "hx-post for single job retry"
      note: "Route already exists - do not re-add"
---

<objective>
Create handler endpoints for queue detail views with lazy loading and job actions.

Purpose: Provide API endpoints for loading queue details, retrying jobs, and clearing failed jobs.
Output: New handler methods and route registrations for queue detail functionality.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-queues-detail/12-01-SUMMARY.md
@internal/handler/ai.go
@internal/handler/handler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add queue detail handler methods</name>
  <files>internal/handler/ai.go</files>
  <action>
Add the following handler methods to ai.go (where queue handlers already exist):

1. QueueDetails - Lazy load queue detail content:
```go
// QueueDetails returns the expanded content for a queue section
// Called via HTMX lazy loading when user expands a queue
func (h *Handler) QueueDetails(c echo.Context) error {
    ctx := c.Request().Context()
    queueName := c.Param("name")

    // Get failed jobs with document info (limit 20)
    failedJobs, err := h.db.Queries.GetFailedJobsForQueue(ctx, sqlc.GetFailedJobsForQueueParams{
        QueueName: queueName,
        Limit:     20,
        Offset:    0,
    })
    if err != nil {
        failedJobs = []sqlc.GetFailedJobsForQueueRow{}
    }

    // Get recent completed jobs (last 24h, limit 20)
    recentJobs, err := h.db.Queries.GetRecentCompletedJobsForQueue(ctx, sqlc.GetRecentCompletedJobsForQueueParams{
        QueueName: queueName,
        Limit:     20,
        Offset:    0,
    })
    if err != nil {
        recentJobs = []sqlc.GetRecentCompletedJobsForQueueRow{}
    }

    return admin.QueueDetailContent(queueName, failedJobs, recentJobs).Render(ctx, c.Response().Writer)
}
```

2. DismissJob - Clear single failed job (no confirmation):
```go
// DismissJob marks a single failed job as dismissed
func (h *Handler) DismissJob(c echo.Context) error {
    ctx := c.Request().Context()

    jobID, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return echo.NewHTTPError(http.StatusBadRequest, "invalid job id")
    }

    _, err = h.db.Queries.DismissJob(ctx, jobID)
    if err != nil {
        c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "Failed to dismiss job", "type": "error"}}`)
        return c.NoContent(http.StatusInternalServerError)
    }

    c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "Job dismissed", "type": "success"}}`)
    // Return empty string to remove the row via outerHTML swap
    return c.String(http.StatusOK, "")
}
```

3. RetryQueueJobs - Bulk retry all failed jobs in queue:
```go
// RetryQueueJobs retries all failed jobs in a specific queue
func (h *Handler) RetryQueueJobs(c echo.Context) error {
    ctx := c.Request().Context()
    queueName := c.Param("name")

    count, err := h.db.Queries.ResetFailedJobsForQueue(ctx, queueName)
    if err != nil {
        c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "Failed to retry jobs", "type": "error"}}`)
        return c.NoContent(http.StatusInternalServerError)
    }

    msg := fmt.Sprintf("%d job(s) queued for retry", count)
    c.Response().Header().Set("HX-Trigger", fmt.Sprintf(`{"showToast": {"message": "%s", "type": "success"}}`, msg))
    return c.Redirect(http.StatusSeeOther, "/queues")
}
```

4. ClearQueueJobs - Bulk dismiss all failed jobs in queue:
```go
// ClearQueueJobs dismisses all failed jobs in a specific queue
func (h *Handler) ClearQueueJobs(c echo.Context) error {
    ctx := c.Request().Context()
    queueName := c.Param("name")

    count, err := h.db.Queries.DismissFailedJobsForQueue(ctx, queueName)
    if err != nil {
        c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "Failed to clear jobs", "type": "error"}}`)
        return c.NoContent(http.StatusInternalServerError)
    }

    msg := fmt.Sprintf("%d job(s) dismissed", count)
    c.Response().Header().Set("HX-Trigger", fmt.Sprintf(`{"showToast": {"message": "%s", "type": "success"}}`, msg))
    return c.Redirect(http.StatusSeeOther, "/queues")
}
```

Note: The template `admin.QueueDetailContent` will be created in Plan 04.
  </action>
  <verify>Check ./tmp/air-combined.log for compilation errors (will show template not found until Plan 04)</verify>
  <done>Four new handler methods added: QueueDetails, DismissJob, RetryQueueJobs, ClearQueueJobs</done>
</task>

<task type="auto">
  <name>Task 2: Register new routes</name>
  <files>internal/handler/handler.go</files>
  <action>
Add the following routes in the queue section (after existing /queues routes):

```go
// Queue detail routes
e.GET("/queues/:name/details", h.QueueDetails, middleware.RequireAuth(h.auth))
e.POST("/queues/:name/retry-all", h.RetryQueueJobs, middleware.RequireAuth(h.auth))
e.POST("/queues/:name/clear-all", h.ClearQueueJobs, middleware.RequireAuth(h.auth))
e.POST("/queues/jobs/:id/dismiss", h.DismissJob, middleware.RequireAuth(h.auth))
```

**Note:** The route `POST /queues/jobs/:id/retry` with handler `RetryJob` already exists from Phase 8 (AI Integration). This route is used by Plan 12-04's `failedJobRow` template for single job retry. Do NOT add it again.

These routes follow existing patterns:
- GET for lazy-loaded content
- POST for actions (retry, dismiss, clear)
- :name parameter for queue-specific operations
- :id parameter for job-specific operations
  </action>
  <verify>Check that routes are added after existing /queues routes in handler.go</verify>
  <done>Four new routes registered for queue detail functionality</done>
</task>

</tasks>

<verification>
1. Four new handler methods in ai.go:
   - QueueDetails
   - DismissJob
   - RetryQueueJobs
   - ClearQueueJobs
2. Four new routes in handler.go registered with RequireAuth middleware
3. Handlers use correct sqlc query method names from Plan 01
4. Toast feedback pattern matches existing (HX-Trigger showToast)
5. **Note:** QueueDetails handler references `admin.QueueDetailContent` which is created in Plan 12-04. Full compilation verification should occur after Plan 12-04 completes.
</verification>

<success_criteria>
- All handlers compile (template import will be added in Plan 04)
- Routes follow existing naming conventions (/queues/:name/action)
- HTMX toast feedback for all actions
- outerHTML swap pattern for single job dismiss (returns empty string)
</success_criteria>

<output>
After completion, create `.planning/phases/12-queues-detail/12-03-SUMMARY.md`
</output>
