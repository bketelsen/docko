---
phase: 09-minimum-words
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - internal/processing/processor.go
  - internal/handler/ai.go
  - templates/pages/admin/ai_settings.templ
autonomous: true

must_haves:
  truths:
    - "Documents with word count below threshold are quarantined"
    - "Documents with 0 threshold pass through regardless of word count"
    - "Admin can set min_word_count via AI settings form"
    - "Quarantine message shows actual word count and required minimum"
  artifacts:
    - path: "internal/processing/processor.go"
      provides: "Word count validation after text extraction"
      contains: "strings.Fields"
    - path: "internal/handler/ai.go"
      provides: "Handler parsing min_word_count form field"
      contains: "min_word_count"
    - path: "templates/pages/admin/ai_settings.templ"
      provides: "Min word count input field in settings form"
      contains: "min_word_count"
  key_links:
    - from: "internal/processing/processor.go"
      to: "GetAISettings query"
      via: "p.db.Queries.GetAISettings"
      pattern: "GetAISettings.*MinWordCount"
    - from: "internal/handler/ai.go"
      to: "UpdateAISettings query"
      via: "h.aiSvc.UpdateSettings"
      pattern: "MinWordCount.*int32"
---

<objective>
Implement word count validation in processor and add UI for threshold configuration

Purpose: Block documents with insufficient text content, configurable by admin
Output: Working word count filter with UI control
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-minimum-number-of-words-import-block/09-RESEARCH.md
@.planning/phases/09-minimum-number-of-words-import-block/09-01-SUMMARY.md

@internal/processing/processor.go
@internal/handler/ai.go
@templates/pages/admin/ai_settings.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add word count validation to processor</name>
  <files>internal/processing/processor.go</files>
  <action>
Add word count check in HandleJob AFTER text extraction succeeds, BEFORE thumbnail generation.

Import `strings` package at top of file.

After the text extraction success logging (around line 100), add:

```go
// Check minimum word count threshold
settings, err := p.db.Queries.GetAISettings(ctx)
if err != nil {
    slog.Warn("failed to get ai settings for word count check", "error", err)
    // Continue processing - don't block on settings fetch failure
} else if settings.MinWordCount > 0 {
    wordCount := len(strings.Fields(text))
    if wordCount < int(settings.MinWordCount) {
        reason := fmt.Sprintf("document has %d words (minimum required: %d)",
            wordCount, settings.MinWordCount)
        return p.quarantine(ctx, docID, reason)
    }
}
```

Key decisions:
- Check AFTER text extraction (we need the text to count words)
- Check BEFORE thumbnail generation (don't waste work on rejected docs)
- 0 threshold = disabled (skip check entirely)
- Settings fetch failure = continue processing (non-blocking)
- Use strings.Fields (handles all Unicode whitespace correctly)
- Quarantine returns nil so job completes successfully
  </action>
  <verify>
Check ./tmp/air-combined.log for compilation errors.
Verify `strings` import is present.
Verify the word count check appears between text extraction and thumbnail generation.
  </verify>
  <done>
- strings package imported
- Word count check added after text extraction
- Check uses settings.MinWordCount threshold
- Documents below threshold are quarantined with descriptive message
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AI settings handler to accept min_word_count</name>
  <files>internal/handler/ai.go</files>
  <action>
Update UpdateAISettings handler to parse and pass min_word_count form value.

In UpdateAISettings function:

1. Add form value parsing after reviewThresholdStr:
```go
minWordCountStr := c.FormValue("min_word_count")
```

2. Add parsing with validation:
```go
minWordCount, err := strconv.Atoi(minWordCountStr)
if err != nil || minWordCount < 0 || minWordCount > 10000 {
    minWordCount = 0 // Default to disabled
}
```

3. Update the UpdateSettings call to include MinWordCount:
```go
_, err = h.aiSvc.UpdateSettings(ctx, sqlc.UpdateAISettingsParams{
    PreferredProvider:  preferred,
    MaxPages:           int32(maxPages),
    AutoProcess:        autoProcess,
    AutoApplyThreshold: numericFromFloat(autoApplyThreshold),
    ReviewThreshold:    numericFromFloat(reviewThreshold),
    MinWordCount:       int32(minWordCount),
})
```

Validation bounds:
- Min: 0 (disabled)
- Max: 10000 (reasonable upper limit)
- Invalid input defaults to 0 (disabled)
  </action>
  <verify>
Check ./tmp/air-combined.log for compilation errors.
Verify the handler parses min_word_count and passes it to UpdateSettings.
  </verify>
  <done>
- min_word_count form value parsed
- Validation: 0-10000 range, defaults to 0 on error
- MinWordCount passed to UpdateAISettingsParams
  </done>
</task>

<task type="auto">
  <name>Task 3: Add min_word_count input to AI settings form</name>
  <files>templates/pages/admin/ai_settings.templ</files>
  <action>
Add min_word_count input field to the AI settings form, after the "Auto Process Toggle" section (before the submit button).

Add this form section:

```templ
<!-- Minimum Word Count -->
<div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Minimum Word Count
    </label>
    <input
        type="number"
        name="min_word_count"
        min="0"
        max="10000"
        value={ strconv.Itoa(int(settings.MinWordCount)) }
        class="w-32 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100"
    />
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Documents with fewer words are rejected during processing. Set to 0 to disable.
    </p>
</div>
```

Place this AFTER the auto_process checkbox section and BEFORE the submit button `<div class="pt-4">`.

The strconv import is already present in the file (used by other fields).
  </action>
  <verify>
Run `make generate` to regenerate templ files.
Check ./tmp/air-combined.log for errors.
Visit http://localhost:3000/ai and verify:
- Min word count input appears in the form
- Current value displays (should be 0)
- Help text explains the field
  </verify>
  <done>
- Min word count input field added to AI settings form
- Input has min=0, max=10000 constraints
- Help text explains 0 = disabled
- Value displays current setting from database
  </done>
</task>

</tasks>

<verification>
1. Upload a PDF with minimal text (e.g., image-only PDF)
2. Set min_word_count to 50 via /ai settings
3. Upload another minimal-text PDF
4. Verify it gets quarantined with message "document has X words (minimum required: 50)"
5. Set min_word_count back to 0
6. Upload same PDF type - should process successfully

Alternative verification without test PDFs:
- Check processor.go has word count check code
- Check handler parses and passes MinWordCount
- Check template has min_word_count input
- Check database setting can be updated via UI
</verification>

<success_criteria>
- Documents below word threshold are quarantined during processing
- Quarantine message includes actual word count and required minimum
- Admin can configure threshold via AI settings page
- Threshold of 0 disables the check (all documents pass)
- Feature works for all ingestion sources (upload, inbox, network)
</success_criteria>

<output>
After completion, create `.planning/phases/09-minimum-number-of-words-import-block/09-02-SUMMARY.md`
</output>
