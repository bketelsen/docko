---
phase: 09-minimum-words
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/010_min_word_count.sql
  - sqlc/queries/ai.sql
  - internal/database/sqlc/models.go
  - internal/database/sqlc/ai.sql.go
autonomous: true

must_haves:
  truths:
    - "min_word_count column exists in ai_settings table"
    - "GetAISettings query returns MinWordCount field"
    - "UpdateAISettings accepts min_word_count parameter"
  artifacts:
    - path: "internal/database/migrations/010_min_word_count.sql"
      provides: "Migration adding min_word_count column"
      contains: "min_word_count INTEGER"
    - path: "sqlc/queries/ai.sql"
      provides: "Updated AI settings queries"
      contains: "min_word_count = $"
  key_links:
    - from: "internal/database/sqlc/models.go"
      to: "ai_settings table"
      via: "AiSetting struct"
      pattern: "MinWordCount\\s+int32"
---

<objective>
Add min_word_count column to ai_settings table and update sqlc queries

Purpose: Database foundation for configurable word count threshold
Output: Migration file, updated sqlc queries, regenerated Go types
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-minimum-number-of-words-import-block/09-RESEARCH.md

@internal/database/migrations/009_ai_integration.sql
@sqlc/queries/ai.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for min_word_count</name>
  <files>internal/database/migrations/010_min_word_count.sql</files>
  <action>
Create migration file that:
1. Adds `min_word_count INTEGER NOT NULL DEFAULT 0` to ai_settings table
2. 0 = disabled (no minimum enforced) - this is the default behavior
3. Use standard goose format with +goose Up and +goose Down sections

The column stores the minimum number of words required in extracted text. Documents below this threshold will be quarantined during processing.

Migration follows existing pattern from 009_ai_integration.sql (ALTER TABLE on ai_settings).
  </action>
  <verify>
Check migration syntax is valid SQL:
- Has +goose Up section with ALTER TABLE ADD COLUMN
- Has +goose Down section with ALTER TABLE DROP COLUMN
- Uses INTEGER type with NOT NULL DEFAULT 0
  </verify>
  <done>Migration file exists with correct SQL syntax for adding min_word_count column</done>
</task>

<task type="auto">
  <name>Task 2: Update sqlc queries for min_word_count</name>
  <files>sqlc/queries/ai.sql</files>
  <action>
Update the UpdateAISettings query to include min_word_count as parameter $6:

```sql
-- name: UpdateAISettings :one
UPDATE ai_settings SET
    preferred_provider = $1,
    max_pages = $2,
    auto_process = $3,
    auto_apply_threshold = $4,
    review_threshold = $5,
    min_word_count = $6,
    updated_at = NOW()
WHERE id = 1
RETURNING *;
```

GetAISettings query already uses `SELECT *` so it will automatically include the new column once migration runs.
  </action>
  <verify>
Run `make generate` to regenerate sqlc types. Check:
- ./tmp/air-combined.log for any errors
- internal/database/sqlc/models.go contains MinWordCount field in AiSetting struct
- internal/database/sqlc/ai.sql.go has UpdateAISettingsParams with MinWordCount field
  </verify>
  <done>
- UpdateAISettings query includes min_word_count parameter
- sqlc generates UpdateAISettingsParams with MinWordCount int32 field
- AiSetting struct includes MinWordCount int32 field
  </done>
</task>

<task type="auto">
  <name>Task 3: Run migration and verify schema</name>
  <files>None (verification only)</files>
  <action>
Run the application to trigger automatic migration, then verify the schema was applied correctly.

Steps:
1. Ensure docker-compose is running (postgres)
2. Run `make dev` briefly to trigger migrations (or use make migrate)
3. Verify the column exists in database

Use psql or database query to confirm:
```sql
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'ai_settings' AND column_name = 'min_word_count';
```

Expected result: min_word_count column exists with type integer and default 0.
  </action>
  <verify>
Query ai_settings table to confirm:
- min_word_count column exists
- Default value is 0
- Existing row has min_word_count = 0
  </verify>
  <done>Database schema updated with min_word_count column, default value confirmed as 0</done>
</task>

</tasks>

<verification>
1. Migration file exists at internal/database/migrations/010_min_word_count.sql
2. sqlc/queries/ai.sql contains min_word_count in UpdateAISettings
3. Generated code includes MinWordCount field in structs
4. Database has min_word_count column with default 0
</verification>

<success_criteria>
- Database migration runs without errors
- sqlc generates MinWordCount field in AiSetting and UpdateAISettingsParams
- Existing ai_settings row has min_word_count = 0
</success_criteria>

<output>
After completion, create `.planning/phases/09-minimum-number-of-words-import-block/09-01-SUMMARY.md`
</output>
