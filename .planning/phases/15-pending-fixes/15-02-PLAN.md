---
phase: 15-pending-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/handler/inboxes.go
  - templates/pages/admin/inboxes.templ
autonomous: true

must_haves:
  truths:
    - "Inbox cards show error count when error files exist"
    - "Error count badge only appears when count is greater than zero"
    - "Error path is correctly resolved whether custom or default"
  artifacts:
    - path: "internal/handler/inboxes.go"
      provides: "Error count calculation for each inbox"
      contains: "ErrorCount"
    - path: "templates/pages/admin/inboxes.templ"
      provides: "Error count badge in inbox cards"
      contains: "ErrorCount"
  key_links:
    - from: "internal/handler/inboxes.go"
      to: "templates/pages/admin/inboxes.templ"
      via: "InboxWithErrorCount struct"
      pattern: "InboxWithErrorCount"
---

<objective>
Add error file count badges to inbox cards, giving users visibility into failed imports.

Purpose: Users currently have no way to know if files have been moved to error directories. Showing a count helps them identify and address import issues.

Output: Inbox cards display a badge with the count of PDF files in the error directory.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pending-fixes/15-RESEARCH.md
@internal/handler/inboxes.go
@templates/pages/admin/inboxes.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error count calculation to inbox handler</name>
  <files>internal/handler/inboxes.go</files>
  <action>
    1. Add a new type to wrap inbox with error count:
       ```go
       // InboxWithErrorCount extends inbox with error file count
       type InboxWithErrorCount struct {
           Inbox      sqlc.Inbox
           ErrorCount int
       }
       ```

    2. Add a helper function to count PDF files in a directory:
       ```go
       // countPDFsInDir counts .pdf files in a directory
       func countPDFsInDir(dir string) int {
           entries, err := os.ReadDir(dir)
           if err != nil {
               return 0 // Directory doesn't exist or can't be read
           }
           count := 0
           for _, e := range entries {
               if !e.IsDir() && strings.HasSuffix(strings.ToLower(e.Name()), ".pdf") {
                   count++
               }
           }
           return count
       }
       ```

    3. Add a helper to resolve error path (custom or default):
       ```go
       // resolveErrorPath returns the error directory path for an inbox
       func resolveErrorPath(inbox sqlc.Inbox) string {
           if inbox.ErrorPath != nil && *inbox.ErrorPath != "" {
               return *inbox.ErrorPath
           }
           return filepath.Join(inbox.Path, "errors")
       }
       ```

    4. Modify InboxesPage handler to calculate error counts:
       ```go
       func (h *Handler) InboxesPage(c echo.Context) error {
           ctx := c.Request().Context()

           inboxes, err := h.db.Queries.ListInboxes(ctx)
           if err != nil {
               slog.Error("failed to list inboxes", "error", err)
               return c.String(http.StatusInternalServerError, "Failed to load inboxes")
           }

           // Add error counts for each inbox
           inboxesWithCounts := make([]InboxWithErrorCount, len(inboxes))
           for i, inbox := range inboxes {
               errorPath := resolveErrorPath(inbox)
               inboxesWithCounts[i] = InboxWithErrorCount{
                   Inbox:      inbox,
                   ErrorCount: countPDFsInDir(errorPath),
               }
           }

           return admin.InboxesWithCounts(inboxesWithCounts).Render(ctx, c.Response().Writer)
       }
       ```

    5. Add import for "path/filepath" and "strings" if not already present.
  </action>
  <verify>
    - Check `./tmp/air-combined.log` for compilation errors
    - Verify helper functions: `grep -c "countPDFsInDir\|resolveErrorPath" internal/handler/inboxes.go`
  </verify>
  <done>Handler calculates error count for each inbox and passes InboxWithErrorCount to template</done>
</task>

<task type="auto">
  <name>Task 2: Add error count badge to inbox template</name>
  <files>templates/pages/admin/inboxes.templ</files>
  <action>
    1. Add import for handler package to access InboxWithErrorCount:
       ```go
       import "docko/internal/handler"
       ```

    2. Create a new template function that accepts []handler.InboxWithErrorCount:
       ```templ
       templ InboxesWithCounts(inboxes []handler.InboxWithErrorCount) {
           @layouts.Admin(meta.New("Inbox Management", "Configure inbox directories for automatic document import")) {
               // Same header content as Inboxes()
               ...
               <!-- Inbox List -->
               <div id="inbox-list" class="space-y-4">
                   if len(inboxes) == 0 {
                       // Same empty state
                   } else {
                       for _, item := range inboxes {
                           @InboxCardWithErrors(item)
                       }
                   }
               </div>
           }
       }
       ```

    3. Create InboxCardWithErrors template that shows error badge:
       ```templ
       templ InboxCardWithErrors(item handler.InboxWithErrorCount) {
           <div id={ fmt.Sprintf("inbox-%s", item.Inbox.ID.String()) } class="border border-border rounded-lg p-6 bg-card">
               <div class="flex items-start justify-between">
                   <div>
                       <h3 class="font-semibold text-lg text-card-foreground flex items-center gap-2">
                           { item.Inbox.Name }
                           if item.ErrorCount > 0 {
                               <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-destructive text-destructive-foreground">
                                   { fmt.Sprintf("%d error(s)", item.ErrorCount) }
                               </span>
                           }
                       </h3>
                       // Rest of card content uses item.Inbox instead of inbox
                       ...
                   </div>
               </div>
           </div>
       }
       ```

    4. Keep the original InboxCard template for HTMX responses (CreateInbox, UpdateInbox return InboxCard).
       The InboxCard doesn't need error counts since those are calculated on page load.

    5. Update error path display in card to show the resolved path and error count:
       ```templ
       <p class="text-sm text-muted-foreground flex items-center gap-2">
           <span class="font-medium">Errors:</span>
           { resolvedErrorPath(item.Inbox) }
           if item.ErrorCount > 0 {
               <span class="text-destructive">({ strconv.Itoa(item.ErrorCount) } files)</span>
           }
       </p>
       ```

    6. Add helper function for resolved error path in template:
       ```go
       func resolvedErrorPath(inbox sqlc.Inbox) string {
           if inbox.ErrorPath != nil && *inbox.ErrorPath != "" {
               return *inbox.ErrorPath
           }
           return inbox.Path + "/errors"
       }
       ```
  </action>
  <verify>
    - Run `make generate` to regenerate templ code
    - Check `./tmp/air-combined.log` for compilation errors
    - Verify template functions exist: `grep -c "InboxesWithCounts\|InboxCardWithErrors" templates/pages/admin/inboxes.templ`
  </verify>
  <done>Inbox cards display error count badge when error files exist</done>
</task>

</tasks>

<verification>
1. Check build logs: `cat ./tmp/air-combined.log` - no errors
2. Verify code changes:
   - `grep -c "InboxWithErrorCount" internal/handler/inboxes.go` returns >= 1
   - `grep -c "countPDFsInDir" internal/handler/inboxes.go` returns >= 1
   - `grep -c "InboxesWithCounts" templates/pages/admin/inboxes.templ` returns >= 1
3. Run tests: `make test`
</verification>

<success_criteria>
- Handler calculates error count for each inbox on page load
- Inbox cards show error badge when count > 0
- Error badge does not appear when count is 0
- Application compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-pending-fixes/15-02-SUMMARY.md`
</output>
