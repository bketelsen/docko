---
phase: 15-pending-fixes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/partials/document_status.templ
  - internal/handler/status.go
  - static/js/upload.js
  - templates/pages/admin/upload.templ
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Upload page shows processing step during document processing"
    - "Processing status displays current step (extracting_text, generating_thumbnail, etc.)"
    - "Status updates in real-time via SSE"
  artifacts:
    - path: "templates/partials/document_status.templ"
      provides: "Step display in processing status badge"
      contains: "currentStep"
    - path: "internal/handler/status.go"
      provides: "CurrentStep passed to partial"
      contains: "update.CurrentStep"
    - path: "static/js/upload.js"
      provides: "SSE subscription for processing status"
      contains: "EventSource"
    - path: "templates/pages/admin/upload.templ"
      provides: "Container for SSE status updates"
      contains: "sse-connect"
  key_links:
    - from: "upload.js"
      to: "/api/processing/status"
      via: "EventSource SSE subscription"
    - from: "status.go SSE handler"
      to: "DocumentStatus partial"
      via: "update.CurrentStep parameter"
    - from: "DocumentStatus partial"
      to: "status badge"
      via: "currentStep display in processing state"
---

<objective>
Make processing step visible on upload page during document processing.

Purpose: User reported seeing only "Done" toast without step progression. The SSE infrastructure exists but: (1) upload.js doesn't subscribe to SSE events, (2) status.go drops CurrentStep when calling partial, (3) DocumentStatus partial has no step parameter or UI.

Output: Upload page shows real-time processing step (extracting_text -> generating_thumbnail -> finalizing) during document processing.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pending-fixes/15-UAT.md
@templates/partials/document_status.templ
@internal/handler/status.go
@static/js/upload.js
@templates/pages/admin/upload.templ
@templates/pages/admin/documents.templ (for SSE pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add currentStep parameter to DocumentStatus partial</name>
  <files>templates/partials/document_status.templ</files>
  <action>
    Update DocumentStatus to accept currentStep as 4th parameter:
    ```go
    templ DocumentStatus(docID string, status string, errorMsg string, currentStep string) {
    ```

    In the "processing" status case, display the current step:
    ```templ
    } else if status == "processing" {
      @badge.Badge(badge.Props{Variant: badge.VariantDefault, Class: "animate-pulse"}) {
        if currentStep != "" {
          { formatStep(currentStep) }
        } else {
          Processing...
        }
      }
    }
    ```

    Add a helper function to format step names for display:
    ```go
    func formatStep(step string) string {
      switch step {
      case "starting":
        return "Starting..."
      case "extracting_text":
        return "Extracting text..."
      case "generating_thumbnail":
        return "Generating thumbnail..."
      case "finalizing":
        return "Finalizing..."
      default:
        return "Processing..."
      }
    }
    ```
  </action>
  <verify>Check ./tmp/air-combined.log for template generation errors</verify>
  <done>DocumentStatus partial accepts and displays currentStep parameter</done>
</task>

<task type="auto">
  <name>Task 2: Pass CurrentStep from SSE handler to partial</name>
  <files>internal/handler/status.go</files>
  <action>
    Around line 74-78, update the partials.DocumentStatus call to include CurrentStep:
    ```go
    if err := partials.DocumentStatus(
      update.DocumentID.String(),
      update.Status,
      update.Error,
      update.CurrentStep,  // Add this parameter
    ).Render(ctx, &buf); err != nil {
    ```

    This passes the step through to the partial so SSE updates include it.
  </action>
  <verify>Check ./tmp/air-combined.log for compilation errors</verify>
  <done>SSE handler passes CurrentStep to DocumentStatus partial</done>
</task>

<task type="auto">
  <name>Task 3: Add SSE status tracking to upload page</name>
  <files>
    templates/pages/admin/upload.templ
    static/js/upload.js
  </files>
  <action>
    In upload.templ, add a processing status container with SSE connection AFTER the progress container:
    ```templ
    <!-- Processing Status Container (for SSE updates after upload) -->
    <div id="processing-status" class="space-y-3 mt-6" hx-ext="sse" sse-connect="/api/processing/status" sse-close="close">
      <!-- Document status updates will be swapped here via SSE -->
    </div>
    ```

    In upload.js, after a successful upload (in the xhr.onload handler where success is true), add a status tracking element that receives SSE updates:
    ```javascript
    // After upload succeeds, add a status tracker for this document
    if (success && !isDuplicate && result.document_id) {
      addProcessingTracker(result.document_id, file.name);
    }
    ```

    Add the addProcessingTracker function:
    ```javascript
    /**
     * Add a processing status tracker for a document
     * @param {string} docId - Document ID
     * @param {string} filename - Original filename
     */
    function addProcessingTracker(docId, filename) {
      const statusContainer = document.getElementById('processing-status');
      if (!statusContainer) return;

      // Create status entry that receives SSE updates
      const entry = document.createElement('div');
      entry.className = 'border border-border rounded-lg p-4 flex items-center justify-between';
      entry.innerHTML = `
        <span class="font-medium truncate mr-4">${escapeHtml(filename)}</span>
        <div sse-swap="doc-${docId}" hx-swap="innerHTML">
          <span class="text-sm text-muted-foreground animate-pulse">Queued for processing...</span>
        </div>
      `;
      statusContainer.appendChild(entry);

      // Process HTMX attributes for the new element
      if (window.htmx) {
        htmx.process(entry);
      }
    }
    ```

    The SSE events for "doc-{id}" will swap in the DocumentStatus partial content.
  </action>
  <verify>
    1. Check ./tmp/air-combined.log for errors
    2. Upload a PDF, observe processing status container shows document with step progression
  </verify>
  <done>Upload page shows real-time processing status with step names</done>
</task>

</tasks>

<verification>
1. All files compile without errors (check ./tmp/air-combined.log)
2. Upload a new PDF via /upload
3. After upload completes, observe:
   - Processing status container appears with document
   - Status shows step progression: "Starting..." -> "Extracting text..." -> "Generating thumbnail..." -> "Finalizing..." -> "Complete"
4. Verify SSE connection in browser Network tab (should see /api/processing/status EventStream)
</verification>

<success_criteria>
- Upload page displays processing status for newly uploaded documents
- Status badge shows current processing step (not just "Processing...")
- Steps update in real-time via SSE
- Status transitions to "Complete" when processing finishes
</success_criteria>

<output>
After completion, create `.planning/phases/15-pending-fixes/15-05-SUMMARY.md`
</output>
