---
phase: 15-pending-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/pages/admin/tags.templ
  - templates/pages/admin/correspondents.templ
autonomous: true

must_haves:
  truths:
    - "Tags page edit button opens the edit form with correct values"
    - "Correspondents page edit button opens the edit form with correct values"
  artifacts:
    - path: "templates/pages/admin/tags.templ"
      provides: "Fixed edit button onclick handler"
      contains: "templ.JSFuncCall"
    - path: "templates/pages/admin/correspondents.templ"
      provides: "Fixed edit button onclick handler"
      contains: "templ.JSFuncCall"
  key_links:
    - from: "templates/pages/admin/tags.templ"
      to: "openEditMode JavaScript function"
      via: "templ.JSFuncCall onclick attribute"
      pattern: "templ\\.JSFuncCall.*openEditMode"
---

<objective>
Fix edit buttons on Tags and Correspondents pages that fail silently due to templ script block JSON serialization issues.

Purpose: Edit buttons currently do nothing when clicked because templ's script directive serializes Go structs to JSON with lowercase keys, but JavaScript references uppercase property names. Additionally, uuid.UUID types serialize as byte arrays instead of strings.

Output: Working edit buttons that correctly populate the edit form with tag/correspondent data.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pending-fixes/15-RESEARCH.md
@templates/pages/admin/tags.templ
@templates/pages/admin/correspondents.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tags edit button using templ.JSFuncCall</name>
  <files>templates/pages/admin/tags.templ</files>
  <action>
    1. Remove the broken script block (lines 328-330):
       ```
       script editTagOnClick(tag sqlc.ListTagsWithCountsRow) {
           openEditMode(tag.ID, tag.Name, tag.Color || 'blue');
       }
       ```

    2. Find the edit button in TagCard template (around line 337-350) that uses `onclick="editTagOnClick(...)"`

    3. Replace the onclick attribute to use templ.JSFuncCall instead:
       ```go
       Attributes: templ.Attributes{
           "onclick": templ.JSFuncCall("openEditMode",
               tag.ID.String(),
               tag.Name,
               safeColor(tag.Color)),
           "title": "Edit tag",
       },
       ```

    4. The `safeColor` helper already exists at lines 306-311 - reuse it.

    Note: templ.JSFuncCall properly JSON-encodes each argument individually, avoiding the JSON casing and UUID serialization issues.
  </action>
  <verify>
    - Run `make generate` to regenerate templ code
    - Check `./tmp/air-combined.log` for compilation errors
    - Verify no remaining `script editTagOnClick` in tags.templ: `grep "script editTagOnClick" templates/pages/admin/tags.templ`
    - Verify JSFuncCall is used: `grep "JSFuncCall.*openEditMode" templates/pages/admin/tags.templ`
  </verify>
  <done>Tags edit button uses templ.JSFuncCall with properly formatted arguments (string UUID, string name, string color)</done>
</task>

<task type="auto">
  <name>Task 2: Fix correspondents edit button using templ.JSFuncCall</name>
  <files>templates/pages/admin/correspondents.templ</files>
  <action>
    1. Remove the broken script block (lines 491-493):
       ```
       script editCorrespondentOnClick(correspondent sqlc.ListCorrespondentsWithCountsRow) {
           openEditMode(correspondent.ID, correspondent.Name, correspondent.Notes || '');
       }
       ```

    2. Add a helper function to safely handle nullable Notes field:
       ```go
       func safeNotes(notes *string) string {
           if notes == nil {
               return ""
           }
           return *notes
       }
       ```

    3. Find the edit button in CorrespondentCard template that uses `onclick="editCorrespondentOnClick(...)"`

    4. Replace the onclick attribute to use templ.JSFuncCall:
       ```go
       Attributes: templ.Attributes{
           "onclick": templ.JSFuncCall("openEditMode",
               correspondent.ID.String(),
               correspondent.Name,
               safeNotes(correspondent.Notes)),
           "title": "Edit correspondent",
       },
       ```
  </action>
  <verify>
    - Run `make generate` to regenerate templ code
    - Check `./tmp/air-combined.log` for compilation errors
    - Verify no remaining `script editCorrespondentOnClick` in correspondents.templ: `grep "script editCorrespondentOnClick" templates/pages/admin/correspondents.templ`
    - Verify JSFuncCall is used: `grep "JSFuncCall.*openEditMode" templates/pages/admin/correspondents.templ`
  </verify>
  <done>Correspondents edit button uses templ.JSFuncCall with properly formatted arguments (string UUID, string name, string notes)</done>
</task>

</tasks>

<verification>
1. Check build logs: `cat ./tmp/air-combined.log` - no errors
2. Verify code changes:
   - `grep -c "script edit.*OnClick" templates/pages/admin/tags.templ` returns 0
   - `grep -c "script edit.*OnClick" templates/pages/admin/correspondents.templ` returns 0
   - `grep -c "JSFuncCall.*openEditMode" templates/pages/admin/tags.templ` returns 1
   - `grep -c "JSFuncCall.*openEditMode" templates/pages/admin/correspondents.templ` returns 1
3. Run tests: `make test`
</verification>

<success_criteria>
- Both edit buttons use templ.JSFuncCall instead of script blocks
- Application compiles without errors
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-pending-fixes/15-01-SUMMARY.md`
</output>
