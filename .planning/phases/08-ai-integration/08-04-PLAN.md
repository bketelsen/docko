---
phase: 08-ai-integration
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - internal/handler/ai.go
  - templates/pages/admin/ai_settings.templ
  - templates/layouts/admin.templ
autonomous: true

must_haves:
  truths:
    - "Admin can view and configure AI settings"
    - "Admin can select preferred AI provider"
    - "Admin can set max pages for cost control"
    - "Admin can toggle auto-processing"
    - "UI shows which providers are available"
  artifacts:
    - path: "internal/handler/ai.go"
      provides: "AI settings handler endpoints"
      exports: ["AISettingsPage", "UpdateAISettings"]
    - path: "templates/pages/admin/ai_settings.templ"
      provides: "AI settings page template"
      contains: "AISettings"
  key_links:
    - from: "internal/handler/ai.go"
      to: "internal/ai/service.go"
      via: "Service methods"
      pattern: "aiSvc.GetSettings"
    - from: "templates/layouts/admin.templ"
      to: "/ai"
      via: "navigation link"
      pattern: "href=\"/ai\""
---

<objective>
Create AI settings page for provider configuration and cost controls.

Purpose: Admin needs to configure which AI provider to use, set the max pages limit for cost control, and toggle auto-processing. The settings page shows available providers and current usage stats.
Output: AI settings handler and template with full configuration UI.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-integration/08-CONTEXT.md
@.planning/phases/08-ai-integration/08-03-SUMMARY.md
@internal/handler/handler.go
@templates/pages/admin/inboxes.templ
@templates/layouts/admin.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI settings handler</name>
  <files>internal/handler/ai.go</files>
  <action>
Create handler for AI settings:

```go
package handler

import (
    "net/http"
    "strconv"

    "github.com/labstack/echo/v4"

    "docko/internal/database/sqlc"
    "docko/templates/pages/admin"
)

// AISettingsPage renders the AI configuration page
func (h *Handler) AISettingsPage(c echo.Context) error {
    ctx := c.Request().Context()

    // Get current settings
    settings, err := h.aiSvc.GetSettings(ctx)
    if err != nil {
        return echo.NewHTTPError(http.StatusInternalServerError, "failed to get ai settings")
    }

    // Get available providers
    providers := h.aiSvc.AvailableProviders()

    // Get usage stats
    stats, err := h.aiSvc.GetUsageStats(ctx)
    if err != nil {
        // Non-fatal - show page without stats
        stats = &ai.UsageStats{}
    }

    // Get pending suggestion count
    pendingCount, err := h.db.Queries.CountPendingSuggestions(ctx)
    if err != nil {
        pendingCount = 0
    }

    return admin.AISettings(settings, providers, stats, pendingCount).Render(ctx, c.Response().Writer)
}

// UpdateAISettings handles AI settings form submission
func (h *Handler) UpdateAISettings(c echo.Context) error {
    ctx := c.Request().Context()

    // Parse form values
    preferredProvider := c.FormValue("preferred_provider")
    maxPagesStr := c.FormValue("max_pages")
    autoProcess := c.FormValue("auto_process") == "on"
    autoApplyThresholdStr := c.FormValue("auto_apply_threshold")
    reviewThresholdStr := c.FormValue("review_threshold")

    // Parse numeric values
    maxPages, err := strconv.Atoi(maxPagesStr)
    if err != nil || maxPages < 1 || maxPages > 50 {
        maxPages = 5
    }

    autoApplyThreshold, err := strconv.ParseFloat(autoApplyThresholdStr, 64)
    if err != nil || autoApplyThreshold < 0 || autoApplyThreshold > 1 {
        autoApplyThreshold = 0.85
    }

    reviewThreshold, err := strconv.ParseFloat(reviewThresholdStr, 64)
    if err != nil || reviewThreshold < 0 || reviewThreshold > 1 {
        reviewThreshold = 0.50
    }

    // Prepare preferred provider
    var preferred *string
    if preferredProvider != "" && preferredProvider != "auto" {
        preferred = &preferredProvider
    }

    // Update settings
    _, err = h.aiSvc.UpdateSettings(ctx, sqlc.UpdateAISettingsParams{
        PreferredProvider:  preferred,
        MaxPages:           int32(maxPages),
        AutoProcess:        autoProcess,
        AutoApplyThreshold: numericFromFloat(autoApplyThreshold),
        ReviewThreshold:    numericFromFloat(reviewThreshold),
    })
    if err != nil {
        c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "Failed to update settings", "type": "error"}}`)
        return c.NoContent(http.StatusInternalServerError)
    }

    c.Response().Header().Set("HX-Trigger", `{"showToast": {"message": "AI settings updated", "type": "success"}}`)
    return c.Redirect(http.StatusSeeOther, "/ai")
}

// numericFromFloat converts float64 to pgtype.Numeric
func numericFromFloat(f float64) pgtype.Numeric {
    // Use string conversion for precision
    str := strconv.FormatFloat(f, 'f', 2, 64)
    var n pgtype.Numeric
    n.Scan(str)
    return n
}
```

Also add import for pgtype and ai packages.
  </action>
  <verify>Check ./tmp/air-combined.log for compilation errors</verify>
  <done>AI settings handler compiles with get and update endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create AI settings template</name>
  <files>templates/pages/admin/ai_settings.templ</files>
  <action>
Create the AI settings page template:

```templ
package admin

import (
    "fmt"
    "strconv"

    "docko/internal/ai"
    "docko/internal/database/sqlc"
    "docko/internal/meta"
    "docko/templates/layouts"
)

templ AISettings(settings *sqlc.AiSetting, providers []string, stats *ai.UsageStats, pendingCount int64) {
    @layouts.Admin(meta.New("AI Settings", "Configure AI integration")) {
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">AI Settings</h1>
                if pendingCount > 0 {
                    <a href="/ai/review" class="inline-flex items-center px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Review Suggestions ({ strconv.FormatInt(pendingCount, 10) })
                    </a>
                }
            </div>

            <!-- Provider Status -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Provider Status</h2>
                <div class="grid grid-cols-3 gap-4">
                    @providerCard("OpenAI", "openai", providers)
                    @providerCard("Anthropic", "anthropic", providers)
                    @providerCard("Ollama", "ollama", providers)
                </div>
                <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                    Configure providers via environment variables: OPENAI_API_KEY, ANTHROPIC_API_KEY, OLLAMA_HOST
                </p>
            </div>

            <!-- Settings Form -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Configuration</h2>
                <form hx-post="/ai" hx-swap="none" class="space-y-6">
                    <!-- Preferred Provider -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Preferred Provider
                        </label>
                        <select name="preferred_provider" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100">
                            <option value="auto" selected?={ settings.PreferredProvider == nil }>Auto (use first available)</option>
                            for _, p := range providers {
                                <option value={ p } selected?={ settings.PreferredProvider != nil && *settings.PreferredProvider == p }>
                                    { providerDisplayName(p) }
                                </option>
                            }
                        </select>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Select which provider to use first. Falls back to others if unavailable.
                        </p>
                    </div>

                    <!-- Max Pages -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Max Pages to Analyze
                        </label>
                        <input type="number" name="max_pages" min="1" max="50"
                               value={ strconv.Itoa(int(settings.MaxPages)) }
                               class="w-32 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" />
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Only analyze the first N pages of each document. Lower values reduce costs.
                        </p>
                    </div>

                    <!-- Auto-Apply Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Auto-Apply Threshold
                        </label>
                        <input type="number" name="auto_apply_threshold" min="0" max="1" step="0.05"
                               value={ formatThreshold(settings.AutoApplyThreshold) }
                               class="w-32 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" />
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Suggestions with confidence at or above this threshold are applied automatically.
                        </p>
                    </div>

                    <!-- Review Threshold -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Review Threshold
                        </label>
                        <input type="number" name="review_threshold" min="0" max="1" step="0.05"
                               value={ formatThreshold(settings.ReviewThreshold) }
                               class="w-32 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100" />
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Suggestions below this threshold are discarded. Between this and auto-apply go to review queue.
                        </p>
                    </div>

                    <!-- Auto Process Toggle -->
                    <div class="flex items-center">
                        <input type="checkbox" name="auto_process" id="auto_process"
                               checked?={ settings.AutoProcess }
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                        <label for="auto_process" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            Auto-process new documents
                        </label>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 -mt-4 ml-6">
                        When enabled, documents are automatically analyzed after text extraction.
                    </p>

                    <div class="pt-4">
                        <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Save Settings
                        </button>
                    </div>
                </form>
            </div>

            <!-- Usage Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Usage Statistics</h2>
                <div class="grid grid-cols-3 gap-6">
                    <div>
                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            { strconv.FormatInt(stats.DocumentsProcessed, 10) }
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Documents Processed</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            { formatTokens(stats.TotalInputTokens) }
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Input Tokens</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">
                            { formatTokens(stats.TotalOutputTokens) }
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Output Tokens</p>
                    </div>
                </div>
                <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                    Estimated cost depends on provider pricing. Check provider dashboard for accurate billing.
                </p>
            </div>
        </div>
    }
}

templ providerCard(name, id string, available []string) {
    <div class={ "p-4 rounded-lg border", providerCardClass(id, available) }>
        <div class="flex items-center justify-between">
            <span class="font-medium text-gray-900 dark:text-gray-100">{ name }</span>
            if isProviderAvailable(id, available) {
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                    Available
                </span>
            } else {
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400">
                    Not Configured
                </span>
            }
        </div>
    </div>
}

func isProviderAvailable(id string, available []string) bool {
    for _, p := range available {
        if p == id {
            return true
        }
    }
    return false
}

func providerCardClass(id string, available []string) string {
    if isProviderAvailable(id, available) {
        return "border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20"
    }
    return "border-gray-200 dark:border-gray-700"
}

func providerDisplayName(id string) string {
    switch id {
    case "openai":
        return "OpenAI"
    case "anthropic":
        return "Anthropic"
    case "ollama":
        return "Ollama"
    default:
        return id
    }
}

func formatThreshold(n pgtype.Numeric) string {
    f, _ := n.Float64Value()
    return fmt.Sprintf("%.2f", f.Float64)
}

func formatTokens(n int64) string {
    if n >= 1000000 {
        return fmt.Sprintf("%.1fM", float64(n)/1000000)
    }
    if n >= 1000 {
        return fmt.Sprintf("%.1fK", float64(n)/1000)
    }
    return strconv.FormatInt(n, 10)
}
```

Add necessary import for pgtype.
  </action>
  <verify>Run `make generate` and check ./tmp/air-combined.log for templ errors</verify>
  <done>AI settings template compiles with provider status, config form, and usage stats</done>
</task>

<task type="auto">
  <name>Task 3: Add AI to navigation and register routes</name>
  <files>templates/layouts/admin.templ, internal/handler/handler.go</files>
  <action>
1. Update templates/layouts/admin.templ to add AI link in navigation:

Add after the Network Sources link:
```templ
<a href="/ai" class={ navLinkClass("/ai", currentPath) }>
    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
    </svg>
    AI
</a>
```

2. Update internal/handler/handler.go:

Add aiSvc to Handler struct:
```go
type Handler struct {
    // ... existing fields
    aiSvc *ai.Service
}
```

Update New function signature to include aiSvc.

Add routes in RegisterRoutes:
```go
// AI routes (protected)
e.GET("/ai", h.AISettingsPage, middleware.RequireAuth(h.auth))
e.POST("/ai", h.UpdateAISettings, middleware.RequireAuth(h.auth))
```
  </action>
  <verify>Check ./tmp/air-combined.log for compilation errors and verify AI nav link appears</verify>
  <done>AI settings accessible from navigation, routes registered</done>
</task>

</tasks>

<verification>
1. Settings page renders: GET /ai shows AI settings form
2. Provider status shows: Available providers marked green
3. Settings update: POST /ai saves settings to database
4. Navigation works: AI link appears in sidebar
5. Usage stats display: Token counts shown
</verification>

<success_criteria>
- AI settings page accessible at /ai
- Provider status shows which are configured
- Settings form saves preferred provider, max pages, thresholds
- Auto-process toggle works
- Usage statistics displayed
- Navigation includes AI link
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-integration/08-04-SUMMARY.md`
</output>
