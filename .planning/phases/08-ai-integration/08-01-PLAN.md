---
phase: 08-ai-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/database/migrations/009_ai_integration.sql
  - sqlc/queries/ai.sql
autonomous: true

must_haves:
  truths:
    - "AI settings persist across restarts"
    - "AI suggestions can be stored with confidence scores and status"
    - "AI usage statistics are tracked per request"
  artifacts:
    - path: "internal/database/migrations/009_ai_integration.sql"
      provides: "AI settings, suggestions, and usage tables"
      contains: "CREATE TABLE ai_settings"
    - path: "sqlc/queries/ai.sql"
      provides: "CRUD operations for AI configuration and suggestions"
      exports: ["GetAISettings", "UpdateAISettings", "CreateAISuggestion", "ListPendingSuggestions"]
  key_links:
    - from: "sqlc/queries/ai.sql"
      to: "documents"
      via: "foreign key on ai_suggestions.document_id"
      pattern: "REFERENCES documents"
---

<objective>
Create database schema for AI integration: settings, suggestions, and usage tracking.

Purpose: AI integration needs persistent storage for global settings (provider preference, max pages, auto-process toggle), per-document suggestions with confidence scores and status, and usage statistics for cost tracking.
Output: Migration file and sqlc queries ready for use by AI service.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-integration/08-CONTEXT.md
@.planning/phases/08-ai-integration/08-RESEARCH.md
@internal/database/migrations/008_network_sources.sql
@internal/database/sqlc/models.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI integration database schema</name>
  <files>internal/database/migrations/009_ai_integration.sql</files>
  <action>
Create migration file with:

1. Create enum for suggestion status: `CREATE TYPE suggestion_status AS ENUM ('pending', 'accepted', 'rejected', 'auto_applied')`

2. Create enum for suggestion type: `CREATE TYPE suggestion_type AS ENUM ('tag', 'correspondent')`

3. Create `ai_settings` table (singleton row for global settings):
   - id INTEGER PRIMARY KEY DEFAULT 1 CHECK (id = 1) -- enforce single row
   - preferred_provider VARCHAR(50) -- 'openai', 'anthropic', 'ollama', or null for auto
   - max_pages INTEGER NOT NULL DEFAULT 5 -- cost control
   - auto_process BOOLEAN NOT NULL DEFAULT false -- global toggle
   - auto_apply_threshold DECIMAL(3,2) NOT NULL DEFAULT 0.85 -- >= this auto-applies
   - review_threshold DECIMAL(3,2) NOT NULL DEFAULT 0.50 -- >= this shows for review
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

4. Create `ai_suggestions` table:
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE
   - job_id UUID REFERENCES jobs(id) ON DELETE SET NULL
   - suggestion_type suggestion_type NOT NULL
   - value VARCHAR(255) NOT NULL -- tag name or correspondent name
   - confidence DECIMAL(3,2) NOT NULL -- 0.00 to 1.00
   - reasoning TEXT -- brief explanation from AI
   - is_new BOOLEAN NOT NULL DEFAULT false -- true if not in existing taxonomy
   - status suggestion_status NOT NULL DEFAULT 'pending'
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - resolved_at TIMESTAMPTZ
   - resolved_by VARCHAR(50) -- 'auto' or 'user'

5. Create `ai_usage` table (track each AI request for cost monitoring):
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE
   - job_id UUID REFERENCES jobs(id) ON DELETE SET NULL
   - provider VARCHAR(50) NOT NULL -- 'openai', 'anthropic', 'ollama'
   - model VARCHAR(100) NOT NULL
   - input_tokens INTEGER NOT NULL
   - output_tokens INTEGER NOT NULL
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

6. Create indexes:
   - `CREATE INDEX idx_ai_suggestions_document ON ai_suggestions (document_id)`
   - `CREATE INDEX idx_ai_suggestions_status ON ai_suggestions (status) WHERE status = 'pending'`
   - `CREATE INDEX idx_ai_usage_created ON ai_usage (created_at DESC)`

7. Insert default settings row:
   - `INSERT INTO ai_settings (id) VALUES (1)`

Include +goose Down section to drop tables and enums in reverse order.
  </action>
  <verify>Check ./tmp/air-combined.log for migration errors after save</verify>
  <done>Migration file exists and applies cleanly on startup</done>
</task>

<task type="auto">
  <name>Task 2: Create sqlc queries for AI integration</name>
  <files>sqlc/queries/ai.sql</files>
  <action>
Create sqlc query file with these operations:

```sql
-- AI Settings (singleton)

-- name: GetAISettings :one
SELECT * FROM ai_settings WHERE id = 1;

-- name: UpdateAISettings :one
UPDATE ai_settings SET
    preferred_provider = $1,
    max_pages = $2,
    auto_process = $3,
    auto_apply_threshold = $4,
    review_threshold = $5,
    updated_at = NOW()
WHERE id = 1
RETURNING *;

-- AI Suggestions

-- name: CreateAISuggestion :one
INSERT INTO ai_suggestions (
    document_id, job_id, suggestion_type, value, confidence, reasoning, is_new, status, resolved_at, resolved_by
) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
RETURNING *;

-- name: GetAISuggestion :one
SELECT * FROM ai_suggestions WHERE id = $1;

-- name: ListDocumentSuggestions :many
SELECT * FROM ai_suggestions
WHERE document_id = $1
ORDER BY confidence DESC, created_at DESC;

-- name: ListPendingSuggestions :many
SELECT s.*, d.original_filename
FROM ai_suggestions s
JOIN documents d ON s.document_id = d.id
WHERE s.status = 'pending'
ORDER BY s.created_at DESC
LIMIT $1 OFFSET $2;

-- name: CountPendingSuggestions :one
SELECT COUNT(*) FROM ai_suggestions WHERE status = 'pending';

-- name: ListPendingSuggestionsForDocument :many
SELECT * FROM ai_suggestions
WHERE document_id = $1 AND status = 'pending'
ORDER BY confidence DESC
LIMIT 5;

-- name: AcceptSuggestion :one
UPDATE ai_suggestions SET
    status = 'accepted',
    resolved_at = NOW(),
    resolved_by = 'user'
WHERE id = $1
RETURNING *;

-- name: RejectSuggestion :one
UPDATE ai_suggestions SET
    status = 'rejected',
    resolved_at = NOW(),
    resolved_by = 'user'
WHERE id = $1
RETURNING *;

-- name: AutoApplySuggestion :one
UPDATE ai_suggestions SET
    status = 'auto_applied',
    resolved_at = NOW(),
    resolved_by = 'auto'
WHERE id = $1
RETURNING *;

-- name: DeleteDocumentSuggestions :exec
DELETE FROM ai_suggestions WHERE document_id = $1;

-- AI Usage tracking

-- name: CreateAIUsage :one
INSERT INTO ai_usage (document_id, job_id, provider, model, input_tokens, output_tokens)
VALUES ($1, $2, $3, $4, $5, $6)
RETURNING *;

-- name: GetAIUsageStats :one
SELECT
    COUNT(*) as documents_processed,
    COALESCE(SUM(input_tokens), 0) as total_input_tokens,
    COALESCE(SUM(output_tokens), 0) as total_output_tokens
FROM ai_usage;

-- name: GetAIUsageStatsByProvider :many
SELECT
    provider,
    COUNT(*) as request_count,
    COALESCE(SUM(input_tokens), 0) as total_input_tokens,
    COALESCE(SUM(output_tokens), 0) as total_output_tokens
FROM ai_usage
GROUP BY provider
ORDER BY request_count DESC;

-- name: GetRecentAIUsage :many
SELECT * FROM ai_usage
ORDER BY created_at DESC
LIMIT $1;
```

Follow the pattern from other query files for consistency.
  </action>
  <verify>Run `make generate` and check ./tmp/air-combined.log for sqlc errors</verify>
  <done>sqlc generates Go code in internal/database/sqlc/ without errors</done>
</task>

</tasks>

<verification>
1. Migration applies: Server starts without migration errors in ./tmp/air-combined.log
2. Sqlc generates: `make generate` produces Go types in internal/database/sqlc/
3. Verify new types exist: Check for AiSettings, AiSuggestion, AiUsage structs
4. Default settings row: ai_settings table has row with id=1
</verification>

<success_criteria>
- ai_settings table exists with global AI configuration
- ai_suggestions table exists with confidence scores and status workflow
- ai_usage table exists for cost tracking
- sqlc generates all CRUD operations
- All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-integration/08-01-SUMMARY.md`
</output>
