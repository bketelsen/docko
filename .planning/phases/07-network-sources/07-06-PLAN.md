---
phase: 07-network-sources
plan: 06
type: execute
wave: 4
depends_on: ["07-04", "07-05"]
files_modified:
  - cmd/server/main.go
  - templates/layouts/admin.templ
autonomous: false

must_haves:
  truths:
    - "Network service starts on application startup"
    - "Network sources page accessible from admin navigation"
    - "All components wired together and functional"
  artifacts:
    - path: "cmd/server/main.go"
      provides: "Network service initialization"
      contains: "network.New"
  key_links:
    - from: "cmd/server/main.go"
      to: "internal/network/service.go"
      via: "New and Start calls"
      pattern: "networkSvc\\.Start"
---

<objective>
Wire network service into application and add navigation.

Purpose: The network service must start on application startup, and users need navigation to access the Network Sources page. This plan integrates all the network source components.
Output: Fully functional network sources feature accessible from the admin UI.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-network-sources/07-04-SUMMARY.md
@.planning/phases/07-network-sources/07-05-SUMMARY.md
@cmd/server/main.go
@templates/layouts/admin.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire network service in main.go</name>
  <files>cmd/server/main.go</files>
  <action>
Update main.go to initialize and start the network service:

1. Add import:
```go
import (
    // ... existing imports ...
    "docko/internal/network"
)
```

2. After creating docSvc, create network service:
```go
// Create network service
networkSvc := network.New(db, docSvc, cfg)
```

3. After creating handler (update the New call to include networkSvc):
```go
h := handler.New(cfg, db, authService, docSvc, inboxSvc, networkSvc, q, broadcaster)
```

4. After starting inbox service, start network service:
```go
// Start network service
if err := networkSvc.Start(ctx); err != nil {
    slog.Error("failed to start network service", "error", err)
    os.Exit(1)
}
```

5. In the shutdown section (where inboxSvc.Stop is called), add:
```go
if err := networkSvc.Stop(); err != nil {
    slog.Error("failed to stop network service", "error", err)
}
```

The network service must be created after docSvc (dependency) and before handler (needs it for routes).
  </action>
  <verify>Check ./tmp/air-combined.log for compilation and startup errors</verify>
  <done>Server starts with network service running</done>
</task>

<task type="auto">
  <name>Task 2: Add navigation link to admin layout</name>
  <files>templates/layouts/admin.templ</files>
  <action>
Add "Network Sources" link to the admin navigation, after the Inboxes link:

Find the navigation section in admin.templ and add a new link:

```templ
<!-- After the Inboxes link -->
<a href="/network-sources" class={ navLinkClass("/network-sources", currentPath) }>
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
    </svg>
    Network Sources
</a>
```

Use the server/network icon (two horizontal lines with dots) to distinguish from the folder icon used for Inboxes.

Place it logically after Inboxes since both are document source configuration pages.
  </action>
  <verify>Run `make generate` and verify template compiles</verify>
  <done>Navigation link visible in admin sidebar</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete network sources feature with SMB/NFS support</what-built>
  <how-to-verify>
1. Start the server: `make dev`
2. Log in to admin dashboard
3. Navigate to Network Sources (new link in sidebar)
4. Verify the page loads with empty state message
5. Try adding a test network source:
   - Select SMB protocol
   - Enter any host/share (it will fail to connect, that's OK)
   - Verify form submits and source appears in list
6. Click "Test Connection" - should show error (expected without real server)
7. Toggle enabled/disabled
8. Delete the test source
9. Check logs for any errors: `tail -f ./tmp/air-combined.log`
  </how-to-verify>
  <resume-signal>Type "approved" if the UI works as expected, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Server starts: `make dev` succeeds without errors
2. Navigation: "Network Sources" link appears in admin sidebar
3. Page loads: /network-sources shows the management UI
4. CRUD works: Can create, toggle, delete sources
5. No console errors in browser dev tools
</verification>

<success_criteria>
- Network service initializes and starts on application startup
- Network service stops gracefully on shutdown
- Admin navigation includes "Network Sources" link
- Network Sources page is accessible and functional
- All HTMX interactions work (create, toggle, delete, events)
</success_criteria>

<output>
After completion, create `.planning/phases/07-network-sources/07-06-SUMMARY.md`
</output>
