---
phase: 07-network-sources
plan: 05
type: execute
wave: 4
depends_on: ["07-01", "07-04"]
files_modified:
  - internal/handler/network_sources.go
  - internal/handler/handler.go
  - templates/pages/admin/network_sources.templ
autonomous: true

must_haves:
  truths:
    - "Admin can add SMB network source with credentials"
    - "Admin can add NFS network source"
    - "Admin can test connection before saving"
    - "Admin can enable/disable sources"
    - "Admin can trigger manual sync"
    - "Admin can see sync status and recent events"
  artifacts:
    - path: "internal/handler/network_sources.go"
      provides: "HTTP handlers for network source management"
      exports: ["NetworkSourcesPage", "CreateNetworkSource", "TestConnection", "SyncNetworkSource"]
    - path: "templates/pages/admin/network_sources.templ"
      provides: "Network sources management UI"
      contains: "templ NetworkSources"
  key_links:
    - from: "internal/handler/network_sources.go"
      to: "internal/network/service.go"
      via: "networkSvc field"
      pattern: "h\\.networkSvc"
    - from: "internal/handler/handler.go"
      to: "/network-sources"
      via: "route registration"
      pattern: "GET.*network-sources"
---

<objective>
Create HTTP handlers and UI for network source management.

Purpose: Admins need a web interface to configure network sources, test connections, and monitor sync status. This extends the existing Inbox management pattern to the Network Sources section.
Output: Handler endpoints and templ templates for the Network Sources page.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-network-sources/07-CONTEXT.md
@.planning/phases/07-network-sources/07-04-SUMMARY.md
@internal/handler/inboxes.go
@internal/handler/handler.go
@templates/pages/admin/inboxes.templ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network sources handler</name>
  <files>internal/handler/network_sources.go</files>
  <action>
Create handler following the inboxes.go pattern:

```go
package handler

import (
    "fmt"
    "log/slog"
    "net/http"
    "strconv"

    "docko/internal/database/sqlc"
    "docko/templates/pages/admin"

    "github.com/google/uuid"
    "github.com/labstack/echo/v4"
)

// NetworkSourcesPage renders the network sources management page
func (h *Handler) NetworkSourcesPage(c echo.Context) error {
    ctx := c.Request().Context()

    sources, err := h.db.Queries.ListNetworkSources(ctx)
    if err != nil {
        slog.Error("failed to list network sources", "error", err)
        return c.String(http.StatusInternalServerError, "Failed to load network sources")
    }

    return admin.NetworkSources(sources).Render(ctx, c.Response().Writer)
}

// CreateNetworkSource creates a new network source
func (h *Handler) CreateNetworkSource(c echo.Context) error {
    ctx := c.Request().Context()

    // Parse form values
    name := c.FormValue("name")
    protocol := c.FormValue("protocol")
    host := c.FormValue("host")
    sharePath := c.FormValue("share_path")
    username := c.FormValue("username")
    password := c.FormValue("password")
    continuousSync := c.FormValue("continuous_sync") == "true"
    postImportAction := c.FormValue("post_import_action")
    moveSubfolder := c.FormValue("move_subfolder")
    duplicateAction := c.FormValue("duplicate_action")
    batchSizeStr := c.FormValue("batch_size")

    // Validate required fields
    if name == "" || host == "" || sharePath == "" {
        return c.String(http.StatusBadRequest, "Name, host, and share path are required")
    }

    // Parse protocol
    var proto sqlc.NetworkProtocol
    switch protocol {
    case "smb":
        proto = sqlc.NetworkProtocolSmb
    case "nfs":
        proto = sqlc.NetworkProtocolNfs
    default:
        return c.String(http.StatusBadRequest, "Invalid protocol")
    }

    // Parse post-import action
    var postAction sqlc.PostImportAction
    switch postImportAction {
    case "delete":
        postAction = sqlc.PostImportActionDelete
    case "move":
        postAction = sqlc.PostImportActionMove
    default:
        postAction = sqlc.PostImportActionLeave
    }

    // Parse duplicate action
    var dupAction sqlc.DuplicateAction
    switch duplicateAction {
    case "rename":
        dupAction = sqlc.DuplicateActionRename
    case "skip":
        dupAction = sqlc.DuplicateActionSkip
    default:
        dupAction = sqlc.DuplicateActionDelete
    }

    // Parse batch size
    batchSize := int32(100)
    if batchSizeStr != "" {
        if bs, err := strconv.Atoi(batchSizeStr); err == nil && bs > 0 {
            batchSize = int32(bs)
        }
    }

    // Encrypt password if provided
    var passwordEncrypted *string
    if password != "" {
        encrypted, err := h.networkSvc.GetCrypto().Encrypt(password)
        if err != nil {
            slog.Error("failed to encrypt password", "error", err)
            return c.String(http.StatusInternalServerError, "Failed to encrypt credentials")
        }
        passwordEncrypted = &encrypted
    }

    // Set optional fields
    var usernamePtr *string
    if username != "" {
        usernamePtr = &username
    }
    var moveSubfolderPtr *string
    if moveSubfolder != "" {
        moveSubfolderPtr = &moveSubfolder
    }

    // Create in database (disabled by default until tested)
    source, err := h.db.Queries.CreateNetworkSource(ctx, sqlc.CreateNetworkSourceParams{
        Name:              name,
        Protocol:          proto,
        Host:              host,
        SharePath:         sharePath,
        Username:          usernamePtr,
        PasswordEncrypted: passwordEncrypted,
        Enabled:           false, // Require test connection first
        ContinuousSync:    continuousSync,
        PostImportAction:  postAction,
        MoveSubfolder:     moveSubfolderPtr,
        DuplicateAction:   dupAction,
        BatchSize:         batchSize,
    })
    if err != nil {
        slog.Error("failed to create network source", "error", err)
        return c.String(http.StatusInternalServerError, "Failed to create network source")
    }

    // Return the new source card for HTMX
    return admin.NetworkSourceCard(source).Render(ctx, c.Response().Writer)
}

// TestNetworkSourceConnection tests connectivity to a network source
func (h *Handler) TestNetworkSourceConnection(c echo.Context) error {
    ctx := c.Request().Context()

    id, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return c.String(http.StatusBadRequest, "Invalid source ID")
    }

    source, err := h.db.Queries.GetNetworkSource(ctx, id)
    if err != nil {
        return c.String(http.StatusNotFound, "Source not found")
    }

    if err := h.networkSvc.TestConnection(ctx, &source); err != nil {
        return c.String(http.StatusBadRequest, fmt.Sprintf("Connection failed: %v", err))
    }

    return c.String(http.StatusOK, "Connection successful")
}

// ToggleNetworkSource enables/disables a network source
func (h *Handler) ToggleNetworkSource(c echo.Context) error {
    ctx := c.Request().Context()

    id, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return c.String(http.StatusBadRequest, "Invalid source ID")
    }

    source, err := h.db.Queries.GetNetworkSource(ctx, id)
    if err != nil {
        return c.String(http.StatusNotFound, "Source not found")
    }

    // Toggle enabled state
    newEnabled := !source.Enabled

    // Update in database
    updated, err := h.db.Queries.UpdateNetworkSource(ctx, sqlc.UpdateNetworkSourceParams{
        ID:                source.ID,
        Name:              source.Name,
        Protocol:          source.Protocol,
        Host:              source.Host,
        SharePath:         source.SharePath,
        Username:          source.Username,
        PasswordEncrypted: source.PasswordEncrypted,
        Enabled:           newEnabled,
        ContinuousSync:    source.ContinuousSync,
        PostImportAction:  source.PostImportAction,
        MoveSubfolder:     source.MoveSubfolder,
        DuplicateAction:   source.DuplicateAction,
        BatchSize:         source.BatchSize,
    })
    if err != nil {
        slog.Error("failed to toggle network source", "error", err)
        return c.String(http.StatusInternalServerError, "Failed to toggle source")
    }

    // Return updated card
    return admin.NetworkSourceCard(updated).Render(ctx, c.Response().Writer)
}

// SyncNetworkSource triggers a manual sync for a source
func (h *Handler) SyncNetworkSource(c echo.Context) error {
    ctx := c.Request().Context()

    id, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return c.String(http.StatusBadRequest, "Invalid source ID")
    }

    imported, err := h.networkSvc.SyncSource(ctx, id)
    if err != nil {
        return c.String(http.StatusInternalServerError, fmt.Sprintf("Sync failed: %v", err))
    }

    return c.String(http.StatusOK, fmt.Sprintf("Imported %d files", imported))
}

// SyncAllNetworkSources triggers sync for all enabled sources
func (h *Handler) SyncAllNetworkSources(c echo.Context) error {
    ctx := c.Request().Context()

    if err := h.networkSvc.SyncAll(ctx); err != nil {
        return c.String(http.StatusInternalServerError, fmt.Sprintf("Sync failed: %v", err))
    }

    return c.String(http.StatusOK, "Sync complete")
}

// DeleteNetworkSource removes a network source
func (h *Handler) DeleteNetworkSource(c echo.Context) error {
    ctx := c.Request().Context()

    id, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return c.String(http.StatusBadRequest, "Invalid source ID")
    }

    if err := h.db.Queries.DeleteNetworkSource(ctx, id); err != nil {
        slog.Error("failed to delete network source", "error", err)
        return c.String(http.StatusInternalServerError, "Failed to delete source")
    }

    // Return empty response for HTMX to remove the element
    return c.String(http.StatusOK, "")
}

// NetworkSourceEvents returns recent events for a source
func (h *Handler) NetworkSourceEvents(c echo.Context) error {
    ctx := c.Request().Context()

    id, err := uuid.Parse(c.Param("id"))
    if err != nil {
        return c.String(http.StatusBadRequest, "Invalid source ID")
    }

    events, err := h.db.Queries.ListNetworkSourceEvents(ctx, sqlc.ListNetworkSourceEventsParams{
        SourceID: id,
        Limit:    10,
    })
    if err != nil {
        slog.Error("failed to list events", "error", err)
        return c.String(http.StatusInternalServerError, "Failed to load events")
    }

    return admin.NetworkSourceEventsList(events).Render(ctx, c.Response().Writer)
}
```

This follows the inbox handler pattern exactly, with additions for:
- Test connection endpoint
- Sync endpoint (single and all)
- Password encryption on create
  </action>
  <verify>Check ./tmp/air-combined.log for compilation errors</verify>
  <done>Handler compiles with all CRUD and sync endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Update handler struct and routes</name>
  <files>internal/handler/handler.go</files>
  <action>
Update the Handler struct to include networkSvc and register routes:

1. Add to Handler struct:
```go
type Handler struct {
    cfg         *config.Config
    db          *database.DB
    auth        *auth.Service
    docSvc      *document.Service
    inboxSvc    *inbox.Service
    networkSvc  *network.Service  // ADD THIS
    queue       *queue.Queue
    broadcaster *processing.StatusBroadcaster
}
```

2. Update New function:
```go
func New(cfg *config.Config, db *database.DB, authService *auth.Service, docSvc *document.Service, inboxSvc *inbox.Service, networkSvc *network.Service, q *queue.Queue, broadcaster *processing.StatusBroadcaster) *Handler {
    return &Handler{
        cfg:         cfg,
        db:          db,
        auth:        authService,
        docSvc:      docSvc,
        inboxSvc:    inboxSvc,
        networkSvc:  networkSvc,
        queue:       q,
        broadcaster: broadcaster,
    }
}
```

3. Add import for network package:
```go
import (
    // ... existing imports ...
    "docko/internal/network"
)
```

4. Add routes in RegisterRoutes (after inbox routes):
```go
    // Network sources management routes (protected)
    e.GET("/network-sources", h.NetworkSourcesPage, middleware.RequireAuth(h.auth))
    e.POST("/network-sources", h.CreateNetworkSource, middleware.RequireAuth(h.auth))
    e.DELETE("/network-sources/:id", h.DeleteNetworkSource, middleware.RequireAuth(h.auth))
    e.POST("/network-sources/:id/toggle", h.ToggleNetworkSource, middleware.RequireAuth(h.auth))
    e.POST("/network-sources/:id/test", h.TestNetworkSourceConnection, middleware.RequireAuth(h.auth))
    e.POST("/network-sources/:id/sync", h.SyncNetworkSource, middleware.RequireAuth(h.auth))
    e.POST("/network-sources/sync-all", h.SyncAllNetworkSources, middleware.RequireAuth(h.auth))
    e.GET("/network-sources/:id/events", h.NetworkSourceEvents, middleware.RequireAuth(h.auth))
```
  </action>
  <verify>Check ./tmp/air-combined.log - will fail until main.go is updated (expected)</verify>
  <done>Handler struct updated with networkSvc and routes registered</done>
</task>

<task type="auto">
  <name>Task 3: Create network sources template</name>
  <files>templates/pages/admin/network_sources.templ</files>
  <action>
Create the template following the inboxes.templ pattern:

```templ
package admin

import (
    "fmt"
    "time"

    "docko/internal/database/sqlc"
    "docko/internal/meta"
    "docko/templates/layouts"
)

templ NetworkSources(sources []sqlc.NetworkSource) {
    @layouts.Admin(meta.New("Network Sources", "Configure network shares for automatic document import")) {
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Network Sources</h1>
                    <p class="text-muted-foreground">Configure SMB and NFS shares to automatically import PDF documents.</p>
                </div>
                if len(sources) > 0 {
                    <button
                        hx-post="/network-sources/sync-all"
                        hx-swap="none"
                        class="px-4 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/80 transition-colors"
                    >
                        Sync All
                    </button>
                }
            </div>
        </div>

        <!-- Add Network Source Form -->
        <div class="border border-border rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Add Network Source</h2>
            <form
                hx-post="/network-sources"
                hx-target="#source-list"
                hx-swap="beforeend"
                hx-on::after-request="if(event.detail.successful) this.reset()"
                class="grid gap-4 md:grid-cols-2"
            >
                <div>
                    <label for="name" class="block text-sm font-medium mb-1">Name</label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        placeholder="Office Share"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div>
                    <label for="protocol" class="block text-sm font-medium mb-1">Protocol</label>
                    <select
                        id="protocol"
                        name="protocol"
                        onchange="toggleCredentials(this)"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    >
                        <option value="smb">SMB (Windows/Samba)</option>
                        <option value="nfs">NFS</option>
                    </select>
                </div>
                <div>
                    <label for="host" class="block text-sm font-medium mb-1">Host</label>
                    <input
                        type="text"
                        id="host"
                        name="host"
                        required
                        placeholder="192.168.1.100 or server.local"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div>
                    <label for="share_path" class="block text-sm font-medium mb-1">Share/Export Path</label>
                    <input
                        type="text"
                        id="share_path"
                        name="share_path"
                        required
                        placeholder="Documents (SMB) or /exports/docs (NFS)"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div id="smb-credentials">
                    <label for="username" class="block text-sm font-medium mb-1">Username (SMB only)</label>
                    <input
                        type="text"
                        id="username"
                        name="username"
                        placeholder="domain\\user or user"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div id="smb-password">
                    <label for="password" class="block text-sm font-medium mb-1">Password (SMB only)</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        placeholder="Enter password"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div>
                    <label for="post_import_action" class="block text-sm font-medium mb-1">After Import</label>
                    <select
                        id="post_import_action"
                        name="post_import_action"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    >
                        <option value="leave">Leave in place</option>
                        <option value="delete">Delete from source</option>
                        <option value="move">Move to subfolder</option>
                    </select>
                </div>
                <div>
                    <label for="duplicate_action" class="block text-sm font-medium mb-1">Duplicate Handling</label>
                    <select
                        id="duplicate_action"
                        name="duplicate_action"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    >
                        <option value="delete">Skip (don't import)</option>
                        <option value="rename">Import with new name</option>
                        <option value="skip">Skip (leave on source)</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <input
                        type="checkbox"
                        id="continuous_sync"
                        name="continuous_sync"
                        value="true"
                        checked
                        class="rounded border-input"
                    />
                    <label for="continuous_sync" class="text-sm font-medium">Continuous sync (every 5 minutes)</label>
                </div>
                <div>
                    <label for="batch_size" class="block text-sm font-medium mb-1">Batch Size</label>
                    <input
                        type="number"
                        id="batch_size"
                        name="batch_size"
                        value="100"
                        min="1"
                        max="1000"
                        class="w-full px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                    />
                </div>
                <div class="md:col-span-2">
                    <button
                        type="submit"
                        class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
                    >
                        Add Network Source
                    </button>
                </div>
            </form>
        </div>

        <!-- Source List -->
        <div id="source-list" class="space-y-4">
            if len(sources) == 0 {
                <div class="text-center py-12 text-muted-foreground">
                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                    </svg>
                    <p>No network sources configured yet.</p>
                    <p class="text-sm">Add a network source above to start importing documents.</p>
                </div>
            } else {
                for _, source := range sources {
                    @NetworkSourceCard(source)
                }
            }
        </div>

        <script>
        function toggleCredentials(select) {
            const isSmb = select.value === 'smb';
            document.getElementById('smb-credentials').style.display = isSmb ? 'block' : 'none';
            document.getElementById('smb-password').style.display = isSmb ? 'block' : 'none';
        }
        </script>
    }
}

templ NetworkSourceCard(source sqlc.NetworkSource) {
    <div class="network-source-card border border-border rounded-lg p-6" id={ fmt.Sprintf("source-%s", source.ID.String()) }>
        <div class="flex items-start justify-between mb-4">
            <div class="flex items-center gap-3">
                <!-- Status indicator -->
                if source.Enabled && source.ConnectionState != nil && *source.ConnectionState == "connected" {
                    <div class="w-3 h-3 rounded-full bg-green-500" title="Connected"></div>
                } else if source.ConnectionState != nil && *source.ConnectionState == "error" {
                    <div class="w-3 h-3 rounded-full bg-red-500" title="Error"></div>
                } else {
                    <div class="w-3 h-3 rounded-full bg-gray-400" title="Unknown"></div>
                }
                <div>
                    <h3 class="font-semibold flex items-center gap-2">
                        { source.Name }
                        <span class="text-xs px-2 py-0.5 rounded bg-secondary text-secondary-foreground uppercase">
                            { string(source.Protocol) }
                        </span>
                    </h3>
                    <p class="text-sm text-muted-foreground font-mono">{ source.Host }/{ source.SharePath }</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Test connection button -->
                <button
                    hx-post={ fmt.Sprintf("/network-sources/%s/test", source.ID.String()) }
                    hx-swap="none"
                    hx-indicator={ fmt.Sprintf("#test-spinner-%s", source.ID.String()) }
                    class="p-2 text-muted-foreground hover:text-foreground transition-colors"
                    title="Test connection"
                >
                    <svg id={ fmt.Sprintf("test-spinner-%s", source.ID.String()) } class="w-4 h-4 htmx-indicator animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <svg class="w-4 h-4 htmx-indicator-hide" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                <!-- Sync now button -->
                <button
                    hx-post={ fmt.Sprintf("/network-sources/%s/sync", source.ID.String()) }
                    hx-swap="none"
                    class="p-2 text-muted-foreground hover:text-foreground transition-colors"
                    title="Sync now"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                </button>
                <!-- Toggle switch -->
                <button
                    hx-post={ fmt.Sprintf("/network-sources/%s/toggle", source.ID.String()) }
                    hx-target={ fmt.Sprintf("#source-%s", source.ID.String()) }
                    hx-swap="outerHTML"
                    class={ "relative inline-flex h-6 w-11 items-center rounded-full transition-colors",
                        templ.KV("bg-primary", source.Enabled),
                        templ.KV("bg-gray-300 dark:bg-gray-600", !source.Enabled) }
                    title={ networkSourceToggleTitle(source.Enabled) }
                >
                    <span
                        class={ "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                            templ.KV("translate-x-6", source.Enabled),
                            templ.KV("translate-x-1", !source.Enabled) }
                    ></span>
                </button>
                <!-- Delete button -->
                <button
                    hx-delete={ fmt.Sprintf("/network-sources/%s", source.ID.String()) }
                    hx-target={ fmt.Sprintf("#source-%s", source.ID.String()) }
                    hx-swap="outerHTML"
                    hx-confirm="Delete this network source? This will not affect files on the source."
                    class="p-2 text-muted-foreground hover:text-destructive transition-colors"
                    title="Delete source"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Info row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
            <div>
                <span class="text-muted-foreground">Status:</span>
                <span class={ templ.KV("text-green-600 dark:text-green-400", source.Enabled), templ.KV("text-gray-500", !source.Enabled) }>
                    if source.Enabled {
                        Active
                    } else {
                        Disabled
                    }
                </span>
            </div>
            <div>
                <span class="text-muted-foreground">Sync:</span>
                <span>
                    if source.ContinuousSync {
                        Continuous
                    } else {
                        Manual
                    }
                </span>
            </div>
            <div>
                <span class="text-muted-foreground">Imported:</span>
                <span>{ fmt.Sprintf("%d files", source.FilesImported) }</span>
            </div>
            <div>
                <span class="text-muted-foreground">Last sync:</span>
                <span>
                    if source.LastSyncAt.Valid {
                        { networkSourceRelativeTime(source.LastSyncAt.Time) }
                    } else {
                        Never
                    }
                </span>
            </div>
        </div>

        <!-- Error message if present -->
        if source.LastError != nil && *source.LastError != "" {
            <div class="p-3 bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800 rounded-md text-sm text-red-700 dark:text-red-300 mb-4">
                <strong>Last error:</strong> { *source.LastError }
                if source.ConsecutiveFailures >= 5 {
                    <span class="ml-2 text-xs">(auto-disabled after { fmt.Sprintf("%d", source.ConsecutiveFailures) } failures)</span>
                }
            </div>
        }

        <!-- Recent events section (expandable) -->
        <details class="group">
            <summary class="cursor-pointer text-sm text-muted-foreground hover:text-foreground flex items-center gap-1">
                <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                Recent events
            </summary>
            <div
                class="mt-3 pt-3 border-t border-border"
                hx-get={ fmt.Sprintf("/network-sources/%s/events", source.ID.String()) }
                hx-trigger="toggle from:closest details"
                hx-swap="innerHTML"
            >
                <div class="text-sm text-muted-foreground">Loading events...</div>
            </div>
        </details>
    </div>
}

templ NetworkSourceEventsList(events []sqlc.NetworkSourceEvent) {
    if len(events) == 0 {
        <div class="text-sm text-muted-foreground">No events recorded yet.</div>
    } else {
        <div class="space-y-2">
            for _, event := range events {
                <div class="flex items-center justify-between text-sm py-1">
                    <div class="flex items-center gap-2">
                        @networkSourceEventIcon(event.Action)
                        <span class="font-mono text-xs truncate max-w-xs">{ event.Filename }</span>
                    </div>
                    <div class="flex items-center gap-2 text-muted-foreground">
                        <span>{ networkSourceEventActionLabel(event.Action) }</span>
                        <span>{ networkSourceRelativeTime(event.CreatedAt) }</span>
                    </div>
                </div>
            }
        </div>
    }
}

templ networkSourceEventIcon(action string) {
    switch action {
        case "imported":
            <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        case "duplicate":
            <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
        case "error":
            <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        default:
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
    }
}

func networkSourceToggleTitle(enabled bool) string {
    if enabled {
        return "Click to disable"
    }
    return "Click to enable"
}

func networkSourceEventActionLabel(action string) string {
    switch action {
    case "imported":
        return "Imported"
    case "duplicate":
        return "Duplicate"
    case "error":
        return "Error"
    case "skipped":
        return "Skipped"
    default:
        return action
    }
}

func networkSourceRelativeTime(t time.Time) string {
    now := time.Now()
    diff := now.Sub(t)

    switch {
    case diff < time.Minute:
        return "just now"
    case diff < time.Hour:
        mins := int(diff.Minutes())
        if mins == 1 {
            return "1 minute ago"
        }
        return fmt.Sprintf("%d minutes ago", mins)
    case diff < 24*time.Hour:
        hours := int(diff.Hours())
        if hours == 1 {
            return "1 hour ago"
        }
        return fmt.Sprintf("%d hours ago", hours)
    case diff < 7*24*time.Hour:
        days := int(diff.Hours() / 24)
        if days == 1 {
            return "1 day ago"
        }
        return fmt.Sprintf("%d days ago", days)
    default:
        return t.Format("Jan 2, 2006")
    }
}
```

This template mirrors the inbox template structure exactly, with additions for:
- Protocol selection (SMB/NFS)
- Conditional credential fields
- Test connection button
- Sync now button
- Continuous sync checkbox
  </action>
  <verify>Run `make generate` and check ./tmp/air-combined.log for templ errors</verify>
  <done>Network sources template generates without errors</done>
</task>

</tasks>

<verification>
1. Handler compiles: Check ./tmp/air-combined.log
2. Routes registered: `/network-sources` and related endpoints
3. Template generates: `make generate` succeeds
4. UI accessible: After main.go update, page loads at /network-sources
</verification>

<success_criteria>
- NetworkSourcesPage renders list of sources
- CreateNetworkSource creates source with encrypted password
- TestNetworkSourceConnection validates connectivity
- ToggleNetworkSource enables/disables sources
- SyncNetworkSource triggers manual sync
- DeleteNetworkSource removes source
- UI matches inbox management pattern
</success_criteria>

<output>
After completion, create `.planning/phases/07-network-sources/07-05-SUMMARY.md`
</output>
