---
phase: 06-search
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - templates/pages/admin/documents.templ
autonomous: false

must_haves:
  truths:
    - "User can type in search input and see results update"
    - "User can select filters from dropdowns"
    - "User can remove individual filters via chips"
    - "Search results update without full page reload"
    - "URL updates with search parameters (shareable)"
  artifacts:
    - path: "templates/pages/admin/documents.templ"
      provides: "Search form with input, filter dropdowns, HTMX wiring"
      contains: "hx-get"
  key_links:
    - from: "templates/pages/admin/documents.templ"
      to: "/documents"
      via: "HTMX form submission"
      pattern: "hx-trigger.*input.*delay"
---

<objective>
Add the search UI to the Documents page with search input, filter dropdowns, and HTMX live search.

Purpose: Enable users to search and filter documents with instant feedback.
Output: Updated Documents template with search bar, tag/correspondent/date filters, and HTMX-powered live search.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-search/06-CONTEXT.md
@.planning/phases/06-search/06-RESEARCH.md
@.planning/phases/06-search/06-01-SUMMARY.md
@.planning/phases/06-search/06-02-SUMMARY.md
@templates/pages/admin/documents.templ
@internal/handler/documents.go
@internal/handler/tags.go
@internal/handler/correspondents.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Documents template with search UI</name>
  <files>templates/pages/admin/documents.templ</files>
  <action>
Refactor the Documents template to include:
1. Search input with clear button and loading indicator
2. Filter dropdowns inline (correspondent, date range)
3. Tag multi-select (reuse existing tag picker pattern)
4. HTMX form that triggers on input change with 500ms debounce
5. Results area with id="document-results" for HTMX swapping
6. URL state via hx-push-url

Create a new DocumentsWithSearch function that accepts search state:

```templ
package admin

import (
    "fmt"
    "docko/internal/database/sqlc"
    "docko/internal/meta"
    "docko/templates/layouts"
    "docko/templates/partials"
    "github.com/google/uuid"
)

// DocumentTagsMap maps document ID to tags
type DocumentTagsMap map[uuid.UUID][]sqlc.Tag

// DocumentCorrespondentMap maps document ID to correspondent name
type DocumentCorrespondentMap map[uuid.UUID]string

// DocumentsWithSearch renders the document list with search functionality
templ DocumentsWithSearch(results []partials.SearchResult, docTags DocumentTagsMap, docCorrespondents DocumentCorrespondentMap, params partials.SearchParams, totalCount int, activeFilters []partials.ActiveFilter, allTags []sqlc.Tag, allCorrespondents []sqlc.Correspondent) {
    @layouts.Admin(meta.New("Documents", "Search and manage your documents")) {
        <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-2xl font-bold">Documents</h1>
                    <p class="text-muted-foreground">Search and filter your document library.</p>
                </div>
                <a href="/upload" class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Upload
                </a>
            </div>

            // Search form with HTMX
            <form id="search-form"
                  hx-get="/documents"
                  hx-trigger="input changed delay:500ms from:find input[name='q'], change from:find select, submit"
                  hx-target="#document-results"
                  hx-push-url="true"
                  hx-indicator="#search-indicator"
                  class="space-y-4">

                // Search input row
                <div class="flex gap-4">
                    // Search input with clear button
                    <div class="relative flex-1">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input
                            type="search"
                            name="q"
                            value={ params.Query }
                            placeholder="Search documents..."
                            class="w-full pl-10 pr-10 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring"
                        />
                        // Loading indicator
                        <span id="search-indicator" class="htmx-indicator absolute right-3 top-1/2 -translate-y-1/2">
                            <svg class="animate-spin w-4 h-4 text-muted-foreground" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </div>

                    // Correspondent filter dropdown
                    <select
                        name="correspondent"
                        class="px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring min-w-[180px]"
                    >
                        <option value="">All correspondents</option>
                        for _, corr := range allCorrespondents {
                            <option value={ corr.ID.String() } selected?={ params.CorrespondentID == corr.ID.String() }>
                                { corr.Name }
                            </option>
                        }
                    </select>

                    // Date range filter dropdown
                    <select
                        name="date"
                        class="px-3 py-2 border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring min-w-[140px]"
                    >
                        <option value="">Any time</option>
                        <option value="today" selected?={ params.DateRange == "today" }>Today</option>
                        <option value="7d" selected?={ params.DateRange == "7d" }>Last 7 days</option>
                        <option value="30d" selected?={ params.DateRange == "30d" }>Last 30 days</option>
                        <option value="1y" selected?={ params.DateRange == "1y" }>Last year</option>
                    </select>
                </div>

                // Tag filter row (multi-select)
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-sm text-muted-foreground">Tags:</span>
                    for _, tag := range allTags {
                        {{
                            isSelected := false
                            for _, selectedID := range params.TagIDs {
                                if selectedID == tag.ID.String() {
                                    isSelected = true
                                    break
                                }
                            }
                        }}
                        <label class={ "inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm cursor-pointer transition-colors",
                                       templ.KV("bg-primary text-primary-foreground", isSelected),
                                       templ.KV("bg-muted hover:bg-muted/80", !isSelected) }>
                            <input
                                type="checkbox"
                                name="tag"
                                value={ tag.ID.String() }
                                checked?={ isSelected }
                                class="sr-only"
                            />
                            if tag.Color != nil {
                                <span class="w-2 h-2 rounded-full" style={ fmt.Sprintf("background-color: %s", *tag.Color) }></span>
                            }
                            { tag.Name }
                        </label>
                    }
                    if len(allTags) == 0 {
                        <span class="text-sm text-muted-foreground italic">No tags created yet</span>
                    }
                </div>
            </form>
        </div>

        // Results area (swapped by HTMX)
        <div id="document-results" hx-ext="sse" sse-connect="/api/processing/status" sse-close="close">
            @partials.SearchResults(results, docTags, docCorrespondents, params, totalCount, activeFilters)
        </div>
    }
}

// Documents renders the document list page (backwards compatibility - redirects to search)
// Keep for any existing links, but prefer DocumentsWithSearch
templ Documents(docs []sqlc.Document, docTags DocumentTagsMap, docCorrespondents DocumentCorrespondentMap) {
    // Convert to SearchResults format for backwards compatibility
    {{
        results := make([]partials.SearchResult, len(docs))
        for i, doc := range docs {
            results[i] = partials.SearchResult{
                Document: doc,
            }
        }
        params := partials.SearchParams{Page: 1, PerPage: 50}
    }}
    @DocumentsWithSearch(results, docTags, docCorrespondents, params, len(docs), nil, nil, nil)
}
```

Key features:
- `hx-trigger="input changed delay:500ms"` - Debounced instant search
- `hx-push-url="true"` - Updates URL for shareability
- `hx-indicator` - Shows spinner during search
- Tag checkboxes toggle on/off for AND filtering
- SSE connection maintained for processing status updates

Add CSS for htmx-indicator in the templ file or ensure existing styles support `.htmx-indicator`.
  </action>
  <verify>Run `make dev` and check `./tmp/air-combined.log` for successful templ generation.</verify>
  <done>Documents template includes search form with input, correspondent dropdown, date dropdown, and tag checkboxes</done>
</task>

<task type="auto">
  <name>Task 2: Update handler to fetch filter options</name>
  <files>internal/handler/documents.go</files>
  <action>
Update the DocumentsPage handler to fetch tags and correspondents for the filter dropdowns.

Add to the handler before rendering DocumentsWithSearch:

```go
// Fetch all tags for filter dropdown
allTags, err := h.db.Queries.ListTagsWithCounts(ctx)
if err != nil {
    allTags = []sqlc.ListTagsWithCountsRow{} // Non-fatal
}

// Convert to Tag slice (ListTagsWithCounts returns rows with extra count field)
tags := make([]sqlc.Tag, len(allTags))
for i, t := range allTags {
    tags[i] = sqlc.Tag{
        ID:        t.ID,
        Name:      t.Name,
        Color:     t.Color,
        CreatedAt: t.CreatedAt,
    }
}

// Fetch all correspondents for filter dropdown
allCorrespondents, err := h.db.Queries.ListCorrespondentsWithCounts(ctx)
if err != nil {
    allCorrespondents = []sqlc.ListCorrespondentsWithCountsRow{} // Non-fatal
}

// Convert to Correspondent slice
correspondents := make([]sqlc.Correspondent, len(allCorrespondents))
for i, c := range allCorrespondents {
    correspondents[i] = sqlc.Correspondent{
        ID:        c.ID,
        Name:      c.Name,
        Notes:     c.Notes,
        CreatedAt: c.CreatedAt,
    }
}
```

Then update the DocumentsWithSearch call to pass these:

```go
return admin.DocumentsWithSearch(
    results,
    docTags,
    docCorrespondents,
    templateParams,
    int(total),
    activeFilters,
    tags,
    correspondents,
).Render(ctx, c.Response().Writer)
```

For HTMX partial requests, we don't need to fetch tags/correspondents since only SearchResults is returned.
  </action>
  <verify>Run `make dev` and check `./tmp/air-combined.log` for successful compilation. Visit `/documents` and verify dropdowns are populated.</verify>
  <done>Handler fetches all tags and correspondents for filter dropdowns, passes to template</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full-text search on Documents page with filters for tags, correspondent, and date range</what-built>
  <how-to-verify>
1. Visit http://localhost:3000/documents
2. Verify search input, correspondent dropdown, date dropdown, and tag filters are visible
3. Type in search box - results should update after ~500ms (no page reload)
4. Check URL updates with search params (e.g., ?q=test)
5. Select a correspondent from dropdown - results filter, URL updates
6. Select date range - results filter
7. Click a tag checkbox - results filter (AND logic with other tags)
8. Verify filter chips appear showing active filters
9. Click X on a filter chip - that filter is removed
10. Copy URL and paste in new tab - same search results should appear
11. Click "Clear all" if multiple filters - returns to unfiltered state
12. Search for term that matches document content - verify headline snippet shows with highlighted text
13. Search for something with no results - verify helpful empty state message
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the search functionality</resume-signal>
</task>

</tasks>

<verification>
1. Search form renders with all filter controls
2. Typing in search triggers debounced HTMX request
3. URL updates with search parameters
4. Filter dropdowns populated with tags and correspondents
5. Tag checkboxes toggle and filter results
6. Filter chips display and can be removed
7. Empty search shows all documents
8. No results shows helpful message with clear filters option
9. Pagination works with search params preserved
</verification>

<success_criteria>
- User can search by typing in search box (instant, debounced)
- User can filter by correspondent dropdown
- User can filter by date range dropdown
- User can filter by multiple tags (AND logic)
- Active filters shown as removable chips
- URL reflects search state (shareable)
- Search results show headline snippets with highlighted matches
- Empty states are helpful and actionable
- SSE status updates still work for processing documents
</success_criteria>

<output>
After completion, create `.planning/phases/06-search/06-03-SUMMARY.md`
</output>
